% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{lmodern}
\usepackage{amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
  \usepackage{amssymb}
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Analysing Flights with R - UNDER CONSTRUCTION},
  pdfauthor={David Marsh},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\ifluatex
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{apalike}

\title{Analysing Flights with R - UNDER CONSTRUCTION}
\author{David Marsh}
\date{2021-03-06}

\begin{document}
\maketitle

{
\setcounter{tocdepth}{1}
\tableofcontents
}
\hypertarget{howto}{%
\chapter{How to use this book}\label{howto}}

-- UNDER CONSTRUCTION! ---

\hypertarget{before-you-start}{%
\section{Before you start}\label{before-you-start}}

You need to have RStudio and R installed on your machine. These are available from IT Support as standard installations, or if you want to work on your own machine, both are open source: \href{https://cran.r-project.org}{R download here} and \href{https://rstudio.com/products/rstudio/download/}{RStudio download here}.

We assume that you are familiar with air traffic data, so won't spend time explaining the concepts.

This book is available as \href{https://david6marsh.github.io/flights_in_R/}{html here} and can be downloaded complete with data from here (TBD).

If you're working through the book as training, then it will help to install (TBD - training bundle)

If you want a more speedy introduction, then Enrico Spinielli has covered the \href{https://github.com/euctrl-pru/portal/wiki/Intro-to-everything}{important steps here.}. Sebastien Thonnard and others have compiled an (internal) \href{https://ost.eurocontrol.int/sites/STATFO/WikiPages/R_documentation.aspx}{wiki on the intranet}.

There are also several useful `cheat sheets' see (TBD)

\hypertarget{ways-to-use-the-material}{%
\section{Ways to Use the Material}\label{ways-to-use-the-material}}

The book aims to support you using it in a number of different ways:

\begin{itemize}
\tightlist
\item
  Training. Work through chapters in order, or pick out specific chapters if you need a refresher on a topic. Read the explanations, grab the code and run it, and test your understanding by answering questions {[}in square brackets in the text{]} and doing exercises.
\item
  Reference. Use the book search to find some how-to material directly.
\item
  Snippets. The book builds up snippets of usable code (TBD - how complete?) for you to cut-and-paste.
\end{itemize}

But it is never going to replace the huge amount of excellent information, especially in \href{https://stackoverflow.com/}{stackoverflow}. A key principle is that \emph{``Google is your friend''}: even if I prefer \href{https://www.duckduckgo.com}{DuckDuckGo} for many purposes, a google search is often more productive for R. Whether it's for how to do something, or how to respond to an error, usually someone has already suffered, and some kind person has answered. Google it.

\hypertarget{structure-of-the-book}{%
\section{Structure of the book}\label{structure-of-the-book}}

\begin{itemize}
\tightlist
\item
  Chapters 1 and 2 should get you up and running in RStudio.
\item
  Chapters 3 to 5 start with how to look at data, using a data viewer and with some initial graphs. If you're mostly using existing code that creates simple charts, written by someone else, then these chapters should help you find your way around, and start to adapt the code for your own needs.
\item
  Chapters \ldots{} (TBD)
\end{itemize}

\hypertarget{whats-gone-wrong}{%
\section{What's gone wrong?}\label{whats-gone-wrong}}

Learning from mistakes is essential, so each chapter has a ``what's gone wrong?'' section near the end, discussing some typical potholes that we all fall into from time to time. Look there especially if you don't see the results from the code in the book that you were expecting.

We start the book with one classic pitfall: R is \emph{case sensitive}, which can be quite a culture shock if you're brought up on other systems. This matters for filenames as well as code. When in doubt, check the case of what you've typed!

\hypertarget{start}{%
\chapter{Getting started}\label{start}}

We said in chapter \ref{howto} that you need first to install R and RStudio. These are separate pieces of software: R does all the statistical and graphics stuff, while RStudio provides the graphical user interface. In this chapter we get up and running in RStudio, and see some very basic R code.

\hypertarget{rstudio}{%
\section{Orientation in RStudio}\label{rstudio}}

Here we take a brief look around the RStudio interface. Use `RStudio/Help' to get more detailed help.

The RStudio interface can be customised almost beyond recognition. We'll use a mix of styles in the book so that you don't get too fixed, but it's probably helpful to your colleagues not to re-order the main four panes, otherwise they'll find looking over your shoulder or screen-sharing a disorienting experience.

A basic MS Windows RStudio, with work on the go, looks something like this.

\begin{figure}
\centering
\includegraphics{images/RStudio.png}
\caption{RStudio snapshot}
\end{figure}

The main panes of the screen are:

\begin{itemize}
\tightlist
\item
  Top left: source code, shown as a number of tabs one for each file;
\item
  Bottom left: the `console', which is a scratchpad for entering code, and where log output is usually shown (and some other tabs which we don't need here);
\item
  Top right: the `environment' and `history' tabs are of main interest. Environment is where you can explore all the data you've created. History is useful for re-doing something, particularly as you can search for code.
\item
  Bottom right: This has several important tabs

  \begin{itemize}
  \tightlist
  \item
    Files: for exploring files within a project, can be quicker than using the windows explorer
  \item
    Plots: is where plots will appear (usually)
  \item
    Packages: is for checking which packages are installed, or active (see section \ref{packages})
  \item
    Help: all the details of the functions that you will need - this is usually quicker to use than googling a function (though the help files also come up when you google, from various providers around the web).
  \end{itemize}
\end{itemize}

The buttons that appear around the panes are context-sensitive: they will change according to the type of file that you have open.

There are some hot-keys for moving rapidly around the panes: most often, I use ctrl-1 to go to the source code, ctrl-2 for the console. You can then guess the others, or find them by trial and error.

Recent versions of \texttt{RStudio} have a tutorial (tab in top right pane) if you need more detail.

Try out the console (bottom left, ctrl-2). Try typing \texttt{3\ +\ 4\ *\ 2} there (and press `enter'). You should see ``{[}1{]} 11'', meaning that the first ``{[}1{]}'' (and in this case only) element of your answer is 11. The spaces in that calculation are optional, but recommended for ease of reading. {[}Try it without the spaces.{]}

If you'd like to see an answer with more than one element, type \texttt{letters} into the console. This is a built-in constant. Check the `help' for `letters' to see some others.

\hypertarget{first-project}{%
\section{First project}\label{first-project}}

The console is good for quick, throw-away calculations. But it's a bit like treating R as a pocket calculator. Instead, we want to save R code in files.

While you can work with `bare' files of R code, we think it's tidier to use `projects', for two main reasons:

\begin{itemize}
\tightlist
\item
  you can keep several shorter files of code together, which makes it easier to organise and navigate;
\item
  and a project automatically remembers which directory it's working in, so you can manage data input and output and graphic output more neatly.
\end{itemize}

Create yourself a new project `File/New Project', selecting the options new project, give it the name `justlearning' and browse to put it in your personal R directory. (TBD templates). The sequence should look a little like this, with variation coming from where you create the new project subdirectory. That final part depends on your system and filing habits.
\includegraphics{images/new project 1.png}
\includegraphics{images/new project 2.png}
\includegraphics{images/new project 3.png}

The project will open without a code panel, because you have no code yet. It looks like this.
\includegraphics{images/NewJustLearning.png}

In this book we'll assume that projects always keep data in the \texttt{data} directory, and save graphs to the \texttt{graphs} directory. You can create these quickly in your new project by copying the code from here (quick-copy icon appears top right in the code block when you move the mouse over it) and pasting it into the console (and press `enter').

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# good to have these in every project}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"data"}\NormalTok{)}
\FunctionTok{dir.create}\NormalTok{(}\StringTok{"graphs"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

If for some reason the directories already exist, don't worry, you'll just get a warning. The line beginning with `\#' is a comment which is ignored.

You can also create these directories manually using `New Folder' in the files tab (ctrl-5), but then make sure both folder names are in lower case! You could even use your operating system file explorer - these are just ordinary directories (`folders').

When you quit RStudio it will save any data and open files in your project. So you can re-open and continue from where you left off. If you've opened very large files, just beware that saving a copy as you close can take some time. (see TBD)

\hypertarget{first-code}{%
\section{First code}\label{first-code}}

Now you've got a blank project, add a new blank R script using \texttt{File/New\ File/R\ Script}, or the `file plus' icon top left. It appears in the source code pane, top left.

Immediately save it; call it `chapter2' for example. The name isn't critical here, but avoid spaces and punctuation. By default, it will be saved to the top level in the project. This is fine for many projects, though in some cases we might choose to organise code differently.

Type this code into your new `chapter2' script, either manually or copy paste.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{3} \SpecialCharTok{+} \DecValTok{4}
\CommentTok{\# I know pi}
\NormalTok{pi}
\DecValTok{1}\SpecialCharTok{:}\DecValTok{50}
\FunctionTok{cos}\NormalTok{(pi}\SpecialCharTok{/}\DecValTok{3}\NormalTok{) }\CommentTok{\# angle is in radians}
\end{Highlighting}
\end{Shaded}

Unlike in the console, in a script file code doesn't get executed as you type. You have to run it. Usually you're either:

\begin{itemize}
\tightlist
\item
  stepping through code, running a bit at a time, in which case ctrl-enter (cmd-enter on the Mac) is easy to use: it runs the code where the cursor currently sits most of the time intelligently selecting other lines that need to run at the same time, and then moves to the next line of code, jumping over comments that are preceded by \texttt{\#};
\item
  running all of the code, which you can do by pressing the `source' button (or select all and ctrl-enter).
\end{itemize}

The output appears in the console as a running log. It should look like this:
\includegraphics{images/result of 3 plus 4.png}

\hypertarget{packages}{%
\section{First packages}\label{packages}}

A `package' provides a collection of functions, often some data and sometimes some new data types. If you're starting in R, and just aiming to find your way around in and use code, then mostly what you need to know is how to load packages (and what that means), and a little about the more common ones. That's what we cover in this section.

\hypertarget{package-basics}{%
\subsection{Package basics}\label{package-basics}}

Some packages are already bundled in the basic installation of `R', such as \texttt{base} which provides, as the name suggests, many of the most basic functions. But there are thousands of other packages, coming from:

\begin{itemize}
\tightlist
\item
  \href{https://cran.r-project.org}{CRAN}, the ``Comprehensive R Archive Network'' is the authoritative collection of packages. There are also various `mirror' (official copy) sites hosted elsewhere, such as at Ghent University. Packages in CRAN have been through a degree of quality control, and are preferred to the less official sources.
\item
  \href{https://github.com}{Github} and other public repositories. We share some there, such as \href{https://github.com/david6marsh/codaTaxi}{CODA taxi times} and the \href{https://github.com/euctrl-pru/portal}{PRC dashboard}.
\item
  Home-made. Making them is out of the scope of the book, but you may want to load the \texttt{statfor} package (see section TBD) created by Sebastien Thonnard that builds some access to Eurocontrol datawarehouses as well as nice formatting.
\end{itemize}

There are two\footnote{actually, there's a third, but that's too much detail for here} steps to using a package, and sometimes these get confused:

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  Installation. You type \texttt{install.packages("package\_name")} and R finds the files for that package and saves them on your machine or on a network drive. So the files are available. You've done the shopping and the food is in the kitchen cupboards.
\item
  Attaching or Loading. You have to make a package \emph{available} for use for your session, usually with \texttt{library(\ )}. You've pulled the ingredients for your recipe out of the cupboard and they're on the kitchen table. If there's a difference between `attaching' and `loading' then it doesn't matter here.
\end{enumerate}

A very few packages are automatically loaded at the start of the session. In the packages pane, a package is listed if it is installed and ticked if it's loaded. In the screenshot, just the \texttt{base} package is loaded of the ones listed in this screenshot.

\includegraphics{images/packages.png}

Clicking on the package name takes you to the documentation. There's a manual for all functions together, as a pdf, but it's usually easier to use the help pane to get the same material, and perhaps copy examples from the end of each help entry. More importantly here there are links to \textbf{vignettes}, and often now to websites with more info. Vignettes are not little stickers, but essential how-to guides mixing text and code. Often this can provide a skeleton end-to-end structure showing how to use functions, and that you can copy and adapt to your own need.

You can load a package by ticking the box in the packages pane, but normally it's done in code, as in this example.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(lubridate) }\CommentTok{\# lots of date{-}related functions.}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Attaching package: 'lubridate'
\end{verbatim}

\begin{verbatim}
## The following objects are masked from 'package:base':
## 
##     date, intersect, setdiff, union
\end{verbatim}

Two packages can define a function with the same name. The CRAN repository of packages performs quality checks, but overlap between packages is not something CRAN controls: it is an excellent library rather than an `Académie française' for R controlling what is acceptable in the language. When there is overlap in packages, both defining a function with the same name, say, then on loading the second one `masks' the first (you might see this above). Sometimes, as an alternative to loading the full package, you might see in code a `two colon' usage, such as \texttt{base::union}. This is very common inside packages (it's recommended), and it's a way to insist that the first package version of the function should be used.

As well as function with the same name and different results, there are often many different functions that you could use to achieve the same result, eg \texttt{base::paste0()} and \texttt{stringr::str\_c()} both concatenate strings.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# both concatenate two strings, inserting no separator between them}
\NormalTok{base}\SpecialCharTok{::}\FunctionTok{paste0}\NormalTok{(}\StringTok{"On Ilkley Moo"}\NormalTok{, }\StringTok{"r."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "On Ilkley Moor."
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stringr}\SpecialCharTok{::}\FunctionTok{str\_c}\NormalTok{(}\StringTok{"On Ilkley Moo"}\NormalTok{, }\StringTok{"r."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "On Ilkley Moor."
\end{verbatim}

In this example, notice that the strings to be concatenated are written in quotes. It's recommended to use double ", rather than single `. And while we're on such conventions, the space after the',' in the parameter list is optional, but recommended for ease of reading. In fact you'll see that when there are lots of parameters or long ones, we tend to move to a new line, also for ease of reading. Meanwhile, there should be no space between the function name and the `('.

There's an art in R to doing the most with the minimum number of packages, since it takes time to find your way around the functions in a package. That's like the satisfaction of making the recipe from things you already have in the cupboard.

But sometimes, you just don't want to make the flaky pastry yourself. There are times when you're looking at a complex task and should be thinking `surely someone has already tackled this in R?'. A little googling might find you most of the pieces already in place in a new package, or one you have but had forgotten about.

You develop a personal `dialect' of R, from the packages you choose to use most often. We'll discuss one of the most common dialects, the \texttt{tidyverse}, in more detail in the next section. Since it helps if you and colleagues share a dialect, everyone adopting the tidyverse is a good start.

\hypertarget{tidyverse}{%
\subsection{Tidyverse}\label{tidyverse}}

The \href{https://www.tidyverse.org}{tidyverse} is our chosen dialect, in the sense that in most cases we'll use the functions and data structures, and way of organising, that go with this collection of packages. There's a lot of excellent documentation already available, so we will explain some basics here, and introduce other elements as we need them for flight data examples.

The \emph{tidy} in `tidyverse' refers to a \href{https://r4ds.had.co.nz/tidy-data.html}{tidy data structure}: a table with each variable in its own column and each observation on one row. While we often find flight data with years displayed across the table, and countries down the side, this is not `tidy'.

\begin{table}

\caption{\label{tab:twotables}An untidy table.}
\centering
\begin{tabular}[t]{lrr}
\toprule
Country & Flights2019 & Flights2020\\
\midrule
France & 1.3 & 1.5\\
Germany & 5.2 & 6.0\\
\bottomrule
\end{tabular}
\end{table}

\begin{table}

\caption{\label{tab:twotables}A tidy table.}
\centering
\begin{tabular}[t]{lrr}
\toprule
Country & Year & Flights\\
\midrule
France & 2019 & 1.3\\
Germany & 2020 & 5.2\\
France & 2019 & 1.5\\
Germany & 2020 & 6.0\\
\bottomrule
\end{tabular}
\end{table}

The main data structure used by the tidyverse is the dataframe, although increasingly the tidyverse prefers the `tibble' \texttt{tbl}, which is a specific sort of dataframe. (TBD) We won't worry about the differences here.

For most `quick pieces of code', the easiest is to start with a \texttt{library(tidyverse)} to load all the parts of the tidyverse. If you were writing a package, that wouldn't be very efficient, because there's quite a lot of it. Sometimes you'll see individual parts of the tidyverse loaded including:

\begin{itemize}
\tightlist
\item
  \texttt{ggplot2}: lots of plotting functions (see next chapters)
\item
  \texttt{dplyr}: for manipulating and processing data
\item
  \texttt{tidyr}: for tidying data, such as pivot-table like actions, or splitting columns.
\end{itemize}

And there are packages which are on the outskirts of the `tidyverse' which get announced when you first load. The full list is as follows.

\begin{verbatim}
## -- Attaching packages -------------------------------- tidyverse 1.3.0 --
\end{verbatim}

\begin{verbatim}
## v ggplot2 3.3.2     v purrr   0.3.4
## v tibble  3.0.1     v dplyr   1.0.0
## v tidyr   1.1.0     v stringr 1.4.0
## v readr   1.3.1     v forcats 0.5.0
\end{verbatim}

\begin{verbatim}
## -- Conflicts ----------------------------------- tidyverse_conflicts() --
## x lubridate::as.difftime() masks base::as.difftime()
## x lubridate::date()        masks base::date()
## x dplyr::filter()          masks stats::filter()
## x lubridate::intersect()   masks base::intersect()
## x dplyr::lag()             masks stats::lag()
## x lubridate::setdiff()     masks base::setdiff()
## x lubridate::union()       masks base::union()
\end{verbatim}

\begin{verbatim}
##  [1] "broom"      "cli"        "crayon"     "dbplyr"     "dplyr"     
##  [6] "forcats"    "ggplot2"    "haven"      "hms"        "httr"      
## [11] "jsonlite"   "lubridate"  "magrittr"   "modelr"     "pillar"    
## [16] "purrr"      "readr"      "readxl"     "reprex"     "rlang"     
## [21] "rstudioapi" "rvest"      "stringr"    "tibble"     "tidyr"     
## [26] "xml2"       "tidyverse"
\end{verbatim}

These include \texttt{lubridate} and \texttt{stringr} which we've already mentioned.

We'll see a lot more \texttt{tidyverse} usage in chapters TBD, when we get to grips with data wrangling. Just to whet your appetite, here we show two quick examples. Start with the untidy dataframe shown above. Use \texttt{pivot\_longer} to make it tidy, all in one go selecting a number of columns (those that start with `Flights') and extracting the `year' from this, then pivoting to the tidy form. Then we show a pairing of \texttt{group\_by} and \texttt{summarise} to produce some annual totals.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{untidy }\OtherTok{\textless{}{-}} \FunctionTok{data.frame}\NormalTok{(}\AttributeTok{Country =} \FunctionTok{c}\NormalTok{(}\StringTok{"France"}\NormalTok{, }\StringTok{"Germany"}\NormalTok{), }
                     \AttributeTok{Flights2019 =} \FunctionTok{c}\NormalTok{(}\FloatTok{1.3}\NormalTok{, }\FloatTok{5.2}\NormalTok{), }
                     \AttributeTok{Flights2020=} \FunctionTok{c}\NormalTok{(}\FloatTok{1.5}\NormalTok{, }\FloatTok{6.0}\NormalTok{))}
\CommentTok{\# tidy the data}
\NormalTok{tidier }\OtherTok{\textless{}{-}} \FunctionTok{pivot\_longer}\NormalTok{(untidy, }
                       \CommentTok{\# pivot the two columns starting with \textquotesingle{}Flights\textquotesingle{}}
                       \AttributeTok{cols =} \FunctionTok{starts\_with}\NormalTok{(}\StringTok{"Flights"}\NormalTok{),}
                       \CommentTok{\# put the column names in a column called \textquotesingle{}year\textquotesingle{}}
                       \AttributeTok{names\_to=} \StringTok{"year"}\NormalTok{,}
                       \CommentTok{\# ignore the \textquotesingle{}Flights\textquotesingle{} bit of the name, and treat as integer}
                       \AttributeTok{names\_pattern =} \StringTok{"Flights(.*)"}\NormalTok{,}
                       \AttributeTok{names\_transform =} \FunctionTok{list}\NormalTok{(}\AttributeTok{year =}\NormalTok{ as.integer),}
                       \CommentTok{\# put the column values in a column called \textquotesingle{}flights\textquotesingle{}}
                       \AttributeTok{values\_to =} \StringTok{"flights"}\NormalTok{)}
\FunctionTok{print}\NormalTok{(tidier)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 4 x 3
##   Country  year flights
##   <chr>   <int>   <dbl>
## 1 France   2019     1.3
## 2 France   2020     1.5
## 3 Germany  2019     5.2
## 4 Germany  2020     6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# using groups {-} just print the result}
\NormalTok{tidier }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{group\_by}\NormalTok{(year) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{total\_flights =} \FunctionTok{sum}\NormalTok{(flights))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## `summarise()` ungrouping output (override with `.groups` argument)
\end{verbatim}

\begin{verbatim}
## # A tibble: 2 x 2
##    year total_flights
##   <int>         <dbl>
## 1  2019           6.5
## 2  2020           7.5
\end{verbatim}

Don't worry if this demo seems complicated, or to come out of nowhere - we'll take it more slowly in Chapter TBD. But it illustrates the principle we mentioned earlier: for many operations (like tidying a table), you're not the first to need to do this, so there's probably a neat way to do it in R.

You'll see another short bit of tidyverse at the beginning of the next chapter.

\hypertarget{filetypes}{%
\section{File types}\label{filetypes}}

You will see lots of different file types (ie file extensions), in the files pane. The main ones to remember are:

\begin{itemize}
\tightlist
\item
  \texttt{.R}, \texttt{.Rmd}: both contain R code, though \texttt{.Rmd} is actually `r markdown' which is a mix of code and text;
\item
  \texttt{.RProj}: contains an R `project' - if you see one of these in the directory, this is the one to open - everything else works from there (see TBD);
\item
  \texttt{.rda}, \texttt{.RDS}: are different types of data file. R works easily also with \texttt{.csv} and \texttt{.xls(x)} see TBD.
\end{itemize}

\hypertarget{whats-gone-wrong-1}{%
\section{What's gone wrong?}\label{whats-gone-wrong-1}}

If you see a window like this, then you have started R rather than RStudio. That is a GUI and you can use it to execute R code, but you'll find RStudio easier for all but the quickest snippets of code. \includegraphics[width=0.6\textwidth,height=\textheight]{images/RGui.png}

If it keeps on happening you will find it helpful to associate R files (\texttt{.R,\ .RMD} and others) with RStudio rather than R.

If you get errors saying a certain package is only compatible with version xx and higher (of R), and you think you've recently updated, are you sure you updated R rather than RStudio? The RStudio version is found from the top menu `RStudio/About R Studio', the R version is seen when you first start up (see the image just above), or is printed if you type \texttt{version} in the console.

If you're searching in `help' and a function isn't appearing, for example in the drop-down as you type, it is probably because it comes from a package that isn't loaded. You can finish typing, and the system will search and may find it, but also some other less good matches. Or if you know the package name, you can type \texttt{?ggplot2::geom\_line} for example, in the console to go straight there.

\hypertarget{test-yourself}{%
\section{Test yourself}\label{test-yourself}}

\hypertarget{questions}{%
\subsection{Questions}\label{questions}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Where will you (usually) find the help on functions?
\item
  Which of these provides a graphical user interface (GUI): R, RStudio?
\item
  Which ctrl-key combination takes you to the environment pane?
\item
  What does an \texttt{.rda} file contain?
\item
  What's the difference between typing into a source file and into the console?
\item
  What is a `vignette'?
\item
  (teaser) What does \texttt{3\ +\ 1:3} give?
\end{enumerate}

\hypertarget{answers}{%
\subsection{Answers}\label{answers}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Bottom right.
\item
  Both, though you'll nearly always want to use RStudio.
\item
  CTRL-8
\item
  R data
\item
  With the console, code is executed as each line is completed.
\item
  An extended entry in the documentation showing how to put the functions of the packages together.
\item
  \texttt{4\ 5\ 6}
\end{enumerate}

\hypertarget{first-look-at-data-and-co2-emissions}{%
\chapter{\texorpdfstring{First look at data and CO\textsubscript{2} Emissions}{First look at data and CO2 Emissions}}\label{first-look-at-data-and-co2-emissions}}

It's hard to get far in an analysis without first looking at the data to ask questions such as:

\begin{itemize}
\tightlist
\item
  What variables are there? Do I know what they all mean?
\item
  What time period does it cover?
\item
  Which countries, or airports etc, are included?
\end{itemize}

In this chapter, we introduce some of the ways to take a quick look at your data. We introduce some data on CO\textsubscript{2} emissions per European State from aviation.

\begin{tabular}{l}
\hline
In this chapter, you'll be introduced to:\\
\hline
`read\_xlsx()`, `<-`, `summary`, `str`, environment pane, `View()`, `unique`, `head`, `c()`, `[]`, `ggplot()`\\
\hline
\end{tabular}

Re-open your \texttt{justlearning} project (\url{File:Recent} Projects, or `justLearning.Rproj'). Create a new source file (\url{File:New} \url{File:R} script), to copy and paste the examples into, and save it as `chapter 3'.

This starts a new R session, which means you have to re-load the package(s) that you need, as in this code.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{suppressPackageStartupMessages}\NormalTok{(}\FunctionTok{library}\NormalTok{(tidyverse)) }\CommentTok{\# without lots of messages }
\end{Highlighting}
\end{Shaded}

\hypertarget{loadco2}{%
\section{\texorpdfstring{Looking at data: CO\textsubscript{2} Data}{Looking at data: CO2 Data}}\label{loadco2}}

We use public data on national CO\textsubscript{2} emissions from aviation available on the \href{https://ansperformance.eu/data/}{EUROCONTROL/AIU website}. We choose this, apart from the interest in the data themselves, because it's a small set so quick to download, and it's already tidy (each variable in one column). To isolate this book from changes in the original file, we use a version that we've saved to github.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# download the file to the data folder, the \textquotesingle{}mode\textquotesingle{} parameter is needed on Windows machines}
\NormalTok{co2\_url }\OtherTok{\textless{}{-}} \StringTok{"https://github.com/david6marsh/flights\_in\_R/raw/main/data/CO2\_emissions\_by\_state.xlsx"}
\CommentTok{\# co2\_url \textless{}{-} "https://ansperformance.eu/download/xls/CO2\_emissions\_by\_state.xlsx"}
\FunctionTok{download.file}\NormalTok{(co2\_url, }\StringTok{"data/CO2\_emissions.xlsx"}\NormalTok{, }\AttributeTok{mode =} \StringTok{"wb"}\NormalTok{)}

  
\CommentTok{\# load from the DATA worksheet {-} case sensitive!}
\NormalTok{aviation\_co2 }\OtherTok{\textless{}{-}}\NormalTok{ readxl}\SpecialCharTok{::}\FunctionTok{read\_excel}\NormalTok{(}\StringTok{"data/CO2\_emissions.xlsx"}\NormalTok{, }
                                  \AttributeTok{sheet =} \StringTok{"DATA"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

We've already seen the \texttt{function(parameter)} way to call a function in the \texttt{cos(pi/3)} example. Now we have \texttt{something\ \textless{}-\ function(parameter,\ parameter)}. This is a peculiarity of R that you just need to get used to. Think of it as saying: create \texttt{something} in the environment (without saying what it is just yet), then fill it (\texttt{\textless{}-}) with the results of the \texttt{function()}. While you might occasionally have used a function in Excel, for example, in R basically everything you do is call functions.

Now that the Excel data are downloaded, comment out the 2 lines \texttt{download.files()}, because we don't need to keep downloading if you happen to re-run the code. Notice that R doesn't mind if a function is split over several lines. If there were frequent updates, maybe you would repeatedly download. See (TBD) for an example. {[}See the Excel, now in your project \texttt{data} folder, for disclaimer and details.{]}

International conventions mean that CO\textsubscript{2} emissions are measured from flights departing airports in a State. \texttt{read\_xlsx} automatically selects the first row as variable names.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{summary}\NormalTok{(aviation\_co2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##       YEAR          MONTH         STATE_NAME         STATE_CODE       
##  Min.   :2010   Min.   : 1.000   Length:5694        Length:5694       
##  1st Qu.:2012   1st Qu.: 3.250   Class :character   Class :character  
##  Median :2015   Median : 6.000   Mode  :character   Mode  :character  
##  Mean   :2015   Mean   : 6.498                                        
##  3rd Qu.:2018   3rd Qu.: 9.000                                        
##  Max.   :2020   Max.   :12.000                                        
##  CO2_QTY_TONNES          TF        
##  Min.   :      0   Min.   :     1  
##  1st Qu.:  15665   1st Qu.:  1364  
##  Median :  84312   Median :  4605  
##  Mean   : 336396   Mean   : 16376  
##  3rd Qu.: 279711   3rd Qu.: 17073  
##  Max.   :3541111   Max.   :120473
\end{verbatim}

The \texttt{summary} function is fairly basic, but it gives a quick feel for what's in the data. Often more helpful with numeric than character, but also useful for spotting if there are missing values \texttt{NA}, of which there are none here.

In this dataset we have:

\begin{itemize}
\tightlist
\item
  YEAR: An integer, not a date, but read\_xlsx reads this as a real number.
\item
  MONTH: An integer, giving the month in the year.
\item
  STATE\_NAME, STATE\_CODE: A long name and the 2-letter `country code' derived from the ICAO 4-letter communication address, of which the less said, the better.
\item
  CO2\_QTY\_TONNES: Total annual CO2 emissions, in (metric) tonnes.
\item
  TF: Total flights. This is departing flights. Flights through the State airspace that do not land are not counted, nor are arrivals from outside the State. A domestic flight is counted once, as a departure.
\end{itemize}

You'll notice a few names in there which aren't States, such as `Canaries' which is counted separately from Spain. These measurements add up cleanly (this isn't always true in flights data), so you can get the full `Spain' by adding the two. There are also some States with a '*' next to their names, which means (TBD).

We want to keep things simple, so we will use a little data wrangling to get rid of the month, then save the result as an \texttt{r} dataset. This is a fairly common pattern for re-organising your data: \texttt{group\_by} the relevant variables, then summarise within those groups. Here we use the \texttt{summarise\_at} variant of summarise, which allows us quickly to apply a function \texttt{sum} to multiple variables. Often you want to keep your groups, but here we don't need to, so we \texttt{ungroup}.

There will be more examples of this sort of data manipulation in Chapter TBD.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{annual\_co2 }\OtherTok{\textless{}{-}}\NormalTok{ aviation\_co2 }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{group\_by}\NormalTok{(YEAR, STATE\_NAME, STATE\_CODE) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{summarise\_at}\NormalTok{(}\FunctionTok{vars}\NormalTok{(CO2\_QTY\_TONNES, TF), sum) }\SpecialCharTok{\%\textgreater{}\%}
  \FunctionTok{ungroup}\NormalTok{()}

\FunctionTok{save}\NormalTok{(annual\_co2, }\AttributeTok{file =} \StringTok{"data/annual\_co2.rda"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

There are three other important ways to explore the data. Firstly in the environment pane (top right, CTRL-8), where you can click the first line, with name on, to see a summary. You get much the same thing in the console by typing \texttt{str(annual\_co2)} where \texttt{str} is for `structure'. You should see something like this.

\includegraphics{images/CO2inEnvironment.png}

We can see that there are three numeric variables (\texttt{num}) and two character variables (\texttt{chr}). All five variables have the same number of observations (482 - but maybe this is more by the time you download it). In a tibble or data.frame the columns are always the same length.

The second way to explore the structure, because this is a tibble, is just to type its name in the console. {[}Try it{]} This is useful but just bear in mind that for some data structures, this might fill up your console with a lot of output. Save it for when you're sure you've a tibble. You can check by typing \texttt{class(my\_thing)} into the console to see if \texttt{my\_thing} is a tibble (shown as \texttt{tbl}).

The third way gives a window to explore every observation. Click on the dataset name next to the blue arrow or type \texttt{View(annual\_co2)} in the console (sorry about the upper case `V') and you get a tabular data explorer, which allows you to sort and filter. You should see something like this. {[}Try out the sorting and filtering in the view window. Filter to show only the Netherlands, and sort by total flights.{]}

\includegraphics{images/CO2inViewAndEnvironment.png}

\hypertarget{extracting-variables}{%
\section{Extracting variables}\label{extracting-variables}}

To answer more questions about the data there are some more tools to summarise the values that it takes. We saw \texttt{summary()} works for numeric values, but what about discrete ones?

There are several ways to pull one variable out of your data. We'll use the \texttt{\$} notation, partly because there's a reminder of this in the environment tab.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# pull out all values in the column}
\NormalTok{state\_vbl }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2}\SpecialCharTok{$}\NormalTok{STATE\_NAME}

\NormalTok{states }\OtherTok{\textless{}{-}} \FunctionTok{unique}\NormalTok{(state\_vbl)}
\end{Highlighting}
\end{Shaded}

Look in the environment pane, \texttt{state\_vbl} is listed under `Values'. It's a (column) vector, one of the simple data types in R which is why it's listed under `Values' and not under `Data'. You've just pulled a column out of \texttt{annual\_co2} so not surprising that it has the same number of rows as \texttt{annual\_co2}. And the first values are all ALBANIA, or were when this book was compiled.

Really we want to know how many different States there are, and which ones. \texttt{unique} does what it says, and we've saved these as \texttt{states}; a variable name which to me implies `unique States'. You can tell how many there are from the environment pane, or you could use \texttt{length(states)}. {[}How many are there?{]}

To inspect all of these values you can just type \texttt{states} into the console, a good way to check the spelling of some, perhaps. {[}Try this. Is it `Canaries' or `Canarias'?{]}

The order in which the elements are shown is as in the original data, there's no careless re-ordering. If you've worked with SAS PROC SQL or other languages, it might come as a relief to hear that, in R, the order of rows stays where it's put until you say otherwise; none of this sorting before every operation. We'll see some ways to handle `top' values later (section \ref{topStates}).

So in this case, even if the \texttt{states} are in alphabetical order, that's just because the original Excel file was.

\hypertarget{someValues}{%
\section{Extracting a few values}\label{someValues}}

We've just seen how to pull a variable out of a tibble, as a vector. How do we extract one or more values out of the vector that we created?

The \texttt{states} are quite a lot to show in the console. Sometimes you just need to see a quick sample, eg to check if they're in title case, or if they're codes or names. \texttt{head()} is useful for showing you the first few (6 by default).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{head}\NormalTok{(states)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ALBANIA"                "ARMENIA"                "AUSTRIA"               
## [4] "BELGIUM"                "BOSNIA AND HERZEGOVINA" "BULGARIA"
\end{verbatim}

If you want to pull out a single value, or a few of them, again there are multiple ways to do this, but the simplest is this. We show here two ways to select with a vector of numbers: creating a consecutive sequence of numbers (\texttt{1:3}); and creating a vector with an arbitrary selection (\texttt{c(1,\ 5,\ 10)}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{states[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ALBANIA"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{states[}\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "AUSTRIA"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{states[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ALBANIA" "ARMENIA" "AUSTRIA"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{states[}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "ALBANIA"                "BOSNIA AND HERZEGOVINA" "CZECHIA"
\end{verbatim}

We'll deal with subsetting the whole dataset, rather than just a vector extracted from it, in the next chapter.

\hypertarget{co2-scatter-plot}{%
\section{\texorpdfstring{CO\textsubscript{2} Scatter plot}{CO2 Scatter plot}}\label{co2-scatter-plot}}

It's hard to beat a graph as a way to explore data. So we end the chapter exploring a simple graph. The tidyverse way of doing this is to use \texttt{ggplot}.

\hypertarget{first-draft}{%
\subsection{First draft}\label{first-draft}}

In the most basic scatter plot we have the following components, joined with a \texttt{+}. This \texttt{+} is peculiar to \texttt{ggplot}; another lovable quirk of R. Learn it, but get used to the idea that you'll forget and use other conjunctions by mistake at times.

In the simplest code we have:

\begin{itemize}
\tightlist
\item
  \texttt{ggplot}: with parameters the data to use, and an `aesthetic' \texttt{aes};
\item
  \texttt{aes}: gives the x and y first, and here also says choose colour based on year;
\item
  \texttt{geom\_point}: says to plot points with these data, ie a scatter plot.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(annual\_co2, }
       \FunctionTok{aes}\NormalTok{(TF, CO2\_QTY\_TONNES, }\AttributeTok{colour =}\NormalTok{ YEAR)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-8-1.pdf}

Even this simple example illustrates that:

\begin{itemize}
\tightlist
\item
  a parameter can be another function call \texttt{aes()};
\item
  we can specify parameters by order of appearance in the list (\texttt{x} and \texttt{y} are first and second for \texttt{aes}) or by name (\texttt{colour}), or a mix of both;
\item
  \texttt{geom\_point} takes its aesthetics by default from the \texttt{ggplot} statement.
\end{itemize}

There's a (very) rough correlation along a diagonal line, but it would be interesting to know which States are above the line (more CO\textsubscript{2} per flight) and which below. And is the change gradual, or is there much variability?

\hypertarget{improve-the-titles}{%
\subsection{Improve the titles}\label{improve-the-titles}}

Let's at least label the axes so that someone else can see quickly what has been plotted. We can transform variables on the fly (using the rule that a parameter can be a function call, here to the function \texttt{/}), so let's convert both axes to millions.

The label on the legend is meaningful, but to avoid the block capitals we can change that too within the \texttt{labs()} statement. It's a `colour' legend (that's what is in the \texttt{aes} call), so you need to refer to `colour' in the \texttt{labs()}.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(annual\_co2, }\FunctionTok{aes}\NormalTok{(TF}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, }\AttributeTok{colour =}\NormalTok{ YEAR)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Departing Flights (millions)"}\NormalTok{, }
       \AttributeTok{y =} \StringTok{"CO2 (million tonnes)"}\NormalTok{,}
       \AttributeTok{colour =} \StringTok{"Year"}\NormalTok{,}
       \AttributeTok{title =} \StringTok{"Emissions per State"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-9-1.pdf}

\hypertarget{statecluster}{%
\subsection{and with clustering by State}\label{statecluster}}

It's tempting to read the graph as having a number of small clusters, each with flights and CO\textsubscript{2} increasing with time, and assume that each of these corresponds to a single State. It would be nice to use the graph to see if that's true.

There are too many countries to give each its own shape (we'll see shapes used more effectively in section TBD), but we can easily add a line to join the points for each State. {[}How do you think you would add a line?{]}

We need both to add a line, which follows the pattern of \texttt{geom\_point}, and group by State. That's done in the same way that we coloured by year, in the aesthetics. There are several ways to plot a line. The most obvious one, having seen \texttt{geom\_point} previously, is \texttt{geom\_line}. However, this joins the points in x-axis order. We want data order, so that's \texttt{geom\_path}.

Out of a sense of neatness, we also add a subscript to CO\textsubscript{2}. The code \texttt{bquote(\textasciitilde{}CO{[}2{]}\textasciitilde{}"\ (million\ tonnes)")} took some googling and is cryptic, but it works!

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(annual\_co2, }\FunctionTok{aes}\NormalTok{(TF}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, }
                         \AttributeTok{colour =}\NormalTok{ YEAR, }\AttributeTok{group =}\NormalTok{ STATE\_NAME)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_path}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Departing Flights (millions)"}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{colour =} \StringTok{"Year"}\NormalTok{,}
       \AttributeTok{title =} \StringTok{"Emissions per State"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-10-1.pdf}

The graph isn't ready for a presentation yet, but a story is already emerging. The lines do the job of grouping the years for each State together. We see a graph with 6 busy States, 3 of which are fairly linear, so a relatively fixed CO\textsubscript{2}/flight. Three others are more variable from year to year.

Then there are two States, with flights in the 0.25-0.5 million flights range and that diverge from the main trend line, respectively higher and lower. The remaining, smaller States rather overlap in this graph.

We'll find out how to pick out and label States in the next chapter.

\hypertarget{whats-gone-wrong-2}{%
\section{What's gone wrong?}\label{whats-gone-wrong-2}}

It pays to looks closely at the graph and try to explain what you see. In fact, it was only once I'd tidied the colours up that I noticed that they were not in order along the line. I had used \texttt{geom\_line} (join in x-axis order) in place of \texttt{geom\_path} (join in data order). So story-telling can help debugging too. Also, it pays to read the help file, even if you think you know how the function works!

We'll see more about grouping in later chapters. It's quite common that I get errors in some tidyverse data wrangling, because the dataset is grouped, and I had forgotten that. So grouping is powerful and quick, but R remembers your groups longer than you do!

\hypertarget{test-yourself-1}{%
\section{Test yourself}\label{test-yourself-1}}

\hypertarget{questions-1}{%
\subsection{Questions}\label{questions-1}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  Use \texttt{head} to view the first 10 states.
\item
  Using the help file for \texttt{head}, how would you display the last 6 states?
\item
  Which State names are followed by '*'?
\item
  Print the distinct state codes to the console.
\item
  Print the 3rd, 23rd and 33rd state names to the console.
\item
  What does \texttt{\textless{}-} do?
\item
  In \texttt{ggplot} what does \texttt{+} do?
\end{enumerate}

\hypertarget{answers-1}{%
\subsection{Answers}\label{answers-1}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  \texttt{head(states,\ 10)}
\item
  \texttt{head} is documented alongside \texttt{tail}: use \texttt{tail(states)}
\item
  (In my version of the data), typing \texttt{states} into the console, and by eye I see 4 States with a '*'. We'll see other ways to do this, later.
\item
  \texttt{unique(annual\_co2\$STATE\_CODE)}
\item
  \texttt{states{[}c(3,\ 23,\ 33){]}}
\item
  It puts the results of whatever is on the right-hand side into the object on the left.
\item
  It connects parts of the definition of a graph together.
\end{enumerate}

\hypertarget{filtering-a-dataset-and-refining-the-co2-graph}{%
\chapter{\texorpdfstring{Filtering a dataset and refining the CO\textsubscript{2} graph}{Filtering a dataset and refining the CO2 graph}}\label{filtering-a-dataset-and-refining-the-co2-graph}}

In this chapter we improve the CO\textsubscript{2} emissions graph, \emph{en route} learning how to filter observations from a dataset, to add new variables, and to use the \texttt{pipe} operator \texttt{\%\textgreater{}\%}.

\begin{tabular}{l}
\hline
In this chapter, you'll be introduced to:\\
\hline
`filter()`, `==`, `\%in\%`, `mutate()`, `slice\_max()`, `\%>\%`, `geom\_text\_repel()`, `scales\_colour\_...`\\
\hline
\end{tabular}

On restarting your \texttt{justlearning} project, you should still have the \texttt{annual\_co2} dataset in your environment, since RStudio saves these data and reloads on restart. If not, you should find that \texttt{annual\_co2.rda} is saved in the \texttt{data} folder, and you can load it using \texttt{load("data/annual\_co2.rda")}. One R speciality here is that you don't need to assign the result with a \texttt{annual\_co2\ \textless{}-\ ...}; in fact the file we saved could have contained a number of datasets, and they're all reloaded \emph{with their original dataset names}.\footnote{If even that doesn't work, and for some reason the \texttt{rda} file is not in your data folder, go back to section the previous chapter and load the Excel file again, and find the code to summarise over years.}

If you have closed RStudio and re-opened it, then you have a new session and need to reload packages, in this case \texttt{library(tidyverse)}.

\hypertarget{sequences-of-functions}{%
\section{Sequences of functions}\label{sequences-of-functions}}

It's time for a bit more syntax. We saw already that you can combine functions by making one the parameter to another. Or to put it another way, wrapping one around the other. As you combine more functions, this soon becomes hard to read, and you have to rely on the editor to help you spot whether you've enough brackets closed at the right point.

For that reason we use a different syntax, the `pipe' operator \texttt{\%\textgreater{}\%} introduced by the \texttt{magrittr} package and adopted by the tidyverse. If you learn only one control-key combination in RStudio, do learn shift-ctrl-M (also shift-command-M on Mac). This must be the fastest way to type `\%\textgreater\%'! {[}Try it in your console.{]}

With a new line after each \texttt{\%\textgreater{}\%} and appropriate indenting (RStudio helps with that), you get code that looks like this. This says, fill \texttt{a} with what you get from dataset \texttt{b} after applying function \texttt{fun1}, then function \texttt{fun2}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# which is clearer}
\CommentTok{\# with a pipe?}
\NormalTok{a }\OtherTok{\textless{}{-}}\NormalTok{ b }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{fun1}\NormalTok{(p1) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{fun2}\NormalTok{(p2, p3)}
\CommentTok{\# or without?}
\NormalTok{a }\OtherTok{\textless{}{-}} \FunctionTok{fun2}\NormalTok{(}\FunctionTok{fun1}\NormalTok{(b, p1), p2, p3)}
\end{Highlighting}
\end{Shaded}

The pipe syntax works because \texttt{fun1} actually has a parameter list that \emph{starts} with the dataset to which it should be applied \texttt{fun1(data,\ p1,...)}. So \texttt{b\ \%\textgreater{}\%\ fun1(p1)} is just another way of writing \texttt{fun1(b,\ p1)}. Or, the other way around, you can use \texttt{\%\textgreater{}\%} whenever you have a function whose first parameter is the dataset to be operated on. It turns out that this is true for very many of them, and the tidyverse is designed that way.

\hypertarget{filtering-datasets-and-logical-tests}{%
\section{Filtering datasets and logical tests}\label{filtering-datasets-and-logical-tests}}

As is so often the case, in R there are several of ways to select rows from a dataframe or tibble. We'll focus on the \texttt{filter(data,\ test)} function. For this we need to know how to construct a logical test.

There are three parts to this: the logic, the test functions and what's being tested.

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  Logic is mostly given by \texttt{\&}, \texttt{!} and \texttt{\textbar{}}\footnote{that's a vertical bar, not an `l' or `I'} for `and', `not' and `or', grouped with round brackets in the normal way.
\item
  The test functions are \emph{almost} as you might expect: \texttt{\textgreater{}}, \texttt{\textless{}}. However, in R you need to use \texttt{==} not \texttt{=} to test for equality. I suspect this creates the most common typo in R code! Check the documentation of \texttt{dplyr::filter} for a more complete list of test functions: in particular look out for \texttt{\%in\%}, which we will use shortly.
\item
  One really nice touch in \texttt{filter()} is in the third part: what's being tested. One of the trickiest bits of learning R is knowing how, within a function, to refer to one or more variables of the dataset. In \texttt{filter()} you can just use the name of the variable; so no quotes needed around the name, and the code assumes it is a variable from the \texttt{data} parameter, so no need to use \texttt{annual\_co2\$...}.
\end{enumerate}

In this example, we don't push the result into a dataset (no \texttt{a\ \textless{}-}), so it gets printed out directly.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{==} \DecValTok{2018} \SpecialCharTok{\&}\NormalTok{ STATE\_NAME }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"CZECHIA"}\NormalTok{, }\StringTok{"ALBANIA"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 5
##    YEAR STATE_NAME STATE_CODE CO2_QTY_TONNES    TF
##   <dbl> <chr>      <chr>               <dbl> <dbl>
## 1  2018 ALBANIA    LA                143871. 12744
## 2  2018 CZECHIA    LK               1381672. 90679
\end{verbatim}

Note that:

\begin{itemize}
\tightlist
\item
  the order of the rows is as in the original dataset, not at all influenced by the order of the naming of the States in the test
\item
  \texttt{YEAR} and \texttt{STATE\_NAME} are `bare' strings that \emph{name} variables, and are shorthand for \texttt{annual\_co2\$YEAR} etc
\item
  but ``CZECHIA'' is a \emph{value} of a variable so needs to be a string in quotes
\item
  and the test is case-sensitive.
\end{itemize}

\hypertarget{topStates}{%
\section{Selecting the busiest States}\label{topStates}}

In the previous chapter we selected the first-named States with \texttt{head()}. Now we do something more useful: selecting the top States by flights, using \texttt{slice\_max()}. We need to define this a bit more clearly. `Top' could mean in a particular year, or over the whole period (where flights have decreased as well as increased). We choose to mean `top by flights in 2019'. This is partly out of habit (top in the latest year is often the meaning) and partly because we need to introduce fewer new bits of R to implement it.

The code is like this. A final novelty is that we use \texttt{pull()} which, as its help-file says, does the same as \texttt{\$} (learned in the last chapter) but looks nicer in pipes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{top\_states }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{==} \DecValTok{2019}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}     \CommentTok{\# top in year 2019}
  \FunctionTok{slice\_max}\NormalTok{(TF, }\AttributeTok{n =} \DecValTok{8}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}  \CommentTok{\# top 8 }
  \FunctionTok{pull}\NormalTok{(STATE\_NAME) }
\end{Highlighting}
\end{Shaded}

\texttt{slice\_max()} is a good example of how R changes with time. New versions of packages introduce minor or major changes. Sometimes a function is \texttt{superseded} (left to rot), other times it may be \texttt{deprecated} (you have some time to switch to a new version before it's removed). The function \texttt{top\_n}, which you might see lying around in legacy code, has been superseded by \texttt{slice\_max()}. {[}Check out the documentation of \texttt{top\_n} for some of the reasons.{]}

These changes mean that just updating to the latest version of the package is not always the best idea, because you might have to spend some time checking for changes. It also means that, when searching on the web for hints, snippets and answers, you need to look at the date of the answer. \texttt{ggplot} in particular has changed quite a bit, so answers more than 5 years old or so might not be that helpful.

\hypertarget{co2-graph-for-the-top-states}{%
\section{\texorpdfstring{CO\textsubscript{2} graph for the top States}{CO2 graph for the top States}}\label{co2-graph-for-the-top-states}}

With \texttt{top\_states} in place we can easily plot the data for the busiest States.

We update the title, and add a footnote (\texttt{caption}) to explain what's going on. We could have created a new dataset, eg \texttt{top\_co2\ \textless{}-\ annual\_co2\ \%\textgreater{}\%\ filter(STATE\_NAME\ \%in\%\ top\_states)}, and then used this in the \texttt{ggplot}. But we only plan to use this filter once, so to avoid cluttering the environment with datasets, we filter `on the fly', within the \texttt{ggplot} statement. In this case, this is a matter of personal preference. If the datasets were a lot larger, and we intended analysing and transforming just the top States in further graphs, the decision might be different.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(STATE\_NAME }\SpecialCharTok{\%in\%}\NormalTok{ top\_states), }
       \FunctionTok{aes}\NormalTok{(TF}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, }
           \AttributeTok{colour =}\NormalTok{ YEAR, }\AttributeTok{group =}\NormalTok{ STATE\_NAME)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_path}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Departing Flights (millions)"}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{colour =} \StringTok{"Year"}\NormalTok{,}
       \AttributeTok{title =} \StringTok{"Emissions for the busiest 8 States"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL. \textquotesingle{}Busiest\textquotesingle{} means most flights in 2019."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-14-1.pdf}

One advantage of filtering on the fly is that we can change on the fly. {[}Change the filter to the States \emph{not} in the top 8. It takes one key press. Re-run the graph. Update the titles too.{]}

As an analyst, I really want to know which country is which. With just 8 States shown, maybe I can use symbols? At one level it's quick to do. Just replace \texttt{group\ =} with \texttt{shape\ =}. {[}Try this.{]} \texttt{ggplot} complains that it doesn't really like using more than 6 symbols, because it becomes hard for the reader to jump between legend and graph. We could roll with it and learn how to extend the pallette, but is there another solution?

We can separate States by colours. Again, quite quick: replace \texttt{colour\ =\ YEAR,\ group\ =\ STATE\_NAME} with \texttt{colour\ =\ STATE\_NAME}. {[}Try this.{]} The line means we can work out the ordering of the years easily, so losing the year isn't a big issue here. But eight colours is also a lot to tell apart. Even without colour blindness, you might think they're clear but when projected onto a screen or printed or on a tiny phone screen, perhaps not.

\hypertarget{labelling-the-co2-graph}{%
\section{\texorpdfstring{Labelling the CO\textsubscript{2} graph}{Labelling the CO2 graph}}\label{labelling-the-co2-graph}}

It's relatively easy to follow a slightly different route: adding State names directly to the graph. This is done with \texttt{geom\_text} added to the \texttt{ggplot}. We only want to label the point in 2019 rather than all years, so we create a new variable which is empty except in rows for the year 2019. \texttt{mutate(a\ =\ ...)} is the function for adding a variable `a' to the dataset\footnote{and we use lower case for the variable name, because that's our preference, even if the imported names don't do this}. \texttt{if\_else()} is how we give a value for only some years. As with the \texttt{filter()} function, we can refer to other variables in \texttt{annual\_co2} without inverted commas.

This time, we amend the \texttt{annual\_co2} dataset itself, because we want to be able to use this in several places, not just in a single graph. The syntax \texttt{a\ \textless{}-\ a\ \%\textgreater{}\%\ ...} follows the same pattern as you saw earlier, but you're overwriting the original dataset.

The \texttt{geom\_text()} \emph{inherits} all of the aesthetics from the \texttt{ggplot} function, so it already knows where to find x and y coordinates, and what colour to use. We still need to tell \texttt{geom\_text()} where to find the labels. This is also an aesthetic.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{annual\_co2 }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{state\_label =} \FunctionTok{if\_else}\NormalTok{(YEAR }\SpecialCharTok{==} \DecValTok{2019}\NormalTok{, STATE\_NAME, }\StringTok{""}\NormalTok{))}

\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(STATE\_NAME }\SpecialCharTok{\%in\%}\NormalTok{ top\_states), }
       \FunctionTok{aes}\NormalTok{(TF}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, }
           \AttributeTok{colour =}\NormalTok{ YEAR, }\AttributeTok{group =}\NormalTok{ STATE\_NAME)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_path}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{geom\_text}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ state\_label), }\AttributeTok{nudge\_y =} \DecValTok{2}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Departing Flights (millions)"}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{colour =} \StringTok{"Year"}\NormalTok{,}
       \AttributeTok{title =} \StringTok{"Emissions for the busiest 8 States"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL. \textquotesingle{}Busiest\textquotesingle{} means most flights in 2019."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-15-1.pdf}

This is close, but not quite good enough. The text is centred on the 2019 point, and this creates some ugly overlaps. There are lots of options in \texttt{geom\_text()} to adjust the position, and you'll find lots of examples on the web. So we could spend time adjusting the positions. But this is a first example of the rule: `surely someone has already come across this problem?'.

Someone has indeed spent time to come up with good ways to deconflict and position labels on graphs. The package is called \texttt{ggrepel}, which you might need to install with \texttt{install.packages("ggrepel")}, and it provides a `drop in' replacement for \texttt{geom\_text} naturally called \texttt{geom\_text\_repel}. To avoid using \texttt{library("ggrepel")} when we're just using one function from the package on one occasion, we use the double-colon syntax in the code.

The defaults for this function work pretty well in this particular case. But there are a couple of things I'd like to fix: the block capitals and the year legend. Title case would be nicer, so we convert the \texttt{STATE\_NAME} using the \texttt{stringr} package function \texttt{str\_to\_title()}. \texttt{stringr} is already loaded as part of the tidyverse, and since most of its functions begin `str\_' it's quite easy to start searching in the help pane for the right one {[}Try this.{]}. In this case \texttt{state\_label} already exists and we overwrite it.

The other thing to improve is the year scale, which shows with meaningless decimals. We use a quick-ish fix, rather than the tidiest-possible solution. Scales, whether the axes or colours, are controlled by \texttt{ggplot} functions starting \texttt{scales\_} in this case \texttt{scales\_colour\_steps()} gets us a scale that shows the individual years. This is a `dirty' solution in the sense that, if the data for 2020 get included, you might need to tweak the code; but then, we've hard-coded 2019 in a number of places, so this is dirty elsewhere. We'll see cleaner options later (for example in section \ref{factors}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{annual\_co2 }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{state\_label =} \FunctionTok{if\_else}\NormalTok{(YEAR }\SpecialCharTok{==} \DecValTok{2019}\NormalTok{, }\FunctionTok{str\_to\_title}\NormalTok{(STATE\_NAME), }\StringTok{""}\NormalTok{))}

\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(STATE\_NAME }\SpecialCharTok{\%in\%}\NormalTok{ top\_states), }
       \FunctionTok{aes}\NormalTok{(TF}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, }
           \AttributeTok{colour =}\NormalTok{ YEAR, }\AttributeTok{group =}\NormalTok{ STATE\_NAME)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_path}\NormalTok{() }\SpecialCharTok{+}
\NormalTok{  ggrepel}\SpecialCharTok{::}\FunctionTok{geom\_text\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ state\_label)) }\SpecialCharTok{+}
  \FunctionTok{scale\_colour\_steps}\NormalTok{(}\AttributeTok{n.breaks =} \DecValTok{8}\NormalTok{, }\AttributeTok{show.limits =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Departing Flights (millions)"}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{colour =} \StringTok{"Year"}\NormalTok{,}
       \AttributeTok{title =} \StringTok{"Emissions for the busiest 8 States"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL. \textquotesingle{}Busiest\textquotesingle{} means most flights in 2019."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-16-1.pdf}

\hypertarget{what-does-the-graph-say-about-co2}{%
\section{\texorpdfstring{What does the graph say about CO\textsubscript{2}?}{What does the graph say about CO2?}}\label{what-does-the-graph-say-about-co2}}

Longer-haul flights use heavier aircraft and therefore the proportion of long-haul flights in a national mix is a major influence on CO\textsubscript{2} per flight. For example, the Netherlands has more CO\textsubscript{2} per flight than Norway: Norway has a significant domestic (so short-range) market, which the Netherlands does not, being instead a major long-haul hub. These two States have been relatively stable.

The UK also has a proportionally larger long-haul market. And a decline in its domestic market has led to quite a rapid increase in CO\textsubscript{2} per flight in recent years.

So, the graph helps to build a story: though we needed some supporting information to provide some of the explanation. It has also become clear that we're interested in CO\textsubscript{2} per flight. See the exercises for a graph on that more directly.

\hypertarget{whats-gone-wrong-3}{%
\section{What's gone wrong?}\label{whats-gone-wrong-3}}

It's inevitable that you will type \texttt{=} in tests where you mean \texttt{==}. Some functions have friendly messages, since this is so common. Others less so.

Watch that case! We are using the function \texttt{filter()}, not the function \texttt{Filter()} which is something else entirely.

\texttt{if\_else} is a fussy version of the base function \texttt{ifelse}, that we use here to maximise use of tidyverse functions. If it warns you that the `false' must be something, then it has your long-term interests at heart. It just means that it's a different type to the `true'. Compare \texttt{ifelse(1\textless{}2,"true",NA)} and \texttt{if\_else(1\textless{}2,"true",NA)} where \texttt{NA} is the code for missing.

\hypertarget{exercises}{%
\section{Exercises}\label{exercises}}

\hypertarget{questions-2}{%
\subsection{Questions}\label{questions-2}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  How does \texttt{geom\_text()} know where to place the text on the graph?
\item
  Adapt \texttt{geom\_text()} to shift all labels up 2 (million tonnes!). {[}Hint: Check the help file.{]}
\item
  Adapt the graph to show the smallest 8 States instead. (Hints: What's the most likely counterpart to \texttt{slice\_max}? Closely-related functions are often to be found in the \emph{same} help file.)
\item
  Adapt the graph to show year on the x-axis and CO\textsubscript{2}/flight on the y-axis. (Hints: Mostly changing the first \texttt{aes()} and deleting some elements. For a pretty graph you might google how to hide the legend ``ggplot hide legend'', and how to set the breaks on the x-axis.)
\end{enumerate}

\hypertarget{answers-2}{%
\subsection{Answers}\label{answers-2}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  \texttt{geom\_text()} inherits all aesthetics from the opening \texttt{ggplot(...,\ aes(...))}, which can be supplemented or over-written by its own \texttt{aes()}. In fact you could put the \texttt{label=} into the first \texttt{aes()}.
\item
  \texttt{geom\_text(aes(label\ =\ state\_label),\ nudge\_y\ =\ 2)}. If you put the \texttt{nudge\_y} inside the \texttt{aes()} you get an error (`Ignoring unknown aesthetics: nudge\_y') because it's not something that can vary with the values of a variable (``not an aesthetic'').
\item
  \texttt{geom\_text\_repel} uses call-out lines when it can't get the text close. You could experiment with making these a less confusing colour. You might also drop the `millions'.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{small\_states }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{==} \DecValTok{2019}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}     \CommentTok{\#  in year 2019}
  \FunctionTok{slice\_min}\NormalTok{(TF, }\AttributeTok{n =} \DecValTok{8}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}  \CommentTok{\# smallest 8 }
  \FunctionTok{pull}\NormalTok{(STATE\_NAME)}

\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(STATE\_NAME }\SpecialCharTok{\%in\%}\NormalTok{ small\_states), }
       \FunctionTok{aes}\NormalTok{(TF}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{, }
           \AttributeTok{colour =}\NormalTok{ YEAR, }\AttributeTok{group =}\NormalTok{ STATE\_NAME)) }\SpecialCharTok{+}
  \FunctionTok{geom\_point}\NormalTok{() }\SpecialCharTok{+} 
  \FunctionTok{geom\_path}\NormalTok{() }\SpecialCharTok{+}
\NormalTok{  ggrepel}\SpecialCharTok{::}\FunctionTok{geom\_text\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ state\_label)) }\SpecialCharTok{+}
  \FunctionTok{scale\_colour\_steps}\NormalTok{(}\AttributeTok{n.breaks =} \DecValTok{8}\NormalTok{, }\AttributeTok{show.limits =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Departing Flights (millions)"}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{colour =} \StringTok{"Year"}\NormalTok{,}
       \AttributeTok{title =} \StringTok{"Emissions for the least{-}busy States"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL. \textquotesingle{}Busiest\textquotesingle{} means most flights in 2019."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-17-1.pdf}

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\setcounter{enumi}{3}
\tightlist
\item
  A pedant might say this shouldn't be a line chart, but here's one possibility. We'll see a different version of this in section (TBD)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(STATE\_NAME }\SpecialCharTok{\%in\%}\NormalTok{ top\_states), }
       \FunctionTok{aes}\NormalTok{(YEAR, CO2\_QTY\_TONNES}\SpecialCharTok{/}\NormalTok{TF, }
           \AttributeTok{colour =}\NormalTok{ STATE\_NAME)) }\SpecialCharTok{+}
  \FunctionTok{geom\_path}\NormalTok{() }\SpecialCharTok{+} \CommentTok{\# I decided the points looked too heavy}
\NormalTok{  ggrepel}\SpecialCharTok{::}\FunctionTok{geom\_text\_repel}\NormalTok{(}\FunctionTok{aes}\NormalTok{(}\AttributeTok{label =}\NormalTok{ state\_label)) }\SpecialCharTok{+}
  \FunctionTok{theme}\NormalTok{(}\AttributeTok{legend.position =} \StringTok{"none"}\NormalTok{) }\SpecialCharTok{+}  \CommentTok{\# turn off legend}
  \FunctionTok{scale\_x\_continuous}\NormalTok{(}\AttributeTok{breaks =} \DecValTok{2010}\SpecialCharTok{:}\DecValTok{2019}\NormalTok{, }\AttributeTok{minor\_breaks =} \ConstantTok{NULL}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# control the breaks}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{"Year"}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (tonnes per flight)"}\NormalTok{),}
       \AttributeTok{title =} \StringTok{"Emissions for the busiest 8 States"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL. \textquotesingle{}Busiest\textquotesingle{} means most flights in 2019."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-18-1.pdf}

\hypertarget{sorting-bars-saving-graphs-facets}{%
\chapter{Sorting Bars, Saving Graphs, Facets}\label{sorting-bars-saving-graphs-facets}}

While nothing beats a well hand-crafted chart, there are times when you want to just run the code and get a quick update, as a .png say. In this chapter we see how to do a classic sorted-bar chart and to save it to a file for use elsewhere. We need slightly different methods for simple bar charts and more complex ones.

\begin{tabular}{l}
\hline
In this chapter, you'll be introduced to:\\
\hline
`geom\_col()`, `dodge`, `reorder()`, `ggsave()`, `as.factor()`, `factor()`, `arrange()`, `facet\_wrap()`, `select`, plots pane\\
\hline
\end{tabular}

\hypertarget{firstsortedbar}{%
\section{\texorpdfstring{The simple sorted bar chart - more on CO\textsubscript{2}}{The simple sorted bar chart - more on CO2}}\label{firstsortedbar}}

A classic visualisation is the bar chart, sorted from longest to shortest. With \texttt{ggplot} there are a couple of ways to get a bar chart. If you want \texttt{ggplot} to count the rows for you, use \texttt{geom\_bar}. Here we already have values for the length of the bar, so we use \texttt{geom\_col} instead.

For the simplest bar charts, there is a quick way to get the order you want. In place of \texttt{state\_label} for the x-axis, you give \texttt{reorder(state\_label,\ CO2\_QTY\_TONNES)}, the second being the variable to sort by. If you find the bars a bit top-heavy, put a \texttt{-} in front of \texttt{Y\_CO2...} to reverse the order.

The final novelty in this graph is \texttt{coord\_flip()}. Forty-something State names is a lot of text to cram onto the horizontal axis. So we flip the axes. You'll need to decide if this trick works where you want to use the graph. We'll see other ways to separate the labels on the axes in (TBD).

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{==} \DecValTok{2019}\NormalTok{), }
       \FunctionTok{aes}\NormalTok{(}\FunctionTok{reorder}\NormalTok{(state\_label, CO2\_QTY\_TONNES),}
\NormalTok{           CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{)) }\SpecialCharTok{+}
  \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{title =} \StringTok{"Aviation Emissions in 2019"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL."}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-20-1.pdf}

If you were to google `ggplot ordered bar chart', you might find references to `factors'. That becomes necessary when the charts are more complicated. We'll look at that in section \ref{factors}.

\hypertarget{saving-a-plot}{%
\section{Saving a plot}\label{saving-a-plot}}

You might be looking at the bar chart and thinking that it's the wrong proportions for your need (portrait rather than landscape, or vice versa) or you might be thinking the axis labels are still a bit squashed together.

The proportions on your screen will depend on a number of things including the space you have allowed for the `Plots' window. Now, the plots window has an export button which you could use. It allows for re-sizing, but that means you have to do the same manual intervention each time.

We prefer to use \texttt{ggsave()} to save the most-recent plot, and at the same time set the aspect ratio that we need. Usually it's worth doing this before working too much on the font sizes, since you don't really know if there's a problem until you've seen the png.

Finally, we use the \texttt{graphs} folder we created for the project. Square seems about right for this graph; and having one of the dimensions around 15cm also seems to produce png that are good enough for reports and slides without being too big.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggsave}\NormalTok{(}\StringTok{"graphs/FirstSortedBars.png"}\NormalTok{, }\AttributeTok{width =} \DecValTok{15}\NormalTok{, }\AttributeTok{height =} \DecValTok{15}\NormalTok{, }\AttributeTok{units =} \StringTok{"cm"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{plotting-more-than-one-year}{%
\section{Plotting more than one year}\label{plotting-more-than-one-year}}

I can think of four ways to plot more than one year, and there are no doubt more than that:

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  as staggered bars, though we probably will have to work hard to make enough space;
\item
  as `facets', creating one sub-plot per year;
\item
  as a few graphs, merged and aligned using an dedicated package like \texttt{cowplot};
\item
  as multiple graphs using a loop
\end{enumerate}

Number (3) is particularly useful for combining graphs of different variables, but it's a bit heavy to deal with here. We'll deal with (4) in section (TBD) when we look at loops. The first two we will do in the next sections.

\hypertarget{factors}{%
\subsection{Staggered bars, and factors}\label{factors}}

We took some shortcuts in section \ref{firstsortedbar}, which will need sorting out for the staggered bars. First we need to choose a couple of years, since there certainly isn't room for more than two. That's a filter that we've seen before. Secondly, we used \texttt{state\_label} before because it was prettier, but this only exists for 2019, so we have to go back to using \texttt{STATE\_NAME}. It's probably time to turn this name into title case once and for all.

The separation by year is done in the aesthetic \texttt{aes()} as you might expect. We want the bars to be different colours by year. In this case it's the \texttt{fill} that we specify; \texttt{colour} would add an outline to the bars. To get the bars side by side we set the \texttt{position\ =\ "dodge"} parameter in \texttt{geom\_col()}.

The least obvious, final step is that `year' needs to be a discrete variable, whereas currently it's \texttt{num} which is a continuous number. Slightly oddly, \texttt{as.integer()} doesn't work: it's still treated as continuous by \texttt{ggplot}, presumably because there are potentially still quite a lot of integers.

We could convert to a string with \texttt{as.character}, but we need to start using factors, so let's do that here.

Factors in R were originally a way to save space with character variables in a dataset. In \texttt{annual\_co2} for example, rather than store `ALBANIA' 10 times, for each row, a factor would give \texttt{ALBANIA} a numeric code and store that. The character strings become the levels. {[}Try \texttt{z\ \textless{}-\ as.factor(annual\_co2\$STATE\_NAME)} and see what is said for z in the environment pane. \texttt{rm(z)} to tidy up, if you wish.{]}

For this example, we'll convert \texttt{YEAR} on the fly, with an \texttt{as.factor} in the \texttt{aes()} call.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{annual\_co2 }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{STATE\_NAME =} \FunctionTok{str\_to\_title}\NormalTok{(STATE\_NAME))}

\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{2010}\NormalTok{, }\DecValTok{2019}\NormalTok{)), }
       \FunctionTok{aes}\NormalTok{(}\FunctionTok{reorder}\NormalTok{(STATE\_NAME, CO2\_QTY\_TONNES),}
\NormalTok{           CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{,}
           \AttributeTok{fill =} \FunctionTok{as.factor}\NormalTok{(YEAR))) }\SpecialCharTok{+}  \CommentTok{\# make discrete}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{title =} \StringTok{"Aviation Emissions in 2019"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL."}\NormalTok{,}
       \AttributeTok{fill =} \StringTok{"Year"}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# nicer label for legend}
  \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-22-1.pdf}

Look closely at the graph. What is the sort order? Neither the 2010 nor the 2019 bars are actually in order. We've asked \texttt{reorder} to do too much. It seems to have sorted by the total of the 2 years, which is a reasonable thing to do in the circumstances. But I think that's hard for the user of the graph to interpret, and I'd like the ordering to be by 2019.

We can do this ordering with factors. First define a vector that is in the order we want, using \texttt{arrange()} to sort it. The \texttt{desc()} reverses the order. Then define a factor version of the state names, and insist that it's in this fixed order. \texttt{factor()} is like \texttt{as.factor()} which we used in the previous chunk of code, but allows these extra parameters.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{state\_order }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{==} \DecValTok{2019}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%}     \CommentTok{\# in year 2019}
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(CO2\_QTY\_TONNES)) }\SpecialCharTok{\%\textgreater{}\%}  \CommentTok{\# descending order}
  \FunctionTok{pull}\NormalTok{(STATE\_NAME) }

\NormalTok{annual\_co2 }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{ordered\_states =} \FunctionTok{factor}\NormalTok{(STATE\_NAME, }
                                 \AttributeTok{levels =}\NormalTok{ state\_order, }\AttributeTok{ordered =} \ConstantTok{TRUE}\NormalTok{))}

\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{2010}\NormalTok{, }\DecValTok{2019}\NormalTok{)), }
       \FunctionTok{aes}\NormalTok{(ordered\_states,}
\NormalTok{           CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{,}
           \AttributeTok{fill =} \FunctionTok{as.factor}\NormalTok{(YEAR))) }\SpecialCharTok{+}  \CommentTok{\# make discrete}
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{title =} \StringTok{"Aviation Emissions"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Ordering by 2019 emissions. Source: EUROCONTROL."}\NormalTok{,}
       \AttributeTok{fill =} \StringTok{"Year"}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# nicer label for legend}
  \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-23-1.pdf}

\hypertarget{chart-facets-more-years-in-the-bar-chart}{%
\subsection{Chart facets, more years in the bar chart}\label{chart-facets-more-years-in-the-bar-chart}}

If you want the reader to compare things, a good rule of thumb is to make sure these things are all in the same graph. We've achieved this for comparisons between years and between countries. However, this is a bit of a squeeze, vertically, while there's lots of empty space. Plus, it doesn't look like this method would easily cope with a third year, say.

\texttt{ggplot} provides a simple way to split charts into `facets', which can sometimes be a way to show variation across a dimension with just a few values (2 or 3 years, say), while aligning the axes in a sensible way. There's a bit of a twist in the notation: you can't just mention a variable name (as you can in \texttt{aes()}), you need either to say \texttt{vars(YEAR)} or use a `formula' notation starting with a tilde \texttt{\textasciitilde{}}, which involves less typing so that's what I've done here. The \texttt{\_wrap} would allow wrapping onto multiple rows, but I just want one row here.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{2010}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2019}\NormalTok{)), }
       \FunctionTok{aes}\NormalTok{(ordered\_states,}
\NormalTok{           CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{)) }\SpecialCharTok{+}  
  \FunctionTok{geom\_col}\NormalTok{() }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{YEAR, }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{title =} \StringTok{"Aviation Emissions"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL."}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-24-1.pdf}

\texttt{facet\_wrap} has given all the x- and y-axes the same matching scale, and not bothered to repeat the y-axis labels. So it's compact. The graph is not bad for comparing relative sizes of the larger States in a given year, and for seeing how the ranking changes. But it's not that easy to compare amounts between years.

However, we can use facets to split in a different way, if we arbitrarily put the States into two groups. Remember that \texttt{{[}\ {]}} is a way to select elements of the vector, in this case the first 19. We could equally have used \texttt{head(state\_order,\ 19)}, but the \texttt{{[}1:19{]}} is a model that is used more often.

We turn off the scale-matching (\texttt{scales\ =\ "free"}), so really it's two separate graphs, but with one piece of code.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{annual\_co2 }\OtherTok{\textless{}{-}}\NormalTok{ annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{size =} \FunctionTok{if\_else}\NormalTok{(ordered\_states }\SpecialCharTok{\%in\%}\NormalTok{ state\_order[}\DecValTok{1}\SpecialCharTok{:}\DecValTok{19}\NormalTok{], }
                        \StringTok{"Larger Emitters"}\NormalTok{, }\StringTok{"Smaller Emitters"}\NormalTok{))}

\FunctionTok{ggplot}\NormalTok{(annual\_co2 }\SpecialCharTok{\%\textgreater{}\%} 
         \FunctionTok{filter}\NormalTok{(YEAR }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\DecValTok{2010}\NormalTok{, }\DecValTok{2015}\NormalTok{, }\DecValTok{2019}\NormalTok{)), }
       \FunctionTok{aes}\NormalTok{(ordered\_states,}
\NormalTok{           CO2\_QTY\_TONNES}\SpecialCharTok{/}\FloatTok{1e6}\NormalTok{,}
           \AttributeTok{fill =} \FunctionTok{as.factor}\NormalTok{(YEAR))) }\SpecialCharTok{+}  
  \FunctionTok{geom\_col}\NormalTok{(}\AttributeTok{position =} \StringTok{"dodge"}\NormalTok{) }\SpecialCharTok{+}
  \FunctionTok{facet\_wrap}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{size, }\AttributeTok{nrow =} \DecValTok{1}\NormalTok{, }\AttributeTok{scales =} \StringTok{"free"}\NormalTok{) }\SpecialCharTok{+} 
  \FunctionTok{labs}\NormalTok{(}\AttributeTok{x =} \StringTok{""}\NormalTok{, }
       \AttributeTok{y =} \FunctionTok{bquote}\NormalTok{(}\SpecialCharTok{\textasciitilde{}}\NormalTok{CO[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{\textasciitilde{}}\StringTok{" (million tonnes)"}\NormalTok{),}
       \AttributeTok{title =} \StringTok{"Aviation Emissions"}\NormalTok{,}
       \AttributeTok{caption =} \StringTok{"Source: EUROCONTROL."}\NormalTok{,}
       \AttributeTok{fill =} \StringTok{"Year"}\NormalTok{) }\SpecialCharTok{+} \CommentTok{\# nicer label for legend}
  \FunctionTok{coord\_flip}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\includegraphics{flights_in_R_files/figure-latex/unnamed-chunk-25-1.pdf}

This certainly allows better comparisons of some of the mid-range emitters, and between years. Assuming you're not after comparison of of Luxembourg and Finland, perhaps this is fit for purpose.

There are many different distributions in flight data that have this long tail challenge: with most of the flights in a few airports, or a few countries, or by a few aircraft types. It's easy enough to switch to a logarithmic scale, but that's then often hard to read. Facets like this are a reasonable alternative, and adaptable.

\hypertarget{exercises-1}{%
\section{Exercises}\label{exercises-1}}

\hypertarget{questions-3}{%
\subsection{Questions}\label{questions-3}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  Plot the bar chart of section \ref{firstsortedbar} with the longest bars at the bottom.
\item
  Plot the bar chart of section \ref{firstsortedbar} without the 3 near-zero entries. (Hints: View the data. Filter on 2019 and choose a threshold.)
\item
  Test the statement in the text that \texttt{aes(...,\ colour=as.factor(YEAR))} gives an outline to the bars.
\item
  Use \texttt{select} and \texttt{!} to remove the \texttt{size} variable again. {[}Hint: Until you're sure it works, don't overwrite your dataset but make a temporary one, eg. start with \texttt{z\ \textless{}-}.{]}
\item
  Read the description of \texttt{geom\_bar} in the help file. In the first bar chart, switch to using \texttt{geom\_bar} instead. {[}Hint: A minor addition to the \texttt{aes()}.{]}
\item
  Save the final faceted bar chart to a png file.
\end{enumerate}

\hypertarget{answers-3}{%
\subsection{Answers}\label{answers-3}}

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\tightlist
\item
  Use reorder(state\_label, -CO2\_QTY\_TONNES).
\item
  Use \texttt{filter(YEAR\ ==\ 2019\ \&\ CO2\_QTY\_TONNES\ \textgreater{}\ 100000)}.
\item
  Did it?
\item
  \texttt{z\ \textless{}-\ annual\_co2\ \%\textgreater{}\%\ select(!size)}, then if it works, replace \texttt{z}.
\item
  Replace \texttt{geom\_col} with \texttt{geom\_bar} and add \texttt{weight\ =} in front of \texttt{CO2\_QTY\_TONNES/1e6}, thus switching it from the \texttt{y} parameter to the \texttt{weight}.
\item
  \texttt{ggsave("graphs/2facet\ co2.png",\ width\ =\ 15,\ height\ =\ 10,\ units\ =\ "cm")} or some other appropriate proportions. Did you save the correct graph? Remember that by default it saves the last one plotted.
\end{enumerate}

\hypertarget{vectors-and-grouping---loops-of-a-sort}{%
\chapter{Vectors and grouping - Loops of a sort}\label{vectors-and-grouping---loops-of-a-sort}}

In the next few chapters we move away from tweaking code for graphs and get more hands-on with manipulating data. With another software language, this might be the time to discuss loops. In a manner of speaking we will be looping, but in a very R way. R does have a `for..next' syntax, but it's a little like the chips on the menu of an Indian restaurant: most of the time you're better off with something else.

\begin{tabular}{l}
\hline
In this chapter, you'll be introduced to:\\
\hline
\\
\hline
\end{tabular}

\hypertarget{vectors}{%
\section{Vectors}\label{vectors}}

We met vectors in passing in Chapter \ref{start}: \texttt{1:50}. We saw other ways to construct them in section \ref{someValues}: \texttt{c(1,\ 5,\ 10)}. But we can do more than just use them for filtering. Many functions in R are `vector friendly', in the sense that they will operate on an entire vector, and return a vector result. This can then be used in another function.

The use of vectors is a sort of looping through a set of values. Or if you prefer the Excel analogy, it's like filling a column of cells with a sequence of values and then creating another with a set of formulas using those vales, but without all the repetitious clicking, dragging and filling.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{7}\NormalTok{) }\SpecialCharTok{+} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3 5 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\SpecialCharTok{:}\DecValTok{4} \SpecialCharTok{+} \DecValTok{1}\SpecialCharTok{:}\DecValTok{2} \CommentTok{\# values of the second vector are recycled}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 2 4 4 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\SpecialCharTok{\^{}}\DecValTok{2} \CommentTok{\# \^{} happens before :}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 2 3 4 5 6 7 8 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\SpecialCharTok{:}\DecValTok{3}\NormalTok{)}\SpecialCharTok{\^{}}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1 4 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{sin}\NormalTok{(pi}\SpecialCharTok{/}\DecValTok{1}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\SpecialCharTok{\%\textgreater{}\%} \FunctionTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{)  }\CommentTok{\# = round(sin(pi/1:4), 3)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 0.000 1.000 0.866 0.707
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{round}\NormalTok{(pi, }\DecValTok{0}\SpecialCharTok{:}\DecValTok{4}\NormalTok{) }\CommentTok{\# vectors can work in surprising places}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 3.0000 3.1000 3.1400 3.1420 3.1416
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{str\_c}\NormalTok{(}\StringTok{"Year\_"}\NormalTok{, }\FunctionTok{unique}\NormalTok{(aviation\_co2}\SpecialCharTok{$}\NormalTok{YEAR))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "Year_2010" "Year_2011" "Year_2012" "Year_2013" "Year_2014" "Year_2015"
##  [7] "Year_2016" "Year_2017" "Year_2018" "Year_2019" "Year_2020"
\end{verbatim}

The examples illustrate there are still some rules of precedence: \texttt{:} is evaluated after \texttt{\^{}}, but before \texttt{+}. They also show `recycling': \texttt{1:4} needs a length 4 vector to be added to it, so the values in \texttt{1:2} are recycled. Strictly speaking, this is happening with the first example (the \texttt{2} is being recycled into a vector of length 3), and also in the last example with ``Year\_''.

If the recycling can't be done neatly, you get an error. {[}Evaluate \texttt{1:4\ +\ 1:3}.{]}

There are plenty of other ways to create simple vectors when you need them.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{50}\NormalTok{, }\AttributeTok{by =} \DecValTok{5}\NormalTok{) }\CommentTok{\# when 10:50 won\textquotesingle{}t do}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 10 15 20 25 30 35 40 45 50
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{rep}\NormalTok{(}\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{) }\CommentTok{\# repeat 3 times}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 4 4 4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{seq.Date}\NormalTok{(}\FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020/1/15"}\NormalTok{), }\FunctionTok{as.Date}\NormalTok{(}\StringTok{"2020/12/15"}\NormalTok{), }\AttributeTok{by =} \StringTok{"month"}\NormalTok{) }\CommentTok{\# ides of 2020}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "2020-01-15" "2020-02-15" "2020-03-15" "2020-04-15" "2020-05-15"
##  [6] "2020-06-15" "2020-07-15" "2020-08-15" "2020-09-15" "2020-10-15"
## [11] "2020-11-15" "2020-12-15"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{letters }\CommentTok{\# \textquotesingle{}letters\textquotesingle{} and \textquotesingle{}LETTERS\textquotesingle{} are built in}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##  [1] "a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s"
## [20] "t" "u" "v" "w" "x" "y" "z"
\end{verbatim}

While vectors and vector-savvy functions are, in a sense, loops with an R flavour, it's probably better to think of them as working `in parallel' calculated all at the same time, rather than one by one as they would be in a `for\ldots next' loop. (TBD)

\hypertarget{exercises-2}{%
\section{Exercises}\label{exercises-2}}

\hypertarget{questions-4}{%
\subsection{Questions}\label{questions-4}}

\begin{itemize}
\tightlist
\item
  What code generates the vector \texttt{2\ 6\ 10\ 14}?
\item
  What code generates the vector \texttt{1\ 2\ 1\ 2\ 1\ 2\ 1\ 2}?
\item
  What code generates the vector \texttt{"A1"\ "B2"\ "C3"\ "D4"\ "E5"}?
\item
  What code generates the vector \texttt{1.000\ 0.500\ 0.333\ 0.250\ 0.200}?
\item
  What code generates the vector \texttt{"1/1"\ "1/2"\ "1/3"\ "1/4"\ "1/5"}?
\end{itemize}

\hypertarget{answers-4}{%
\subsection{Answers}\label{answers-4}}

For the first 5 there are several answers that work. The ones here are relatively compact.

\begin{itemize}
\tightlist
\item
  \texttt{seq(2,\ 14,\ by\ =\ 4)} (or \texttt{c(2,\ 6,\ 10,\ 14)})
\item
  \texttt{rep(1:2,\ 4)}
\item
  \texttt{str\_c(LETTERS{[}1:5{]},\ 1:5)}
\item
  \texttt{1/1:5}
\item
  \texttt{str\_c("1/",\ 1:5)}
\end{itemize}

  \bibliography{book.bib,packages.bib}

\end{document}
