<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Sorting Bars, Saving Graphs, Facets | Picturing Flights with R UNDER CONSTRUCTION</title>
  <meta name="description" content="This book explores both open sources of aviation data and how to use the open tools of R and RStudio to understand that data. It’s intended as a training course and guidebook, with exercises and pointers to more information along the way. — UNDER CONSTRUCTION —" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Sorting Bars, Saving Graphs, Facets | Picturing Flights with R UNDER CONSTRUCTION" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This book explores both open sources of aviation data and how to use the open tools of R and RStudio to understand that data. It’s intended as a training course and guidebook, with exercises and pointers to more information along the way. — UNDER CONSTRUCTION —" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Sorting Bars, Saving Graphs, Facets | Picturing Flights with R UNDER CONSTRUCTION" />
  
  <meta name="twitter:description" content="This book explores both open sources of aviation data and how to use the open tools of R and RStudio to understand that data. It’s intended as a training course and guidebook, with exercises and pointers to more information along the way. — UNDER CONSTRUCTION —" />
  

<meta name="author" content="David Marsh" />


<meta name="date" content="2023-03-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="filter.html"/>
<link rel="next" href="loopsfunctions.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Analysing Flights in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> How to use this book</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#before-you-start"><i class="fa fa-check"></i><b>1.1</b> Before you start</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#ways-to-use-the-material"><i class="fa fa-check"></i><b>1.2</b> Ways to Use the Material</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#structure-of-the-book"><i class="fa fa-check"></i><b>1.3</b> Structure of the book</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i><b>1.4</b> Acknowledgements</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#whats-gone-wrong"><i class="fa fa-check"></i><b>1.5</b> What’s gone wrong?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="start.html"><a href="start.html"><i class="fa fa-check"></i><b>2</b> Getting started with the basic tools of R</a>
<ul>
<li class="chapter" data-level="2.1" data-path="start.html"><a href="start.html#rstudio"><i class="fa fa-check"></i><b>2.1</b> Orientation in RStudio</a></li>
<li class="chapter" data-level="2.2" data-path="start.html"><a href="start.html#first-project"><i class="fa fa-check"></i><b>2.2</b> First project</a></li>
<li class="chapter" data-level="2.3" data-path="start.html"><a href="start.html#first-code"><i class="fa fa-check"></i><b>2.3</b> First code</a></li>
<li class="chapter" data-level="2.4" data-path="start.html"><a href="start.html#packages"><i class="fa fa-check"></i><b>2.4</b> First packages</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="start.html"><a href="start.html#twocolons"><i class="fa fa-check"></i><b>2.4.1</b> Package basics</a></li>
<li class="chapter" data-level="2.4.2" data-path="start.html"><a href="start.html#tidyverse"><i class="fa fa-check"></i><b>2.4.2</b> Tidyverse</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="start.html"><a href="start.html#filetypes"><i class="fa fa-check"></i><b>2.5</b> File types</a></li>
<li class="chapter" data-level="2.6" data-path="start.html"><a href="start.html#whats-gone-wrong-1"><i class="fa fa-check"></i><b>2.6</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="2.7" data-path="start.html"><a href="start.html#test-yourself"><i class="fa fa-check"></i><b>2.7</b> Test yourself</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="start.html"><a href="start.html#questions"><i class="fa fa-check"></i><b>2.7.1</b> Questions</a></li>
<li class="chapter" data-level="2.7.2" data-path="start.html"><a href="start.html#answers"><i class="fa fa-check"></i><b>2.7.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="firstLook.html"><a href="firstLook.html"><i class="fa fa-check"></i><b>3</b> First look at data and CO<sub>2</sub> emissions</a>
<ul>
<li class="chapter" data-level="3.1" data-path="firstLook.html"><a href="firstLook.html#loadco2"><i class="fa fa-check"></i><b>3.1</b> Looking at data: CO<sub>2</sub> Data</a></li>
<li class="chapter" data-level="3.2" data-path="firstLook.html"><a href="firstLook.html#extractfield"><i class="fa fa-check"></i><b>3.2</b> Extracting variables</a></li>
<li class="chapter" data-level="3.3" data-path="firstLook.html"><a href="firstLook.html#someValues"><i class="fa fa-check"></i><b>3.3</b> Extracting a few values</a></li>
<li class="chapter" data-level="3.4" data-path="firstLook.html"><a href="firstLook.html#co2-scatter-plot"><i class="fa fa-check"></i><b>3.4</b> CO<sub>2</sub> Scatter plot</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="firstLook.html"><a href="firstLook.html#first-draft"><i class="fa fa-check"></i><b>3.4.1</b> First draft</a></li>
<li class="chapter" data-level="3.4.2" data-path="firstLook.html"><a href="firstLook.html#improve-the-titles"><i class="fa fa-check"></i><b>3.4.2</b> Improve the titles</a></li>
<li class="chapter" data-level="3.4.3" data-path="firstLook.html"><a href="firstLook.html#statecluster"><i class="fa fa-check"></i><b>3.4.3</b> and with clustering by state</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="firstLook.html"><a href="firstLook.html#whats-gone-wrong-2"><i class="fa fa-check"></i><b>3.5</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="3.6" data-path="firstLook.html"><a href="firstLook.html#test-yourself-1"><i class="fa fa-check"></i><b>3.6</b> Test yourself</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="firstLook.html"><a href="firstLook.html#questions-1"><i class="fa fa-check"></i><b>3.6.1</b> Questions</a></li>
<li class="chapter" data-level="3.6.2" data-path="firstLook.html"><a href="firstLook.html#answers-1"><i class="fa fa-check"></i><b>3.6.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="filter.html"><a href="filter.html"><i class="fa fa-check"></i><b>4</b> Filtering a dataset and refining the CO<sub>2</sub> graph</a>
<ul>
<li class="chapter" data-level="4.1" data-path="filter.html"><a href="filter.html#sequences-of-functions"><i class="fa fa-check"></i><b>4.1</b> Sequences of functions</a></li>
<li class="chapter" data-level="4.2" data-path="filter.html"><a href="filter.html#logicalTests"><i class="fa fa-check"></i><b>4.2</b> Filtering datasets and logical tests</a></li>
<li class="chapter" data-level="4.3" data-path="filter.html"><a href="filter.html#topStates"><i class="fa fa-check"></i><b>4.3</b> Selecting the busiest states</a></li>
<li class="chapter" data-level="4.4" data-path="filter.html"><a href="filter.html#topStatesGraph"><i class="fa fa-check"></i><b>4.4</b> CO<sub>2</sub> graph for the top states</a></li>
<li class="chapter" data-level="4.5" data-path="filter.html"><a href="filter.html#labelco2"><i class="fa fa-check"></i><b>4.5</b> Labelling the CO<sub>2</sub> graph</a></li>
<li class="chapter" data-level="4.6" data-path="filter.html"><a href="filter.html#themes"><i class="fa fa-check"></i><b>4.6</b> A quick word on themes</a></li>
<li class="chapter" data-level="4.7" data-path="filter.html"><a href="filter.html#what-does-the-graph-say-about-co2"><i class="fa fa-check"></i><b>4.7</b> What does the graph say about CO<sub>2</sub>?</a></li>
<li class="chapter" data-level="4.8" data-path="filter.html"><a href="filter.html#whats-gone-wrong-3"><i class="fa fa-check"></i><b>4.8</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="4.9" data-path="filter.html"><a href="filter.html#exercises"><i class="fa fa-check"></i><b>4.9</b> Exercises</a>
<ul>
<li class="chapter" data-level="4.9.1" data-path="filter.html"><a href="filter.html#questions-2"><i class="fa fa-check"></i><b>4.9.1</b> Questions</a></li>
<li class="chapter" data-level="4.9.2" data-path="filter.html"><a href="filter.html#answers-2"><i class="fa fa-check"></i><b>4.9.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sortbars.html"><a href="sortbars.html"><i class="fa fa-check"></i><b>5</b> Sorting Bars, Saving Graphs, Facets</a>
<ul>
<li class="chapter" data-level="5.1" data-path="sortbars.html"><a href="sortbars.html#firstsortedbar"><i class="fa fa-check"></i><b>5.1</b> The simple sorted bar chart - more on CO<sub>2</sub></a></li>
<li class="chapter" data-level="5.2" data-path="sortbars.html"><a href="sortbars.html#saving-a-plot"><i class="fa fa-check"></i><b>5.2</b> Saving a plot</a></li>
<li class="chapter" data-level="5.3" data-path="sortbars.html"><a href="sortbars.html#plotting-more-than-one-year"><i class="fa fa-check"></i><b>5.3</b> Plotting more than one year</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="sortbars.html"><a href="sortbars.html#factors"><i class="fa fa-check"></i><b>5.3.1</b> Staggered bars, and factors</a></li>
<li class="chapter" data-level="5.3.2" data-path="sortbars.html"><a href="sortbars.html#barchartFacets"><i class="fa fa-check"></i><b>5.3.2</b> Chart facets, more years in the bar chart</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="sortbars.html"><a href="sortbars.html#whats-gone-wrong-4"><i class="fa fa-check"></i><b>5.4</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="5.5" data-path="sortbars.html"><a href="sortbars.html#exercises-1"><i class="fa fa-check"></i><b>5.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="sortbars.html"><a href="sortbars.html#questions-3"><i class="fa fa-check"></i><b>5.5.1</b> Questions</a></li>
<li class="chapter" data-level="5.5.2" data-path="sortbars.html"><a href="sortbars.html#answers-3"><i class="fa fa-check"></i><b>5.5.2</b> Answers</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="sortbars.html"><a href="sortbars.html#extended-exercises"><i class="fa fa-check"></i><b>5.6</b> Extended Exercises</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="sortbars.html"><a href="sortbars.html#sortedBarExercises"><i class="fa fa-check"></i><b>5.6.1</b> Questions</a></li>
<li class="chapter" data-level="5.6.2" data-path="sortbars.html"><a href="sortbars.html#co2hints"><i class="fa fa-check"></i><b>5.6.2</b> Hints</a></li>
<li class="chapter" data-level="5.6.3" data-path="sortbars.html"><a href="sortbars.html#answers-4"><i class="fa fa-check"></i><b>5.6.3</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="loopsfunctions.html"><a href="loopsfunctions.html"><i class="fa fa-check"></i><b>6</b> Loops, functions and SID data</a>
<ul>
<li class="chapter" data-level="6.1" data-path="loopsfunctions.html"><a href="loopsfunctions.html#vectors-and-lists"><i class="fa fa-check"></i><b>6.1</b> Vectors and Lists</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="loopsfunctions.html"><a href="loopsfunctions.html#exercises-2"><i class="fa fa-check"></i><b>6.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="loopsfunctions.html"><a href="loopsfunctions.html#functions-and-loops"><i class="fa fa-check"></i><b>6.2</b> Functions and Loops</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="loopsfunctions.html"><a href="loopsfunctions.html#first-function-bi-directional-airport-pairs"><i class="fa fa-check"></i><b>6.2.1</b> First function: bi-directional airport pairs</a></li>
<li class="chapter" data-level="6.2.2" data-path="loopsfunctions.html"><a href="loopsfunctions.html#looping-with-functions"><i class="fa fa-check"></i><b>6.2.2</b> Looping with functions</a></li>
<li class="chapter" data-level="6.2.3" data-path="loopsfunctions.html"><a href="loopsfunctions.html#exercises-3"><i class="fa fa-check"></i><b>6.2.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="loopsfunctions.html"><a href="loopsfunctions.html#country-data"><i class="fa fa-check"></i><b>6.3</b> Country data</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="loopsfunctions.html"><a href="loopsfunctions.html#loadonemonthly"><i class="fa fa-check"></i><b>6.3.1</b> Load one country’s monthly data</a></li>
<li class="chapter" data-level="6.3.2" data-path="loopsfunctions.html"><a href="loopsfunctions.html#loadmultiplemonthlies"><i class="fa fa-check"></i><b>6.3.2</b> Load monthly data for multiple countries</a></li>
<li class="chapter" data-level="6.3.3" data-path="loopsfunctions.html"><a href="loopsfunctions.html#loadMultipleFiles"><i class="fa fa-check"></i><b>6.3.3</b> Load multiple files</a></li>
<li class="chapter" data-level="6.3.4" data-path="loopsfunctions.html"><a href="loopsfunctions.html#exercises-4"><i class="fa fa-check"></i><b>6.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="loopsfunctions.html"><a href="loopsfunctions.html#whats-gone-wrong-5"><i class="fa fa-check"></i><b>6.4</b> What’s gone wrong?</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="groups.html"><a href="groups.html"><i class="fa fa-check"></i><b>7</b> Looping with groups</a>
<ul>
<li class="chapter" data-level="7.1" data-path="groups.html"><a href="groups.html#summarise"><i class="fa fa-check"></i><b>7.1</b> Summarising</a></li>
<li class="chapter" data-level="7.2" data-path="groups.html"><a href="groups.html#dates"><i class="fa fa-check"></i><b>7.2</b> Dates</a></li>
<li class="chapter" data-level="7.3" data-path="groups.html"><a href="groups.html#mutate"><i class="fa fa-check"></i><b>7.3</b> Adding variables</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="maps.html"><a href="maps.html"><i class="fa fa-check"></i><b>8</b> Maps and geographic data</a>
<ul>
<li class="chapter" data-level="8.1" data-path="maps.html"><a href="maps.html#spatialFeatures"><i class="fa fa-check"></i><b>8.1</b> Spatial features</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="maps.html"><a href="maps.html#map-exercises"><i class="fa fa-check"></i><b>8.1.1</b> Map Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="maps.html"><a href="maps.html#RnDArchive"><i class="fa fa-check"></i><b>8.2</b> Using the R&amp;D Data Archive</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="maps.html"><a href="maps.html#flight-summaries"><i class="fa fa-check"></i><b>8.2.1</b> Flight Summaries</a></li>
<li class="chapter" data-level="8.2.2" data-path="maps.html"><a href="maps.html#airspaceData"><i class="fa fa-check"></i><b>8.2.2</b> Airspace structure</a></li>
<li class="chapter" data-level="8.2.3" data-path="maps.html"><a href="maps.html#flight-profiles"><i class="fa fa-check"></i><b>8.2.3</b> Flight profiles</a></li>
<li class="chapter" data-level="8.2.4" data-path="maps.html"><a href="maps.html#exercises-5"><i class="fa fa-check"></i><b>8.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="maps.html"><a href="maps.html#mapRegions"><i class="fa fa-check"></i><b>8.3</b> Countries and regions</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="maps.html"><a href="maps.html#mapCountries"><i class="fa fa-check"></i><b>8.3.1</b> Countries</a></li>
<li class="chapter" data-level="8.3.2" data-path="maps.html"><a href="maps.html#mapAirspace"><i class="fa fa-check"></i><b>8.3.2</b> Airspace</a></li>
<li class="chapter" data-level="8.3.3" data-path="maps.html"><a href="maps.html#exercises-6"><i class="fa fa-check"></i><b>8.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="maps.html"><a href="maps.html#mapAirports"><i class="fa fa-check"></i><b>8.4</b> Airports</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="maps.html"><a href="maps.html#mapOverlapLabels"><i class="fa fa-check"></i><b>8.4.1</b> Overlapping labels on maps</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="maps.html"><a href="maps.html#mapRoutes"><i class="fa fa-check"></i><b>8.5</b> Routes</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="maps.html"><a href="maps.html#great-circle-routes"><i class="fa fa-check"></i><b>8.5.1</b> Great Circle Routes</a></li>
<li class="chapter" data-level="8.5.2" data-path="maps.html"><a href="maps.html#fasterGeo"><i class="fa fa-check"></i><b>8.5.2</b> Need for Speed</a></li>
<li class="chapter" data-level="8.5.3" data-path="maps.html"><a href="maps.html#trueRoutes"><i class="fa fa-check"></i><b>8.5.3</b> True Routes</a></li>
<li class="chapter" data-level="8.5.4" data-path="maps.html"><a href="maps.html#exercises-7"><i class="fa fa-check"></i><b>8.5.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="maps.html"><a href="maps.html#mapDensity"><i class="fa fa-check"></i><b>8.6</b> Density of routes</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="maps.html"><a href="maps.html#exercises-8"><i class="fa fa-check"></i><b>8.6.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="maps.html"><a href="maps.html#what-has-gone-wrong"><i class="fa fa-check"></i><b>8.7</b> What has gone wrong?</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="splitparse.html"><a href="splitparse.html"><i class="fa fa-check"></i><b>9</b> NOTAMS: Splitting and parsing strings</a>
<ul>
<li class="chapter" data-level="9.1" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-into-many"><i class="fa fa-check"></i><b>9.1</b> Splitting a column into many</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="splitparse.html"><a href="splitparse.html#splitatcharacter"><i class="fa fa-check"></i><b>9.1.1</b> Splitting a column at a character</a></li>
<li class="chapter" data-level="9.1.2" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-at-a-regular-expression"><i class="fa fa-check"></i><b>9.1.2</b> Splitting a column at a regular expression</a></li>
<li class="chapter" data-level="9.1.3" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-at-an-either-or"><i class="fa fa-check"></i><b>9.1.3</b> Splitting a column at an either-or</a></li>
<li class="chapter" data-level="9.1.4" data-path="splitparse.html"><a href="splitparse.html#exercises-9"><i class="fa fa-check"></i><b>9.1.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="splitparse.html"><a href="splitparse.html#listcolumns"><i class="fa fa-check"></i><b>9.2</b> List columns</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="splitparse.html"><a href="splitparse.html#splitting-a-field-into-a-list"><i class="fa fa-check"></i><b>9.2.1</b> Splitting a field into a list</a></li>
<li class="chapter" data-level="9.2.2" data-path="splitparse.html"><a href="splitparse.html#more-realistic-splitting"><i class="fa fa-check"></i><b>9.2.2</b> More realistic splitting</a></li>
<li class="chapter" data-level="9.2.3" data-path="splitparse.html"><a href="splitparse.html#manipulate-fields-in-rows"><i class="fa fa-check"></i><b>9.2.3</b> Manipulate fields in rows</a></li>
<li class="chapter" data-level="9.2.4" data-path="splitparse.html"><a href="splitparse.html#exercises-10"><i class="fa fa-check"></i><b>9.2.4</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>10</b> Glossary</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Picturing Flights with R UNDER CONSTRUCTION</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sortbars" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Sorting Bars, Saving Graphs, Facets<a href="sortbars.html#sortbars" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>While nothing beats a well hand-crafted chart, there are times when you want to just run the code and get a quick update, as a .png say. In this chapter we see how to do a classic sorted-bar chart and to save it to a file for use elsewhere. We need slightly different methods for simple bar charts and more complex ones.</p>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">In this chapter, you’ll be introduced to:</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>geom_col()</code>, <code>dodge</code>, <code>reorder()</code>, <code>ggsave()</code>, <code>as.factor()</code>, <code>factor()</code>, <code>arrange()</code>, <code>facet_wrap()</code>, <code>select</code>, plots pane</td>
</tr>
</tbody>
</table>
<div id="firstsortedbar" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> The simple sorted bar chart - more on CO<sub>2</sub><a href="sortbars.html#firstsortedbar" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A classic visualisation is the bar chart, sorted from longest to shortest. With <code>ggplot</code> there are a couple of ways to get a bar chart.</p>
<ul>
<li>If you want <code>ggplot</code> to count the rows for you, and use the counts to give the length of the bars, use <code>geom_bar</code>.</li>
<li>Here we already have values for the length of the bar, so we use <code>geom_col</code> instead (for ‘column’ chart).</li>
</ul>
<p>For the simplest bar charts, there is a quick way to get the order you want. In place of <code>state_label</code> for the x-axis, you write <code>reorder(state_label, CO2_QTY_TONNES)</code>, the second being the variable to sort by. If you find the bars a bit top-heavy, put a <code>-</code> in front of <code>CO2_QTY_...</code> to reverse the order.</p>
<p>The final novelty in this graph is <code>coord_flip()</code>. Forty-something State names is a lot of text to cram onto the horizontal axis. So we flip the axes. You’ll need to decide if this trick works where you want to use the graph. We’ll see other ways to separate the labels on the axes at the end of section <a href="sortbars.html#barchartFacets">5.3.2</a>.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="sortbars.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb45-2"><a href="sortbars.html#cb45-2" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(YEAR <span class="sc">==</span> <span class="dv">2019</span>), </span>
<span id="cb45-3"><a href="sortbars.html#cb45-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="fu">reorder</span>(state_label, CO2_QTY_TONNES),</span>
<span id="cb45-4"><a href="sortbars.html#cb45-4" aria-hidden="true" tabindex="-1"></a>           CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>)) <span class="sc">+</span></span>
<span id="cb45-5"><a href="sortbars.html#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb45-6"><a href="sortbars.html#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb45-7"><a href="sortbars.html#cb45-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb45-8"><a href="sortbars.html#cb45-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Aviation Emissions in 2019&quot;</span>,</span>
<span id="cb45-9"><a href="sortbars.html#cb45-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL.&quot;</span>) <span class="sc">+</span></span>
<span id="cb45-10"><a href="sortbars.html#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>If you were to google ‘ggplot ordered bar chart’, you might find references to ‘factors’. That becomes necessary, in place of <code>reorder</code>, when the charts are more complicated. We’ll look at that in section <a href="sortbars.html#factors">5.3.1</a>.</p>
</div>
<div id="saving-a-plot" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Saving a plot<a href="sortbars.html#saving-a-plot" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>You might be looking at the bar chart and thinking that it’s the wrong proportions for your need (portrait rather than landscape, or vice versa) or you might be thinking the axis labels are still a bit squashed together.</p>
<p>The proportions on your screen will depend on a number of things including the space you have allowed for the ‘Plots’ window. Now, the plots window has an export button which you could use. It allows for re-sizing, but that means you have to do the same manual intervention each time.</p>
<p>We prefer to use <code>ggsave()</code> to save the most-recent plot, and at the same time set the aspect ratio. Usually it’s worth doing this before working too much on the font sizes, since you don’t really know if there’s a problem until you’ve seen the png.</p>
<p>Finally, we use the <code>graphs</code> folder we created for the project. Square seems about right for this graph (the width includes the axis text); and having one of the dimensions around 15cm also seems to produce png that are good enough for reports and slides without being too big a file.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="sortbars.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;graphs/FirstSortedBars.png&quot;</span>, <span class="at">width =</span> <span class="dv">15</span>, <span class="at">height =</span> <span class="dv">15</span>, <span class="at">units =</span> <span class="st">&quot;cm&quot;</span>)</span></code></pre></div>
</div>
<div id="plotting-more-than-one-year" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Plotting more than one year<a href="sortbars.html#plotting-more-than-one-year" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>I can think of four ways to plot more than one year, and there are no doubt more than that:</p>
<ol style="list-style-type: decimal">
<li>as staggered bars, though we probably will have to work hard to make enough space;</li>
<li>as ‘facets’, creating one sub-plot per year;</li>
<li>as a few graphs, merged and aligned using an dedicated package like <code>cowplot</code>;</li>
<li>as multiple graphs using a loop</li>
</ol>
<p>Number (3) is particularly useful for combining graphs of different variables, but it’s a bit heavy for our purposes here. We’ll deal with (4) in section (TBD) when we look at loops. The first two we will demonstrate in the next sections.</p>
<div id="factors" class="section level3 hasAnchor" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Staggered bars, and factors<a href="sortbars.html#factors" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We took some shortcuts in section <a href="sortbars.html#firstsortedbar">5.1</a>, which will need sorting out for the staggered bars. First we need to choose a couple of years, since there certainly isn’t room for more than two. That’s a filter that we’ve seen before. Secondly, we used <code>state_label</code> before because it was prettier, but this only exists for 2019, so we have to go back to using <code>STATE_NAME</code>. It’s probably time to turn this name into title case once and for all.</p>
<p>The separation by year is done in the aesthetic <code>aes()</code> as you might expect. We want the bars to be different colours by year. In this case it’s the <code>fill</code> that we specify; <code>colour</code> would add an outline to the bars. To get the bars side by side we set the <code>position = "dodge"</code> parameter in <code>geom_col()</code>.</p>
<p>The least obvious, final step is that ‘year’ needs to be a discrete variable, whereas currently it’s <code>num</code> which is a continuous number. Slightly oddly, <code>as.integer()</code> doesn’t work: it’s still treated as continuous by <code>ggplot</code>, presumably because there are potentially still quite a lot of integers.</p>
<p>We could convert to a string with <code>as.character</code>, but we need to start using factors, so let’s do that here.</p>
<p>Factors in R were originally a way to save space with character variables in a dataset. In <code>annual_co2</code> for example, rather than store ‘ALBANIA’ 10 times, for each row, a factor would give <code>ALBANIA</code> a numeric code and store that. The character strings become the levels. [Try <code>z &lt;- as.factor(annual_co2$STATE_NAME)</code> and see what is said for z in the environment pane. <code>rm(z)</code> to tidy up, if you wish.]</p>
<p>For this example, we’ll convert <code>YEAR</code> on the fly, with an <code>as.factor</code> in the <code>aes()</code> call.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="sortbars.html#cb47-1" aria-hidden="true" tabindex="-1"></a>annual_co2 <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb47-2"><a href="sortbars.html#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">STATE_NAME =</span> <span class="fu">str_to_title</span>(STATE_NAME))</span>
<span id="cb47-3"><a href="sortbars.html#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="sortbars.html#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb47-5"><a href="sortbars.html#cb47-5" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2019</span>)), </span>
<span id="cb47-6"><a href="sortbars.html#cb47-6" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="fu">reorder</span>(STATE_NAME, CO2_QTY_TONNES),</span>
<span id="cb47-7"><a href="sortbars.html#cb47-7" aria-hidden="true" tabindex="-1"></a>           CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>,</span>
<span id="cb47-8"><a href="sortbars.html#cb47-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="fu">as.factor</span>(YEAR))) <span class="sc">+</span>  <span class="co"># make discrete</span></span>
<span id="cb47-9"><a href="sortbars.html#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="sc">+</span> <span class="co"># dodge = side-by-side</span></span>
<span id="cb47-10"><a href="sortbars.html#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb47-11"><a href="sortbars.html#cb47-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb47-12"><a href="sortbars.html#cb47-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Aviation Emissions in 2019&quot;</span>,</span>
<span id="cb47-13"><a href="sortbars.html#cb47-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL.&quot;</span>,</span>
<span id="cb47-14"><a href="sortbars.html#cb47-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Year&quot;</span>) <span class="sc">+</span> <span class="co"># nicer label for legend</span></span>
<span id="cb47-15"><a href="sortbars.html#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>Before we go any further, those long state names are leaving the graph with a lot of wasted white space. Hoping that no-one will be offended, we will shorten some of the names. In doing so, we demonstrate that you can use a <code>|&gt;</code> pipe within a function call (here making a series of adjustments to <code>STATE_NAME</code>). First the <code>str_to_title()</code> that we’ve already used. Then on the output of that, using <code>str_replace()</code> we look for the pattern <code>",.*"</code> and replace it with <code>""</code> (ie remove it). There’s a lot more on patterns in chapter <a href="splitparse.html#splitparse">9</a>. For the moment just accept that this finds any substring starting with “,” and followed by any number of other characters; <code>"."</code> is a wild card for any character, <code>"*"</code> means any number of times. So we remove everything from a comma onwards.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="sortbars.html#cb48-1" aria-hidden="true" tabindex="-1"></a>annual_co2 <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb48-2"><a href="sortbars.html#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">STATE_NAME =</span> STATE_NAME <span class="sc">|&gt;</span> </span>
<span id="cb48-3"><a href="sortbars.html#cb48-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_to_title</span>() <span class="sc">|&gt;</span> </span>
<span id="cb48-4"><a href="sortbars.html#cb48-4" aria-hidden="true" tabindex="-1"></a>           <span class="fu">str_replace</span>(<span class="st">&quot;,.*&quot;</span>, <span class="st">&quot;&quot;</span>)) </span>
<span id="cb48-5"><a href="sortbars.html#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="sortbars.html#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb48-7"><a href="sortbars.html#cb48-7" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2019</span>)), </span>
<span id="cb48-8"><a href="sortbars.html#cb48-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="fu">reorder</span>(STATE_NAME, CO2_QTY_TONNES),</span>
<span id="cb48-9"><a href="sortbars.html#cb48-9" aria-hidden="true" tabindex="-1"></a>           CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>,</span>
<span id="cb48-10"><a href="sortbars.html#cb48-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="fu">as.factor</span>(YEAR))) <span class="sc">+</span>  <span class="co"># make discrete</span></span>
<span id="cb48-11"><a href="sortbars.html#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="sc">+</span> <span class="co"># dodge = side-by-side</span></span>
<span id="cb48-12"><a href="sortbars.html#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb48-13"><a href="sortbars.html#cb48-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb48-14"><a href="sortbars.html#cb48-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Aviation Emissions in 2019&quot;</span>,</span>
<span id="cb48-15"><a href="sortbars.html#cb48-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL.&quot;</span>,</span>
<span id="cb48-16"><a href="sortbars.html#cb48-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Year&quot;</span>) <span class="sc">+</span> <span class="co"># nicer label for legend</span></span>
<span id="cb48-17"><a href="sortbars.html#cb48-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>That gives much more space to the bars, but look closely at the graph. What is the sort order? Neither the 2010 nor the 2019 bars are actually in order. We’ve asked <code>reorder</code> to do too much. It seems to have sorted by the total of the 2 years, which is a reasonable thing to do in the circumstances. But I think that’s hard for the user of the graph to interpret, and I’d like the ordering to be by 2019.</p>
<p>We can do this ordering with factors. First define a vector that is in the order we want, using <code>arrange()</code> to sort it. The <code>desc()</code> reverses the order. Then define a factor version of the state names, and insist that it’s in this fixed order. <code>factor()</code> is like <code>as.factor()</code> which we used in the previous chunk of code, but allows these extra parameters.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="sortbars.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the state names in the specific order that we want</span></span>
<span id="cb49-2"><a href="sortbars.html#cb49-2" aria-hidden="true" tabindex="-1"></a>state_order <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb49-3"><a href="sortbars.html#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">==</span> <span class="dv">2019</span>) <span class="sc">|&gt;</span>     <span class="co"># in year 2019</span></span>
<span id="cb49-4"><a href="sortbars.html#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(CO2_QTY_TONNES)) <span class="sc">|&gt;</span>  <span class="co"># descending order</span></span>
<span id="cb49-5"><a href="sortbars.html#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(STATE_NAME) </span>
<span id="cb49-6"><a href="sortbars.html#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="sortbars.html#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create an ordered factor with this</span></span>
<span id="cb49-8"><a href="sortbars.html#cb49-8" aria-hidden="true" tabindex="-1"></a>annual_co2 <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb49-9"><a href="sortbars.html#cb49-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ordered_states =</span> <span class="fu">factor</span>(STATE_NAME, </span>
<span id="cb49-10"><a href="sortbars.html#cb49-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">levels =</span> state_order, <span class="at">ordered =</span> <span class="cn">TRUE</span>))</span>
<span id="cb49-11"><a href="sortbars.html#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="sortbars.html#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb49-13"><a href="sortbars.html#cb49-13" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2019</span>)), </span>
<span id="cb49-14"><a href="sortbars.html#cb49-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(ordered_states,</span>
<span id="cb49-15"><a href="sortbars.html#cb49-15" aria-hidden="true" tabindex="-1"></a>           CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>,</span>
<span id="cb49-16"><a href="sortbars.html#cb49-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="fu">as.factor</span>(YEAR))) <span class="sc">+</span>  <span class="co"># make discrete</span></span>
<span id="cb49-17"><a href="sortbars.html#cb49-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="sc">+</span></span>
<span id="cb49-18"><a href="sortbars.html#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb49-19"><a href="sortbars.html#cb49-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb49-20"><a href="sortbars.html#cb49-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Aviation Emissions&quot;</span>,</span>
<span id="cb49-21"><a href="sortbars.html#cb49-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Ordering by 2019 emissions. Source: EUROCONTROL.&quot;</span>,</span>
<span id="cb49-22"><a href="sortbars.html#cb49-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Year&quot;</span>) <span class="sc">+</span> <span class="co"># nicer label for legend</span></span>
<span id="cb49-23"><a href="sortbars.html#cb49-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>If that seems like a fair bit of work, it’s worth it to make the chart easier for the reader. And it’s also a pattern you can use and re-use: create the names in the order you want, create a factor for this, and then use the factor for the x-axis in the bar chart.</p>
</div>
<div id="barchartFacets" class="section level3 hasAnchor" number="5.3.2">
<h3><span class="header-section-number">5.3.2</span> Chart facets, more years in the bar chart<a href="sortbars.html#barchartFacets" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>If you want the reader to compare things, a good rule of thumb is to make sure these things are all in the same graph. We’ve achieved this for comparisons between years and between countries. However, this is a bit of a squeeze, vertically, while there’s lots of empty space. Plus, it doesn’t look like this method would easily cope with a third year, say.</p>
<p><code>ggplot</code> provides a simple way to split charts into ‘facets’, which can sometimes be a way to show variation across a dimension with just a few values (2 or 3 years, say), while aligning the axes in a sensible way. There’s a bit of a twist in the notation: you can’t just mention a variable name (as you can in <code>aes()</code>), you need either to say <code>vars(YEAR)</code> or use a ‘formula’ notation starting with a tilde <code>~</code>, which involves less typing so that’s what I’ve done here. The <code>_wrap</code> in <code>facet_wrap</code> would allow wrapping onto multiple rows for more years, but I just want one row here, so <code>nrow = 1</code>.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="sortbars.html#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb50-2"><a href="sortbars.html#cb50-2" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2015</span>, <span class="dv">2019</span>)), </span>
<span id="cb50-3"><a href="sortbars.html#cb50-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(ordered_states,</span>
<span id="cb50-4"><a href="sortbars.html#cb50-4" aria-hidden="true" tabindex="-1"></a>           CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>)) <span class="sc">+</span>  </span>
<span id="cb50-5"><a href="sortbars.html#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb50-6"><a href="sortbars.html#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>YEAR, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="co"># one facet per year, all on one row</span></span>
<span id="cb50-7"><a href="sortbars.html#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb50-8"><a href="sortbars.html#cb50-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb50-9"><a href="sortbars.html#cb50-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Aviation Emissions&quot;</span>,</span>
<span id="cb50-10"><a href="sortbars.html#cb50-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL.&quot;</span>) <span class="sc">+</span> </span>
<span id="cb50-11"><a href="sortbars.html#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p><code>facet_wrap</code> has given all the x- and y-axes the same matching scale, and not bothered to repeat the y-axis labels. So it’s compact. The graph is not bad for comparing relative sizes of the larger States in a given year, and for seeing how the ranking changes. But it’s not that easy to compare amounts between years.</p>
<p>However, we can use facets to split in a different way, if we arbitrarily put the States into two groups. Remember that <code>[ ]</code> is a way to select elements of the vector, in this case the first 19. We could equally have used <code>head(state_order, 19)</code>, but the <code>[1:19]</code> is a pattern that is used more often.</p>
<p>We turn off the scale-matching (<code>scales = "free"</code>), so really it’s two separate graphs, but with one piece of code.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="sortbars.html#cb51-1" aria-hidden="true" tabindex="-1"></a>annual_co2 <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb51-2"><a href="sortbars.html#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">size =</span> <span class="fu">if_else</span>(ordered_states <span class="sc">%in%</span> state_order[<span class="dv">1</span><span class="sc">:</span><span class="dv">19</span>], </span>
<span id="cb51-3"><a href="sortbars.html#cb51-3" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;Larger Emitters&quot;</span>, <span class="st">&quot;Smaller Emitters&quot;</span>))</span>
<span id="cb51-4"><a href="sortbars.html#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="sortbars.html#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb51-6"><a href="sortbars.html#cb51-6" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(YEAR <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2010</span>, <span class="dv">2015</span>, <span class="dv">2019</span>)), </span>
<span id="cb51-7"><a href="sortbars.html#cb51-7" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(ordered_states,</span>
<span id="cb51-8"><a href="sortbars.html#cb51-8" aria-hidden="true" tabindex="-1"></a>           CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>,</span>
<span id="cb51-9"><a href="sortbars.html#cb51-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="fu">as.factor</span>(YEAR))) <span class="sc">+</span>  </span>
<span id="cb51-10"><a href="sortbars.html#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="sc">+</span></span>
<span id="cb51-11"><a href="sortbars.html#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>size, <span class="at">nrow =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="sc">+</span> </span>
<span id="cb51-12"><a href="sortbars.html#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb51-13"><a href="sortbars.html#cb51-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb51-14"><a href="sortbars.html#cb51-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Aviation Emissions&quot;</span>,</span>
<span id="cb51-15"><a href="sortbars.html#cb51-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL.&quot;</span>,</span>
<span id="cb51-16"><a href="sortbars.html#cb51-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Year&quot;</span>) <span class="sc">+</span> <span class="co"># nicer label for legend</span></span>
<span id="cb51-17"><a href="sortbars.html#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>This certainly allows better comparisons of some of the mid-range emitters, and between years. Assuming you’re not after comparison of of Luxembourg and Finland, perhaps this is fit for purpose.</p>
<p>There are many different distributions in flight data that have this long tail challenge: with most of the flights in a few airports, or a few countries, or by a few aircraft types. It’s easy enough to switch to a logarithmic scale, but that’s then often hard to read. Facets like this are a reasonable alternative, and adaptable.</p>
</div>
</div>
<div id="whats-gone-wrong-4" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> What’s gone wrong?<a href="sortbars.html#whats-gone-wrong-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>If your saved .png file seems very large, check that you specified the units. <code>ggsave</code> defaults to inches.</p>
<p>If your axis labels are on the wrong axis, remember that <code>coord_flip</code> will affect these.</p>
</div>
<div id="exercises-1" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Exercises<a href="sortbars.html#exercises-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="questions-3" class="section level3 hasAnchor" number="5.5.1">
<h3><span class="header-section-number">5.5.1</span> Questions<a href="sortbars.html#questions-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Plot the bar chart of section <a href="sortbars.html#firstsortedbar">5.1</a> with the longest bars at the bottom.</li>
<li>Plot the bar chart of section <a href="sortbars.html#firstsortedbar">5.1</a> without the 3 near-zero entries. (Hints: View the data, <code>View()</code>. Filter on 2019 and choose a threshold.)</li>
<li>Test the statement in the text that <code>aes(..., colour=as.factor(YEAR))</code> gives an outline to the bars.</li>
<li>Use <code>select</code> and <code>!</code> to remove the <code>size</code> variable again. (Hint: Until you’re sure it works, don’t overwrite your dataset but make a temporary one, eg. start with <code>z &lt;-</code>.)</li>
<li>Read the description of <code>geom_bar</code> in the help file. In the first bar chart, switch to using <code>geom_bar</code> instead - to get the same results. (Hint: A minor addition to the <code>aes()</code>.)</li>
<li>Save the final faceted bar chart to a png file.</li>
</ol>
</div>
<div id="answers-3" class="section level3 hasAnchor" number="5.5.2">
<h3><span class="header-section-number">5.5.2</span> Answers<a href="sortbars.html#answers-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Use reorder(state_label, -CO2_QTY_TONNES).</li>
<li>Use <code>filter(YEAR == 2019 &amp; CO2_QTY_TONNES &gt; 100000)</code>.</li>
<li>Did it?</li>
<li><code>z &lt;- annual_co2 |&gt; select(!size)</code>, then if it works, replace <code>z</code>.</li>
<li>Replace <code>geom_col</code> with <code>geom_bar</code> and add <code>weight =</code> in front of <code>CO2_QTY_TONNES/1e6</code>, thus switching it from the <code>y</code> parameter to the <code>weight</code>.</li>
<li><code>ggsave("graphs/2facet co2.png", width = 15, height = 10, units = "cm")</code> or some other appropriate proportions. Did you save the correct graph? Remember that by default it saves the last one plotted.</li>
</ol>
</div>
</div>
<div id="extended-exercises" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> Extended Exercises<a href="sortbars.html#extended-exercises" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In chapters <a href="firstLook.html#firstLook">3</a> to <a href="sortbars.html#sortbars">5</a> we’ve covered some basics of the R language, seen through the process of building graphs of some emissions data. Before moving on to new concepts, you might like to try some extended exercises.</p>
<p>These do not introduce any new functions, but they might use new parameters for functions that you’ve already seen. So a good place to start if you’re stuck is the help file for the functions that you know about. If that doesn’t work, then there are some hints in section <a href="sortbars.html#co2hints">5.6.2</a>, deliberately placed slightly separate from the questions!</p>
<p>This book also has a search function, for finding your way back to relevant sections - see the magnifying glass top left. Up and down arrows move from one find to the next.</p>
<p>It’s good practice to periodically ‘clean’ your environment, that is, to remove all the data saved in it. This is essential before testing, because you often find that you’re relying on something that has been changed as you tweak and improve the code. Click the broom icon in the environment pane before you start the exercises.</p>
<div id="sortedBarExercises" class="section level3 hasAnchor" number="5.6.1">
<h3><span class="header-section-number">5.6.1</span> Questions<a href="sortbars.html#sortedBarExercises" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Starting from the final graph in chapter <a href="filter.html#labelco2">4.5</a>, move the label to 2015 and set the colour of the label to black.</li>
<li>Building on (1) plot the 6 states with fewest flights in 2010, but which had more than 10,000 flights. There’s a bit of overlap, so use a different shape for each one.</li>
<li>(Harder) Plot the monthly emissions for France from 2015 onwards as a bar chart. We haven’t done dates yet, so use a character string for the axis labels. Instead of rotating the plot, rotate the x-axis labels (search “ggplot rotate axis label”).</li>
<li>(Harder) Plot line charts of daily flights at 3 major airports in Europe, Istanbul (LTFM), Frankfurt (EDDF) and Paris Charles-de-Gaulle (LFPG) from 2018 onwards. Use the ‘airport traffic’ data set from <a href="https://ansperformance.eu/data/">Eurocontrol</a>.</li>
</ol>
</div>
<div id="co2hints" class="section level3 hasAnchor" number="5.6.2">
<h3><span class="header-section-number">5.6.2</span> Hints<a href="sortbars.html#co2hints" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>If you’re starting from a ‘clean’ environment, you will need to load the data and re-create <code>top_states</code>. Search in this book for <code>load(</code> and <code>top_states</code>.</li>
<li>Mostly a question of filtering. Don’t forget to check the text of your graph when it’s done. The help for <code>geom_point</code> lists which aesthetics are understood, so will help you find the parameter name for changing shape (in this case, it’s the obvious answer).</li>
<li>You need to go back to the code that loads the original excel file. You’ll need to <code>mutate</code> to create a new variable combining the year and month strings <code>str_c</code> (or <code>paste</code>), but you need to put this inside an <code>if else</code> to treat 10-12 different to the other months, or the text won’t sort correctly. Your search should lead you to the ggplot phrase <code>+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5))</code>.
In the end, it’s an ugly chart but let’s not worry too much about that.</li>
<li>A right-click on the download button on the website should give you the file address that you need to substitute into the code used when loading the CO<sub>2</sub> data (see <a href="firstLook.html#loadco2">3.1</a>). It’s a large dataset, so you might want to filter as you load the file. Using the 4-letter code is easier than trying to get the right name. The fields you need are <code>APT_CODE</code> and <code>YEAR</code>. Remember the <code>%in%</code> that we used earlier. Use the ‘NM’ counts; see ‘airport data’ in the glossary for a discussion of why there are two sets of statistics.</li>
</ol>
</div>
<div id="answers-4" class="section level3 hasAnchor" number="5.6.3">
<h3><span class="header-section-number">5.6.3</span> Answers<a href="sortbars.html#answers-4" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>This exercise is really a lesson in assembling the code into one sequence - it gets a bit broken up in the book. You should probably include your <code>library(tidyverse)</code> statement at the top, for really complete code.</li>
</ol>
<p>Notice that we have two <code>colour</code> aesthetics: the default one which is by <code>YEAR</code> and one specifically for the <code>geom_text_repel</code>.</p>
<p>The other catch is that, because the colour of the text is constant, it appears outside the <code>aes()</code>, not inside.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="sortbars.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the dataset</span></span>
<span id="cb52-2"><a href="sortbars.html#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/annual_co2.rda&quot;</span>)</span>
<span id="cb52-3"><a href="sortbars.html#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="sortbars.html#cb52-4" aria-hidden="true" tabindex="-1"></a>top_states <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span></span>
<span id="cb52-5"><a href="sortbars.html#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">==</span> <span class="dv">2019</span>) <span class="sc">|&gt;</span>     <span class="co"># top in year 2019</span></span>
<span id="cb52-6"><a href="sortbars.html#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(TF, <span class="at">n =</span> <span class="dv">8</span>) <span class="sc">|&gt;</span>  <span class="co"># top 8 </span></span>
<span id="cb52-7"><a href="sortbars.html#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(STATE_NAME) </span>
<span id="cb52-8"><a href="sortbars.html#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="sortbars.html#cb52-9" aria-hidden="true" tabindex="-1"></a>annual_co2 <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb52-10"><a href="sortbars.html#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state_label =</span> <span class="fu">if_else</span>(YEAR <span class="sc">==</span> <span class="dv">2015</span>, <span class="fu">str_to_title</span>(STATE_NAME), <span class="st">&quot;&quot;</span>))</span>
<span id="cb52-11"><a href="sortbars.html#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="sortbars.html#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb52-13"><a href="sortbars.html#cb52-13" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(STATE_NAME <span class="sc">%in%</span> top_states), </span>
<span id="cb52-14"><a href="sortbars.html#cb52-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(TF<span class="sc">/</span><span class="fl">1e6</span>, CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>, </span>
<span id="cb52-15"><a href="sortbars.html#cb52-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">colour =</span> YEAR, <span class="at">group =</span> STATE_NAME)) <span class="sc">+</span></span>
<span id="cb52-16"><a href="sortbars.html#cb52-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb52-17"><a href="sortbars.html#cb52-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>() <span class="sc">+</span></span>
<span id="cb52-18"><a href="sortbars.html#cb52-18" aria-hidden="true" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> state_label), <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-19"><a href="sortbars.html#cb52-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_steps</span>(<span class="at">n.breaks =</span> <span class="dv">8</span>, <span class="at">show.limits =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb52-20"><a href="sortbars.html#cb52-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Departing Flights (millions)&quot;</span>, </span>
<span id="cb52-21"><a href="sortbars.html#cb52-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb52-22"><a href="sortbars.html#cb52-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">&quot;Year&quot;</span>,</span>
<span id="cb52-23"><a href="sortbars.html#cb52-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Emissions for the busiest 8 states&quot;</span>,</span>
<span id="cb52-24"><a href="sortbars.html#cb52-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL. &#39;Busiest&#39; means most flights in 2019.&quot;</span>)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<ol start="2" style="list-style-type: decimal">
<li>This is an exercise in logic in the <code>filter</code>. Did you remember to update the title, footnotes and the legend title? And, as before, we need to tell <code>geom_text_repel</code> to be more patient with overlaps.</li>
</ol>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="sortbars.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the dataset</span></span>
<span id="cb53-2"><a href="sortbars.html#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/annual_co2.rda&quot;</span>)</span>
<span id="cb53-3"><a href="sortbars.html#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="sortbars.html#cb53-4" aria-hidden="true" tabindex="-1"></a>selected_states <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span></span>
<span id="cb53-5"><a href="sortbars.html#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">==</span> <span class="dv">2010</span> <span class="sc">&amp;</span> TF <span class="sc">&gt;</span> <span class="dv">10000</span>) <span class="sc">|&gt;</span>     <span class="co"># more than 10k flights</span></span>
<span id="cb53-6"><a href="sortbars.html#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(TF, <span class="at">n =</span> <span class="dv">6</span>) <span class="sc">|&gt;</span>  <span class="co"># bottom 6 </span></span>
<span id="cb53-7"><a href="sortbars.html#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(STATE_NAME) </span>
<span id="cb53-8"><a href="sortbars.html#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="sortbars.html#cb53-9" aria-hidden="true" tabindex="-1"></a>annual_co2 <span class="ot">&lt;-</span> annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb53-10"><a href="sortbars.html#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state_label =</span> <span class="fu">if_else</span>(YEAR <span class="sc">==</span> <span class="dv">2015</span>, <span class="fu">str_to_title</span>(STATE_NAME), <span class="st">&quot;&quot;</span>))</span>
<span id="cb53-11"><a href="sortbars.html#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="sortbars.html#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(annual_co2 <span class="sc">|&gt;</span> </span>
<span id="cb53-13"><a href="sortbars.html#cb53-13" aria-hidden="true" tabindex="-1"></a>         <span class="fu">filter</span>(STATE_NAME <span class="sc">%in%</span> selected_states), </span>
<span id="cb53-14"><a href="sortbars.html#cb53-14" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(TF<span class="sc">/</span><span class="fl">1e6</span>, CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>, </span>
<span id="cb53-15"><a href="sortbars.html#cb53-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">colour =</span> YEAR, <span class="at">group =</span> STATE_NAME)) <span class="sc">+</span></span>
<span id="cb53-16"><a href="sortbars.html#cb53-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">shape =</span> STATE_NAME)) <span class="sc">+</span> </span>
<span id="cb53-17"><a href="sortbars.html#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>() <span class="sc">+</span></span>
<span id="cb53-18"><a href="sortbars.html#cb53-18" aria-hidden="true" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> state_label), </span>
<span id="cb53-19"><a href="sortbars.html#cb53-19" aria-hidden="true" tabindex="-1"></a>                           <span class="at">colour =</span> <span class="st">&quot;black&quot;</span>, <span class="at">max.overlaps =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb53-20"><a href="sortbars.html#cb53-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_steps</span>(<span class="at">n.breaks =</span> <span class="dv">8</span>, <span class="at">show.limits =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb53-21"><a href="sortbars.html#cb53-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Departing Flights (millions)&quot;</span>, </span>
<span id="cb53-22"><a href="sortbars.html#cb53-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb53-23"><a href="sortbars.html#cb53-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">&quot;Year&quot;</span>,</span>
<span id="cb53-24"><a href="sortbars.html#cb53-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">shape =</span> <span class="st">&quot;State&quot;</span>,</span>
<span id="cb53-25"><a href="sortbars.html#cb53-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Emissions for the least-busy 6 states&quot;</span>,</span>
<span id="cb53-26"><a href="sortbars.html#cb53-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL. &#39;Least-busy&#39; means fewest flights in 2010, but more than 10k flights.&quot;</span>)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<ol start="3" style="list-style-type: decimal">
<li>You could load from Excel and immediately filter. I do it in two steps, because then I can check the correct field names for the <code>filter</code> and <code>mutate</code> using the environment pane.</li>
</ol>
<p>This is an exercise in building up quite complex statements from simple functions. Formatting the code with line breaks should help a lot.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="sortbars.html#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># go back to the excel file</span></span>
<span id="cb54-2"><a href="sortbars.html#cb54-2" aria-hidden="true" tabindex="-1"></a>aviation_co2 <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">&quot;data/CO2_emissions.xlsx&quot;</span>, </span>
<span id="cb54-3"><a href="sortbars.html#cb54-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sheet =</span> <span class="st">&quot;DATA&quot;</span>)</span>
<span id="cb54-4"><a href="sortbars.html#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># just the data that we need</span></span>
<span id="cb54-5"><a href="sortbars.html#cb54-5" aria-hidden="true" tabindex="-1"></a>monthly_co2 <span class="ot">&lt;-</span> aviation_co2 <span class="sc">|&gt;</span> </span>
<span id="cb54-6"><a href="sortbars.html#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(YEAR <span class="sc">&gt;=</span> <span class="dv">2017</span> <span class="sc">&amp;</span> STATE_NAME <span class="sc">==</span> <span class="st">&quot;FRANCE&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-7"><a href="sortbars.html#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">if_else</span>(MONTH <span class="sc">&lt;</span> <span class="dv">10</span>,</span>
<span id="cb54-8"><a href="sortbars.html#cb54-8" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">str_c</span>(YEAR, <span class="st">&quot;  &quot;</span>, MONTH), </span>
<span id="cb54-9"><a href="sortbars.html#cb54-9" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">str_c</span>(YEAR, <span class="st">&quot; &quot;</span>, MONTH))) <span class="co">#a pseudo-date</span></span>
<span id="cb54-10"><a href="sortbars.html#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="sortbars.html#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="co"># then the basic ggplot(data, aes(x,y)) + geometry...</span></span>
<span id="cb54-12"><a href="sortbars.html#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(monthly_co2, <span class="fu">aes</span>(date, CO2_QTY_TONNES<span class="sc">/</span><span class="fl">1e6</span>)) <span class="sc">+</span></span>
<span id="cb54-13"><a href="sortbars.html#cb54-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb54-14"><a href="sortbars.html#cb54-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb54-15"><a href="sortbars.html#cb54-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">bquote</span>(<span class="sc">~</span>CO[<span class="dv">2</span>]<span class="sc">~</span><span class="st">&quot; (million tonnes)&quot;</span>),</span>
<span id="cb54-16"><a href="sortbars.html#cb54-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Aviation Emissions of France&quot;</span>,</span>
<span id="cb54-17"><a href="sortbars.html#cb54-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL.&quot;</span>) <span class="sc">+</span></span>
<span id="cb54-18"><a href="sortbars.html#cb54-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>))</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<ol start="4" style="list-style-type: decimal">
<li></li>
</ol>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="sortbars.html#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># copying from the CO2 download code</span></span>
<span id="cb55-2"><a href="sortbars.html#cb55-2" aria-hidden="true" tabindex="-1"></a>ap_url <span class="ot">&lt;-</span> <span class="st">&quot;https://ansperformance.eu/download/xls/Airport_Traffic.xlsx&quot;</span></span>
<span id="cb55-3"><a href="sortbars.html#cb55-3" aria-hidden="true" tabindex="-1"></a>ap_file <span class="ot">&lt;-</span> <span class="st">&quot;data/airport_flights.xlsx&quot;</span></span>
<span id="cb55-4"><a href="sortbars.html#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># if we haven&#39;t already downloaded, then do so (not worried about updates)</span></span>
<span id="cb55-5"><a href="sortbars.html#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(ap_file)) <span class="fu">download.file</span>(ap_url, ap_file, <span class="at">mode =</span> <span class="st">&quot;wb&quot;</span>)</span>
<span id="cb55-6"><a href="sortbars.html#cb55-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-7"><a href="sortbars.html#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co"># load from the DATA worksheet - case sensitive!</span></span>
<span id="cb55-8"><a href="sortbars.html#cb55-8" aria-hidden="true" tabindex="-1"></a>ap_flights <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">&quot;data/airport_flights.xlsx&quot;</span>, </span>
<span id="cb55-9"><a href="sortbars.html#cb55-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">sheet =</span> <span class="st">&quot;DATA&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb55-10"><a href="sortbars.html#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># only keep the data we really want</span></span>
<span id="cb55-11"><a href="sortbars.html#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(APT_ICAO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;LFPG&quot;</span>, <span class="st">&quot;EDDF&quot;</span>, <span class="st">&quot;LTFM&quot;</span>))</span>
<span id="cb55-12"><a href="sortbars.html#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="sortbars.html#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co"># we can filter when loading, manipulating the dataset, or in ggplot</span></span>
<span id="cb55-14"><a href="sortbars.html#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(ap_flights <span class="sc">|&gt;</span> <span class="fu">filter</span>(YEAR <span class="sc">&gt;=</span> <span class="dv">2018</span>), </span>
<span id="cb55-15"><a href="sortbars.html#cb55-15" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(FLT_DATE, FLT_TOT_1, </span>
<span id="cb55-16"><a href="sortbars.html#cb55-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">colour =</span> APT_NAME)) <span class="sc">+</span></span>
<span id="cb55-17"><a href="sortbars.html#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line is ok for data to be joined in x-axis order</span></span>
<span id="cb55-18"><a href="sortbars.html#cb55-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># it&#39;s the least-worst option for so many points</span></span>
<span id="cb55-19"><a href="sortbars.html#cb55-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb55-20"><a href="sortbars.html#cb55-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb55-21"><a href="sortbars.html#cb55-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="sc">+</span>  <span class="co"># put legend below</span></span>
<span id="cb55-22"><a href="sortbars.html#cb55-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Total Flights&quot;</span>, <span class="at">x =</span> <span class="st">&quot;Day&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;Airport&quot;</span>,</span>
<span id="cb55-23"><a href="sortbars.html#cb55-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Flights at 3 European airports&quot;</span>,</span>
<span id="cb55-24"><a href="sortbars.html#cb55-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Source: EUROCONTROL.&quot;</span>)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-30-1.png" width="672" /></p>
<p>A graph showing so many days is always going to be pretty cluttered. Even so, apart from the weekly and annual seasonality, there are several events that are pretty obvious in these data:</p>
<ul>
<li>the restrictions on travel in response to COVID-19, from early 2020;</li>
<li>the start-up of operations at Istanbul Grand airport;</li>
<li>a strike by baggage-handlers in July 2022 in Germany;</li>
<li>heavy snowstorms leading to flight cancellations in Istanbul in January 2022.</li>
</ul>
<p>How little code is needed to go from data on the web to a graph which starts helping to tell some stories!</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="filter.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="loopsfunctions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["flights_in_R.pdf", "flights_in_R.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"theme": "sepia"
});
});
</script>

</body>

</html>
