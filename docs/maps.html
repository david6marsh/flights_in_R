<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Maps and geographic data | Picturing Flights with R UNDER CONSTRUCTION</title>
  <meta name="description" content="This book explores both open sources of aviation data and how to use the open tools of R and RStudio to understand that data. It’s intended as a training course and guidebook, with exercises and pointers to more information along the way. — UNDER CONSTRUCTION —" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Maps and geographic data | Picturing Flights with R UNDER CONSTRUCTION" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This book explores both open sources of aviation data and how to use the open tools of R and RStudio to understand that data. It’s intended as a training course and guidebook, with exercises and pointers to more information along the way. — UNDER CONSTRUCTION —" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Maps and geographic data | Picturing Flights with R UNDER CONSTRUCTION" />
  
  <meta name="twitter:description" content="This book explores both open sources of aviation data and how to use the open tools of R and RStudio to understand that data. It’s intended as a training course and guidebook, with exercises and pointers to more information along the way. — UNDER CONSTRUCTION —" />
  

<meta name="author" content="David Marsh" />


<meta name="date" content="2023-02-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="groups.html"/>
<link rel="next" href="splitparse.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Analysing Flights in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> How to use this book</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#before-you-start"><i class="fa fa-check"></i><b>1.1</b> Before you start</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#ways-to-use-the-material"><i class="fa fa-check"></i><b>1.2</b> Ways to Use the Material</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#structure-of-the-book"><i class="fa fa-check"></i><b>1.3</b> Structure of the book</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i><b>1.4</b> Acknowledgements</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#whats-gone-wrong"><i class="fa fa-check"></i><b>1.5</b> What’s gone wrong?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="start.html"><a href="start.html"><i class="fa fa-check"></i><b>2</b> Getting started with the basic tools of R</a>
<ul>
<li class="chapter" data-level="2.1" data-path="start.html"><a href="start.html#rstudio"><i class="fa fa-check"></i><b>2.1</b> Orientation in RStudio</a></li>
<li class="chapter" data-level="2.2" data-path="start.html"><a href="start.html#first-project"><i class="fa fa-check"></i><b>2.2</b> First project</a></li>
<li class="chapter" data-level="2.3" data-path="start.html"><a href="start.html#first-code"><i class="fa fa-check"></i><b>2.3</b> First code</a></li>
<li class="chapter" data-level="2.4" data-path="start.html"><a href="start.html#packages"><i class="fa fa-check"></i><b>2.4</b> First packages</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="start.html"><a href="start.html#twocolons"><i class="fa fa-check"></i><b>2.4.1</b> Package basics</a></li>
<li class="chapter" data-level="2.4.2" data-path="start.html"><a href="start.html#tidyverse"><i class="fa fa-check"></i><b>2.4.2</b> Tidyverse</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="start.html"><a href="start.html#filetypes"><i class="fa fa-check"></i><b>2.5</b> File types</a></li>
<li class="chapter" data-level="2.6" data-path="start.html"><a href="start.html#whats-gone-wrong-1"><i class="fa fa-check"></i><b>2.6</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="2.7" data-path="start.html"><a href="start.html#test-yourself"><i class="fa fa-check"></i><b>2.7</b> Test yourself</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="start.html"><a href="start.html#questions"><i class="fa fa-check"></i><b>2.7.1</b> Questions</a></li>
<li class="chapter" data-level="2.7.2" data-path="start.html"><a href="start.html#answers"><i class="fa fa-check"></i><b>2.7.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="firstLook.html"><a href="firstLook.html"><i class="fa fa-check"></i><b>3</b> First look at data and CO<sub>2</sub> emissions</a>
<ul>
<li class="chapter" data-level="3.1" data-path="firstLook.html"><a href="firstLook.html#loadco2"><i class="fa fa-check"></i><b>3.1</b> Looking at data: CO<sub>2</sub> Data</a></li>
<li class="chapter" data-level="3.2" data-path="firstLook.html"><a href="firstLook.html#extractfield"><i class="fa fa-check"></i><b>3.2</b> Extracting variables</a></li>
<li class="chapter" data-level="3.3" data-path="firstLook.html"><a href="firstLook.html#someValues"><i class="fa fa-check"></i><b>3.3</b> Extracting a few values</a></li>
<li class="chapter" data-level="3.4" data-path="firstLook.html"><a href="firstLook.html#co2-scatter-plot"><i class="fa fa-check"></i><b>3.4</b> CO<sub>2</sub> Scatter plot</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="firstLook.html"><a href="firstLook.html#first-draft"><i class="fa fa-check"></i><b>3.4.1</b> First draft</a></li>
<li class="chapter" data-level="3.4.2" data-path="firstLook.html"><a href="firstLook.html#improve-the-titles"><i class="fa fa-check"></i><b>3.4.2</b> Improve the titles</a></li>
<li class="chapter" data-level="3.4.3" data-path="firstLook.html"><a href="firstLook.html#statecluster"><i class="fa fa-check"></i><b>3.4.3</b> and with clustering by state</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="firstLook.html"><a href="firstLook.html#whats-gone-wrong-2"><i class="fa fa-check"></i><b>3.5</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="3.6" data-path="firstLook.html"><a href="firstLook.html#test-yourself-1"><i class="fa fa-check"></i><b>3.6</b> Test yourself</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="firstLook.html"><a href="firstLook.html#questions-1"><i class="fa fa-check"></i><b>3.6.1</b> Questions</a></li>
<li class="chapter" data-level="3.6.2" data-path="firstLook.html"><a href="firstLook.html#answers-1"><i class="fa fa-check"></i><b>3.6.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="filter.html"><a href="filter.html"><i class="fa fa-check"></i><b>4</b> Filtering a dataset and refining the CO<sub>2</sub> graph</a>
<ul>
<li class="chapter" data-level="4.1" data-path="filter.html"><a href="filter.html#sequences-of-functions"><i class="fa fa-check"></i><b>4.1</b> Sequences of functions</a></li>
<li class="chapter" data-level="4.2" data-path="filter.html"><a href="filter.html#filtering-datasets-and-logical-tests"><i class="fa fa-check"></i><b>4.2</b> Filtering datasets and logical tests</a></li>
<li class="chapter" data-level="4.3" data-path="filter.html"><a href="filter.html#topStates"><i class="fa fa-check"></i><b>4.3</b> Selecting the busiest states</a></li>
<li class="chapter" data-level="4.4" data-path="filter.html"><a href="filter.html#co2-graph-for-the-top-states"><i class="fa fa-check"></i><b>4.4</b> CO<sub>2</sub> graph for the top states</a></li>
<li class="chapter" data-level="4.5" data-path="filter.html"><a href="filter.html#labelco2"><i class="fa fa-check"></i><b>4.5</b> Labelling the CO<sub>2</sub> graph</a></li>
<li class="chapter" data-level="4.6" data-path="filter.html"><a href="filter.html#what-does-the-graph-say-about-co2"><i class="fa fa-check"></i><b>4.6</b> What does the graph say about CO<sub>2</sub>?</a></li>
<li class="chapter" data-level="4.7" data-path="filter.html"><a href="filter.html#whats-gone-wrong-3"><i class="fa fa-check"></i><b>4.7</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="4.8" data-path="filter.html"><a href="filter.html#exercises"><i class="fa fa-check"></i><b>4.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="filter.html"><a href="filter.html#questions-2"><i class="fa fa-check"></i><b>4.8.1</b> Questions</a></li>
<li class="chapter" data-level="4.8.2" data-path="filter.html"><a href="filter.html#answers-2"><i class="fa fa-check"></i><b>4.8.2</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sortbars.html"><a href="sortbars.html"><i class="fa fa-check"></i><b>5</b> Sorting Bars, Saving Graphs, Facets</a>
<ul>
<li class="chapter" data-level="5.1" data-path="sortbars.html"><a href="sortbars.html#firstsortedbar"><i class="fa fa-check"></i><b>5.1</b> The simple sorted bar chart - more on CO<sub>2</sub></a></li>
<li class="chapter" data-level="5.2" data-path="sortbars.html"><a href="sortbars.html#saving-a-plot"><i class="fa fa-check"></i><b>5.2</b> Saving a plot</a></li>
<li class="chapter" data-level="5.3" data-path="sortbars.html"><a href="sortbars.html#plotting-more-than-one-year"><i class="fa fa-check"></i><b>5.3</b> Plotting more than one year</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="sortbars.html"><a href="sortbars.html#factors"><i class="fa fa-check"></i><b>5.3.1</b> Staggered bars, and factors</a></li>
<li class="chapter" data-level="5.3.2" data-path="sortbars.html"><a href="sortbars.html#chart-facets-more-years-in-the-bar-chart"><i class="fa fa-check"></i><b>5.3.2</b> Chart facets, more years in the bar chart</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="sortbars.html"><a href="sortbars.html#whats-gone-wrong-4"><i class="fa fa-check"></i><b>5.4</b> What’s gone wrong?</a></li>
<li class="chapter" data-level="5.5" data-path="sortbars.html"><a href="sortbars.html#exercises-1"><i class="fa fa-check"></i><b>5.5</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="sortbars.html"><a href="sortbars.html#questions-3"><i class="fa fa-check"></i><b>5.5.1</b> Questions</a></li>
<li class="chapter" data-level="5.5.2" data-path="sortbars.html"><a href="sortbars.html#answers-3"><i class="fa fa-check"></i><b>5.5.2</b> Answers</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="sortbars.html"><a href="sortbars.html#extended-exercises"><i class="fa fa-check"></i><b>5.6</b> Extended Exercises</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="sortbars.html"><a href="sortbars.html#questions-4"><i class="fa fa-check"></i><b>5.6.1</b> Questions</a></li>
<li class="chapter" data-level="5.6.2" data-path="sortbars.html"><a href="sortbars.html#co2hints"><i class="fa fa-check"></i><b>5.6.2</b> Hints</a></li>
<li class="chapter" data-level="5.6.3" data-path="sortbars.html"><a href="sortbars.html#answers-4"><i class="fa fa-check"></i><b>5.6.3</b> Answers</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="loopsfunctions.html"><a href="loopsfunctions.html"><i class="fa fa-check"></i><b>6</b> Loops, functions and SID data</a>
<ul>
<li class="chapter" data-level="6.1" data-path="loopsfunctions.html"><a href="loopsfunctions.html#vectors-and-lists"><i class="fa fa-check"></i><b>6.1</b> Vectors and Lists</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="loopsfunctions.html"><a href="loopsfunctions.html#exercises-2"><i class="fa fa-check"></i><b>6.1.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="loopsfunctions.html"><a href="loopsfunctions.html#functions-and-loops"><i class="fa fa-check"></i><b>6.2</b> Functions and Loops</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="loopsfunctions.html"><a href="loopsfunctions.html#first-function-bi-directional-airport-pairs"><i class="fa fa-check"></i><b>6.2.1</b> First function: bi-directional airport pairs</a></li>
<li class="chapter" data-level="6.2.2" data-path="loopsfunctions.html"><a href="loopsfunctions.html#looping-with-functions"><i class="fa fa-check"></i><b>6.2.2</b> Looping with functions</a></li>
<li class="chapter" data-level="6.2.3" data-path="loopsfunctions.html"><a href="loopsfunctions.html#exercises-3"><i class="fa fa-check"></i><b>6.2.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="loopsfunctions.html"><a href="loopsfunctions.html#country-data"><i class="fa fa-check"></i><b>6.3</b> Country data</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="loopsfunctions.html"><a href="loopsfunctions.html#loadonemonthly"><i class="fa fa-check"></i><b>6.3.1</b> Load one country’s monthly data</a></li>
<li class="chapter" data-level="6.3.2" data-path="loopsfunctions.html"><a href="loopsfunctions.html#loadmultiplemonthlies"><i class="fa fa-check"></i><b>6.3.2</b> Load monthly data for multiple countries</a></li>
<li class="chapter" data-level="6.3.3" data-path="loopsfunctions.html"><a href="loopsfunctions.html#loadMultipleFiles"><i class="fa fa-check"></i><b>6.3.3</b> Load multiple files</a></li>
<li class="chapter" data-level="6.3.4" data-path="loopsfunctions.html"><a href="loopsfunctions.html#exercises-4"><i class="fa fa-check"></i><b>6.3.4</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="groups.html"><a href="groups.html"><i class="fa fa-check"></i><b>7</b> Looping with groups</a>
<ul>
<li class="chapter" data-level="7.1" data-path="groups.html"><a href="groups.html#summarise"><i class="fa fa-check"></i><b>7.1</b> Summarising</a></li>
<li class="chapter" data-level="7.2" data-path="groups.html"><a href="groups.html#dates"><i class="fa fa-check"></i><b>7.2</b> Dates</a></li>
<li class="chapter" data-level="7.3" data-path="groups.html"><a href="groups.html#mutate"><i class="fa fa-check"></i><b>7.3</b> Adding variables</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="maps.html"><a href="maps.html"><i class="fa fa-check"></i><b>8</b> Maps and geographic data</a>
<ul>
<li class="chapter" data-level="8.1" data-path="maps.html"><a href="maps.html#spatialFeatures"><i class="fa fa-check"></i><b>8.1</b> Spatial features</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="maps.html"><a href="maps.html#map-exercises"><i class="fa fa-check"></i><b>8.1.1</b> Map Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="maps.html"><a href="maps.html#RnDArchive"><i class="fa fa-check"></i><b>8.2</b> Using the R&amp;D Data Archive</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="maps.html"><a href="maps.html#flight-summaries"><i class="fa fa-check"></i><b>8.2.1</b> Flight Summaries</a></li>
<li class="chapter" data-level="8.2.2" data-path="maps.html"><a href="maps.html#airspaceData"><i class="fa fa-check"></i><b>8.2.2</b> Airspace structure</a></li>
<li class="chapter" data-level="8.2.3" data-path="maps.html"><a href="maps.html#flight-profiles"><i class="fa fa-check"></i><b>8.2.3</b> Flight profiles</a></li>
<li class="chapter" data-level="8.2.4" data-path="maps.html"><a href="maps.html#exercises-5"><i class="fa fa-check"></i><b>8.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="maps.html"><a href="maps.html#mapRegions"><i class="fa fa-check"></i><b>8.3</b> Countries and regions</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="maps.html"><a href="maps.html#mapCountries"><i class="fa fa-check"></i><b>8.3.1</b> Countries</a></li>
<li class="chapter" data-level="8.3.2" data-path="maps.html"><a href="maps.html#mapAirspace"><i class="fa fa-check"></i><b>8.3.2</b> Airspace</a></li>
<li class="chapter" data-level="8.3.3" data-path="maps.html"><a href="maps.html#exercises-6"><i class="fa fa-check"></i><b>8.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="maps.html"><a href="maps.html#mapAirports"><i class="fa fa-check"></i><b>8.4</b> Airports</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="maps.html"><a href="maps.html#mapOverlapLabels"><i class="fa fa-check"></i><b>8.4.1</b> Overlapping labels on maps</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="maps.html"><a href="maps.html#mapRoutes"><i class="fa fa-check"></i><b>8.5</b> Routes</a>
<ul>
<li class="chapter" data-level="8.5.1" data-path="maps.html"><a href="maps.html#great-circle-routes"><i class="fa fa-check"></i><b>8.5.1</b> Great Circle Routes</a></li>
<li class="chapter" data-level="8.5.2" data-path="maps.html"><a href="maps.html#fasterGeo"><i class="fa fa-check"></i><b>8.5.2</b> Need for Speed</a></li>
<li class="chapter" data-level="8.5.3" data-path="maps.html"><a href="maps.html#trueRoutes"><i class="fa fa-check"></i><b>8.5.3</b> True Routes</a></li>
<li class="chapter" data-level="8.5.4" data-path="maps.html"><a href="maps.html#exercises-7"><i class="fa fa-check"></i><b>8.5.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="maps.html"><a href="maps.html#mapDensity"><i class="fa fa-check"></i><b>8.6</b> Density of routes</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="maps.html"><a href="maps.html#exercises-8"><i class="fa fa-check"></i><b>8.6.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="maps.html"><a href="maps.html#what-has-gone-wrong"><i class="fa fa-check"></i><b>8.7</b> What has gone wrong?</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="splitparse.html"><a href="splitparse.html"><i class="fa fa-check"></i><b>9</b> NOTAMS: Splitting and parsing strings</a>
<ul>
<li class="chapter" data-level="9.1" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-into-many"><i class="fa fa-check"></i><b>9.1</b> Splitting a column into many</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="splitparse.html"><a href="splitparse.html#splitatcharacter"><i class="fa fa-check"></i><b>9.1.1</b> Splitting a column at a character</a></li>
<li class="chapter" data-level="9.1.2" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-at-a-regular-expression"><i class="fa fa-check"></i><b>9.1.2</b> Splitting a column at a regular expression</a></li>
<li class="chapter" data-level="9.1.3" data-path="splitparse.html"><a href="splitparse.html#splitting-a-column-at-an-either-or"><i class="fa fa-check"></i><b>9.1.3</b> Splitting a column at an either-or</a></li>
<li class="chapter" data-level="9.1.4" data-path="splitparse.html"><a href="splitparse.html#exercises-9"><i class="fa fa-check"></i><b>9.1.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="splitparse.html"><a href="splitparse.html#listcolumns"><i class="fa fa-check"></i><b>9.2</b> List columns</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="splitparse.html"><a href="splitparse.html#splitting-a-field-into-a-list"><i class="fa fa-check"></i><b>9.2.1</b> Splitting a field into a list</a></li>
<li class="chapter" data-level="9.2.2" data-path="splitparse.html"><a href="splitparse.html#more-realistic-splitting"><i class="fa fa-check"></i><b>9.2.2</b> More realistic splitting</a></li>
<li class="chapter" data-level="9.2.3" data-path="splitparse.html"><a href="splitparse.html#manipulate-fields-in-rows"><i class="fa fa-check"></i><b>9.2.3</b> Manipulate fields in rows</a></li>
<li class="chapter" data-level="9.2.4" data-path="splitparse.html"><a href="splitparse.html#exercises-10"><i class="fa fa-check"></i><b>9.2.4</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>10</b> Glossary</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Picturing Flights with R UNDER CONSTRUCTION</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="maps" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Maps and geographic data<a href="maps.html#maps" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>[This chapter has been written out of sequence so might refer to patterns that have not yet been covered in earlier chapters.]</p>
<p>You don’t get far in visualising patterns of air traffic without a map, whether that’s a map of airports, of routes between airports, or of regions: countries or, more air-traffic-focused, blocks of airspace. In this chapter we’ll build a set of tools for such things.</p>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">In this chapter, you’ll be introduced to:</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">spatial features, <code>s2</code>, <code>rnaturalearthdata</code>, R&amp;D Data Archive, <code>geom_sf</code>, <code>%&lt;&gt;%</code>, <code>st_transform</code>, <code>CRS</code> and more.</td>
</tr>
</tbody>
</table>
<p>You might need to install the package <code>hexbin</code>, which is used by <code>ggplot2</code> for some of the tasks in this chapter.</p>
<div id="spatialFeatures" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Spatial features<a href="maps.html#spatialFeatures" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We choose to use <a href="https://r-spatial.github.io/sf/">‘spatial features’</a> package <code>sf</code> as the main source of geographic functions since, of the several options, it feels most like an extension to the <code>tidyverse</code>. <code>sf</code> gives us, amongst other things:</p>
<ul>
<li><code>sfc</code>: geographic columns for data tables and tibbles, to hold points, lines and polygons;</li>
<li><code>sf</code>: spatial features objects, which are data tables and tibbles that have a designated default ‘geometry’ <code>sfc</code> column;</li>
<li>functions which access libraries of geographic operations, such as for distances, intersections or unions;</li>
<li>use of <code>geom_sf()</code> in a <code>ggplot</code> to plot one of these columns.</li>
</ul>
<p>We’ll shortly see an example, but a ‘typical’ <code>sf</code>-enriched dataframe might be have one row per flight and an <code>sfc</code> column which contains the route flown by the flight, as a sequence of longitude-latitude points, but all folded up into a single cell per flight. If that sounds complicated, <code>sf</code> makes it pretty easy to use such data, and the gain of being able to ‘see’ the whole flight as one row in the data explorer is great.</p>
<p>There is lots of <a href="https://r-spatial.github.io/sf/">good documentation</a> for ‘spatial features’ and plenty of good questions on StackExchange to help you with problems. There’s even <a href="https://r-spatial.github.io/sf/#cheatsheet">a ‘cheatsheet’</a>. Here we focus on <em>using</em> <code>sf</code> with aviation data.</p>
<p>The use of supporting libraries by <code>sf</code> can create complexity, for example requiring installation of extra code, such as <code>GDAL</code> (you’ll see GDAL and other libraries mentioned when you attach sf in the next code chunk). We’ll mostly stick to asking <code>sf</code> to use the <code>s2</code> library, for a number of reasons:</p>
<ul>
<li>the code is available directly as the <code>s2</code> package, so installation problems should be few;</li>
<li>we can quickly translate between <code>s2</code> and <code>sf</code>;</li>
<li>and <code>s2</code> works directly on the sphere.</li>
</ul>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="maps.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code></pre></div>
<pre><code>## Linking to GEOS 3.11.1, GDAL 3.5.3, PROJ 9.1.1; sf_use_s2() is TRUE</code></pre>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="maps.html#cb147-1" aria-hidden="true" tabindex="-1"></a>sf<span class="sc">::</span><span class="fu">sf_use_s2</span>(<span class="cn">TRUE</span>) </span>
<span id="cb147-2"><a href="maps.html#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(s2) <span class="co"># here we use a number of functions directly from s2</span></span>
<span id="cb147-3"><a href="maps.html#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata) <span class="co"># for country maps</span></span></code></pre></div>
<p>As usual, if these <code>library</code> calls cause errors, then use <code>install.packages(c("sf", "rnaturalearthdata"))</code> to get the packages.</p>
<p>What does that mean ‘works directly on the sphere’? The main difference between geographic data and the sorts of data that we’ve been plotting so far is that the two dimensions, longitude and latitude, are not points on a plane, but on a sphere. One approach to working with such data is to project (i.e. ‘convert’) all your data onto the plane by transforming with a ‘coordinate reference system’ (CRS), and then work on the plane, allowing for some of the distortion that is inevitable, eg straight lines might no longer be straight.</p>
<p>With <code>s2</code> we work on the sphere itself, and transform <em>only when we want to plot</em>. I like the cleanliness of keeping CRS for plotting. There are some costs: in particular, the World isn’t actually spherical, so there are some errors in <a href="https://r-spatial.github.io/sf/articles/sf7.html#measures">distance and area calculations</a> for example. If your application is sensitive to distance errors of 0.5%, then other functions can be used, but we won’t go into detail of those here.</p>
<p>Switch <code>sf</code> to using <code>s2</code> with <code>sf_use_s2(TRUE)</code> whenever you attach <code>library(sf)</code>, as we did at the start of this chapter. Then <code>sf</code> will use <code>s2</code> versions of functions whenever it can without further intervention from you.</p>
<p>What does <code>sf</code> give us? Here’s an example, using <code>rnaturalearthdata</code>, a package that handily provides country maps. After converting the map data to <code>sf</code> with <code>st_as_sf()</code>, we have one row of a dataframe (an <code>sf</code> object is still a <code>dataframe</code>) per country, and all the map polygons in a single column. We illustrate the use of <code>filter()</code> on text fields, in a manner that you’ve seen before, and then with a ‘logical’ function that tests for intersection between <code>geometry</code> which contains the map polygons, and our <code>Dublin_Bucharest</code> line.</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="maps.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a line from Dublin to Athens</span></span>
<span id="cb148-2"><a href="maps.html#cb148-2" aria-hidden="true" tabindex="-1"></a>Dublin_Bucharest <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">6.27</span>, <span class="fl">53.42</span>, <span class="fl">26.1</span>, <span class="fl">44.57</span>), </span>
<span id="cb148-3"><a href="maps.html#cb148-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb148-4"><a href="maps.html#cb148-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_linestring</span>() <span class="sc">|&gt;</span> <span class="co"># convert the matrix of long-lat into an sf-&#39;linestring&#39;</span></span>
<span id="cb148-5"><a href="maps.html#cb148-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tell sf that it&#39;s in long-lat, EPSG4326 is a long-lat coordinate reference system</span></span>
<span id="cb148-6"><a href="maps.html#cb148-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb148-7"><a href="maps.html#cb148-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-8"><a href="maps.html#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="co"># a map demo - countries110 comes with lots of data such as population</span></span>
<span id="cb148-9"><a href="maps.html#cb148-9" aria-hidden="true" tabindex="-1"></a>europe_countries <span class="ot">&lt;-</span> rnaturalearthdata<span class="sc">::</span>countries110 <span class="sc">|&gt;</span> </span>
<span id="cb148-10"><a href="maps.html#cb148-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> <span class="co"># convert to sf</span></span>
<span id="cb148-11"><a href="maps.html#cb148-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># some of the polygons in the map cause issues so we zoom in</span></span>
<span id="cb148-12"><a href="maps.html#cb148-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># using metadata in the &#39;rnaturalearthdata&#39; dataframe</span></span>
<span id="cb148-13"><a href="maps.html#cb148-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(admin <span class="sc">!=</span> <span class="st">&quot;Russia&quot;</span> <span class="sc">&amp;</span> continent <span class="sc">==</span> <span class="st">&quot;Europe&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb148-14"><a href="maps.html#cb148-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now do the intersection - working on the sphere</span></span>
<span id="cb148-15"><a href="maps.html#cb148-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sparse = FALSE is required to get a full-length logical vector </span></span>
<span id="cb148-16"><a href="maps.html#cb148-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    rather than a vector of row ids</span></span>
<span id="cb148-17"><a href="maps.html#cb148-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># st_intersects is a yes-no question</span></span>
<span id="cb148-18"><a href="maps.html#cb148-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">st_intersects</span>(geometry, Dublin_Bucharest, <span class="at">sparse =</span> <span class="cn">FALSE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb148-19"><a href="maps.html#cb148-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># st_intersection asks for the intersection of the two</span></span>
<span id="cb148-20"><a href="maps.html#cb148-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">segment =</span> <span class="fu">st_intersection</span>(Dublin_Bucharest, geometry))</span>
<span id="cb148-21"><a href="maps.html#cb148-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-22"><a href="maps.html#cb148-22" aria-hidden="true" tabindex="-1"></a><span class="co"># simplest of plots treats long-lat like x-y</span></span>
<span id="cb148-23"><a href="maps.html#cb148-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(europe_countries) <span class="sc">+</span></span>
<span id="cb148-24"><a href="maps.html#cb148-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="dv">1000</span> <span class="sc">*</span> gdp_md_est<span class="sc">/</span>pop_est)) <span class="sc">+</span></span>
<span id="cb148-25"><a href="maps.html#cb148-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">geometry =</span> segment), <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb148-26"><a href="maps.html#cb148-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;GDP</span><span class="sc">\n</span><span class="st">Per Capita</span><span class="sc">\n</span><span class="st">($ 000)&quot;</span>,</span>
<span id="cb148-27"><a href="maps.html#cb148-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Simplified map omits many islands.&quot;</span>)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-60-1.png" width="672" /></p>
<p>In this one example, we see two geographical functions for intersection, <code>st_intersects()</code> and <code>st_intersection()</code>. The first is a yes/no question used to filter out just the countries we need. The second creates the sequence of 3 line segments that actually intersect the countries, broken at the Irish Sea and English Channel. That’s probably of limited use here, since flights are continuous, but it’ll be more useful later.</p>
<p>We see a line is defined by just two points (as it should be, speaking geometrically) but showing as a curve when plotted on a rectilinear longitude-latitude grid (ie one with horizontal latitude lines and vertical longitudes). This demonstrates the line being a ‘great circle’<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>, but see question (4) for a more complete demonstration.</p>
<p>We cover country maps in more detail in section <a href="maps.html#mapCountries">8.3.1</a>.</p>
<div id="map-exercises" class="section level3 hasAnchor" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Map Exercises<a href="maps.html#map-exercises" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="questions-8" class="section level4 hasAnchor" number="8.1.1.1">
<h4><span class="header-section-number">8.1.1.1</span> Questions<a href="maps.html#questions-8" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>What does the map look like of those European countries <em>not</em> overflown?</li>
<li>Which countries are within 100km of the route?</li>
<li>Before converting to <code>sf</code>, what’s the structure of the data in <code>countries110</code>?</li>
<li>Add the Dublin-Bucharest line directly, with <code>+ geom_sf(data = Dublin_Bucharest)</code>. What’s wrong and what do you think is the problem?</li>
</ol>
</div>
<div id="answers-8" class="section level4 hasAnchor" number="8.1.1.2">
<h4><span class="header-section-number">8.1.1.2</span> Answers<a href="maps.html#answers-8" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>Wrap a <code>!( )</code> around the filter and see. Svalbard looks big in this plot, and the map opens up to show French Guiana.</li>
<li>Three additional States. Checking through the <code>s2</code> package documentation, we need <code>s2_dwithin()</code> (not <code>s2_within</code>), so use <code>s2::s2_dwithin(Dublin_Bucharest, 100 * 1000)</code>, since distances are in metres.</li>
<li>Run just the first line and we get a <code>SpatialPolygonsDataFrame</code> which is actually a data frame plus some other elements. It’s based on an alternative way of handling spatial data (package <code>sp</code>), which we won’t be using here mostly because it feels less ‘tidyverse’.</li>
<li>The line is shown by ggplot as a straight line on the plot, because <code>ggplot</code> joins points with straight lines. At present, <code>geom_sf()</code> doesn’t really understand great circles. Indeed, if you’re sharp-eyed you might see that the ‘great circle’ already shown is actually made up of straight segments in each country. We’ll see how to handle this later, but for the moment the lesson is: <code>sf</code> understands great circles, <code>ggplot</code> less so.</li>
</ol>
</div>
</div>
</div>
<div id="RnDArchive" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Using the R&amp;D Data Archive<a href="maps.html#RnDArchive" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>At this point, we’ll start using data from the <a href="https://www.eurocontrol.int/dashboard/rnd-data-archive">EUROCONTROL R&amp;D Data Archive</a> which, at the time of writing, provides fine-grained data on some 18 million European flights between 2015 and 2020, with more data added each quarter. With a business or academic email address you can ask for free access to this.</p>
<div id="flight-summaries" class="section level3 hasAnchor" number="8.2.1">
<h3><span class="header-section-number">8.2.1</span> Flight Summaries<a href="maps.html#flight-summaries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Rather than clog up your hard-disk with data, start by just downloading some flight summaries, say for March 2019. The image below shows a step in this process. Check and accept the terms and conditions and you’ll get your file.</p>
<div class="figure">
<img src="images/RDArchive_download.png" alt="" />
<p class="caption">Downloading flight summary data for one quarter</p>
</div>
<p>Save the data in your project <code>/data</code> folder, then the following code will work. You can leave the file with its <code>.csv.gz</code> extension; R can handle this. (The terms &amp; conditions mean that the data cannot be bundled with this book.)</p>
<p>The ‘Flights’ file contains one row per flight, and gives a range of data about that flight, including departure and destination airports (ADEP, ADES), planned and actual times, aircraft type, aircraft operator etc. <a href="https://www.eurocontrol.int/publication/rnd-data-archive-structure-and-sample">See the documentation ‘metadata’</a> for more details.</p>
<p>The column names aren’t very R-friendly, though. So we use a function to read the file and rename the columns. It takes a little while to load nearly 800,000 flights. Times in air traffic management are usually in ‘universal time coordinated’ (UTC), so we specify the time zone as “UTC”. Check the documentation ‘metadata’ section 3 for the explanations of the column names.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="maps.html#cb149-1" aria-hidden="true" tabindex="-1"></a>get_flights <span class="ot">&lt;-</span> <span class="cf">function</span>(file_name){</span>
<span id="cb149-2"><a href="maps.html#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load Flights...csv.gz file downloaded from R&amp;D Data Archive</span></span>
<span id="cb149-3"><a href="maps.html#cb149-3" aria-hidden="true" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">read_csv</span>(file_name, <span class="at">skip =</span> <span class="dv">1</span>, </span>
<span id="cb149-4"><a href="maps.html#cb149-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;adep&quot;</span>, <span class="st">&quot;adep_lat&quot;</span>, <span class="st">&quot;adep_long&quot;</span>, </span>
<span id="cb149-5"><a href="maps.html#cb149-5" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;ades&quot;</span>, <span class="st">&quot;ades_lat&quot;</span>, <span class="st">&quot;ades_long&quot;</span>, </span>
<span id="cb149-6"><a href="maps.html#cb149-6" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;obt_filed&quot;</span>, <span class="st">&quot;arr_filed&quot;</span>, <span class="st">&quot;obt_actual&quot;</span>, <span class="st">&quot;arr_actual&quot;</span>,</span>
<span id="cb149-7"><a href="maps.html#cb149-7" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;ac_type&quot;</span>, <span class="st">&quot;ao&quot;</span>, <span class="st">&quot;ac_reg&quot;</span>, </span>
<span id="cb149-8"><a href="maps.html#cb149-8" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;flt_type&quot;</span>, <span class="st">&quot;segment&quot;</span>, <span class="st">&quot;rfl&quot;</span>, <span class="st">&quot;dist_act_nm&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb149-9"><a href="maps.html#cb149-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_at</span>(<span class="fu">vars</span>(<span class="st">&quot;obt_filed&quot;</span>, <span class="st">&quot;arr_filed&quot;</span>, <span class="st">&quot;obt_actual&quot;</span>, <span class="st">&quot;arr_actual&quot;</span>), </span>
<span id="cb149-10"><a href="maps.html#cb149-10" aria-hidden="true" tabindex="-1"></a>              <span class="sc">~</span> <span class="fu">as.POSIXct</span>(., <span class="at">format =</span> <span class="st">&quot;%d-%m-%Y %H:%M:%S&quot;</span>, <span class="at">tz =</span> <span class="st">&quot;UTC&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb149-11"><a href="maps.html#cb149-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dist_act_km =</span> <span class="fl">1.852</span> <span class="sc">*</span> dist_act_nm) <span class="sc">|&gt;</span> </span>
<span id="cb149-12"><a href="maps.html#cb149-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>dist_act_nm)</span>
<span id="cb149-13"><a href="maps.html#cb149-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb149-14"><a href="maps.html#cb149-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-15"><a href="maps.html#cb149-15" aria-hidden="true" tabindex="-1"></a>flights <span class="ot">&lt;-</span> <span class="fu">get_flights</span>(<span class="st">&quot;data/Flights_20190301_20190331.csv.gz&quot;</span>)</span></code></pre></div>
<p>It’s good to do a visual check of numbers to see what we have. We take the day part of the filed off-blocks time (the time in the flight plan for push-back from the gate). We saw previously that this needs to be <code>floor_date</code> not <code>round_date</code> to get the start of the day. There are about 25,000 flights per day, although at this time of year Saturdays are significantly quieter. The plot shows that we have a sensible number of flights, for each day in March.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="maps.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(flights,</span>
<span id="cb150-2"><a href="maps.html#cb150-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(lubridate<span class="sc">::</span><span class="fu">floor_date</span>(obt_filed, <span class="st">&quot;day&quot;</span>),</span>
<span id="cb150-3"><a href="maps.html#cb150-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> segment)) <span class="sc">+</span> </span>
<span id="cb150-4"><a href="maps.html#cb150-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb150-5"><a href="maps.html#cb150-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Date (of filed off-blocks time)&quot;</span>, </span>
<span id="cb150-6"><a href="maps.html#cb150-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Number of Commercial Flights in Sample&quot;</span>) </span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-62-1.png" width="672" /></p>
<p>A check like this can be useful just to know how much data there is to explore. Also, although we haven’t joined these data yet to anything else, it’s surprising how often a simple join can go wrong and duplicate flights. So checks are worthwhile, and this gives us a baseline to re-check later.</p>
</div>
<div id="airspaceData" class="section level3 hasAnchor" number="8.2.2">
<h3><span class="header-section-number">8.2.2</span> Airspace structure<a href="maps.html#airspaceData" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The structure of the airspace is continually refined to align with traffic needs. In Europe, there are updates for each new ‘AIRAC cycle’, which lasts 4 weeks. The R&amp;D Data Archive provides airspace data for each applicable AIRAC cycle, and the smallest file in each quarter’s data is <code>AIRAC_xxxx.csv.gz</code> which lists the AIRAC cycles and their dates during that month.</p>
<p>The airspace structure is then given in terms of:</p>
<ul>
<li>the boundaries and vertical extent of each flight information region (FIR) structure (with a simplified structure outside Europe).</li>
<li>the route network.</li>
</ul>
<p>Many countries have a single ‘FIR’, though some share one (e.g. Belgium &amp; Luxembourg) and some have more than one (e.g. Spain). For coastal countries, the airspace and therefore the FIR usually extends out to sea. In this section we load and inspect the FIR data and compare it with the land boundaries. From the 201903 archive, download the <code>FIR_1904.csv.gz</code> file and put it in your <code>data</code> folder. We need to do a little work with the data.</p>
<p>In the country data we saw briefly earlier, countries are described with ‘multipolygons’, each polygon being a sequence of points that joins up to form a ring and the ‘multi’ bit because there can be islands or, occasionally, holes (Italy has 2 holes, for the Vatican and San Marino). FIRs are no different. Most are single polygons, one or two have holes, and some have been split in these data along the dateline. We have to identify the rings. The way we have chosen to do this is by looking for repeated coordinates (which are the two ends <code>(n() &gt; 1)</code>), then finding the first end and flagging it with a <code>1</code>. A cumulative sum of these flags gives distinct identification numbers to each ring.</p>
<p>One respect in which FIRs are different from countries is that they have a vertical extent and can overlap if you ignore altitude. We treat combinations of <code>airspace_id, min_flight_level, max_flight_level</code> (see <code>group_by</code>) as determining an FIR. That isn’t really true (an FIR can be thick in places and thin in others), but this will be enough for this illustration.</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="maps.html#cb151-1" aria-hidden="true" tabindex="-1"></a>fir <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">&quot;data/FIR_1904.csv.gz&quot;</span>)</span>
<span id="cb151-2"><a href="maps.html#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tidy the column names</span></span>
<span id="cb151-3"><a href="maps.html#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this uses the &#39;and assign&#39; pipe %&lt;&gt;%, for brevity</span></span>
<span id="cb151-4"><a href="maps.html#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(fir) <span class="sc">%&lt;&gt;%</span></span>
<span id="cb151-5"><a href="maps.html#cb151-5" aria-hidden="true" tabindex="-1"></a>  stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">s&quot;</span>, <span class="st">&quot;_&quot;</span>) <span class="sc">%&lt;&gt;%</span></span>
<span id="cb151-6"><a href="maps.html#cb151-6" aria-hidden="true" tabindex="-1"></a>  stringr<span class="sc">::</span><span class="fu">str_to_lower</span>()</span>
<span id="cb151-7"><a href="maps.html#cb151-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-8"><a href="maps.html#cb151-8" aria-hidden="true" tabindex="-1"></a>fir_poly <span class="ot">&lt;-</span> fir <span class="sc">|&gt;</span> </span>
<span id="cb151-9"><a href="maps.html#cb151-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(airspace_id, min_flight_level, max_flight_level, </span>
<span id="cb151-10"><a href="maps.html#cb151-10" aria-hidden="true" tabindex="-1"></a>           longitude, latitude) <span class="sc">|&gt;</span> </span>
<span id="cb151-11"><a href="maps.html#cb151-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ring_end =</span> (<span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span> <span class="co"># end points occur twice </span></span>
<span id="cb151-12"><a href="maps.html#cb151-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>(longitude, latitude) <span class="sc">|&gt;</span> </span>
<span id="cb151-13"><a href="maps.html#cb151-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ring_start =</span> <span class="fu">if_else</span>(ring_end <span class="sc">&amp;</span></span>
<span id="cb151-14"><a href="maps.html#cb151-14" aria-hidden="true" tabindex="-1"></a>                                (<span class="fu">is.na</span>(<span class="fu">lag</span>(ring_end)) <span class="sc">|</span> <span class="fu">lag</span>(ring_end)), </span>
<span id="cb151-15"><a href="maps.html#cb151-15" aria-hidden="true" tabindex="-1"></a>                              1L, 0L), </span>
<span id="cb151-16"><a href="maps.html#cb151-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">ring_id =</span> <span class="fu">cumsum</span>(ring_start)) <span class="sc">|&gt;</span> </span>
<span id="cb151-17"><a href="maps.html#cb151-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>ring_end, <span class="sc">-</span>ring_start) <span class="sc">|&gt;</span> </span>
<span id="cb151-18"><a href="maps.html#cb151-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now make the polygon (with holes if that makes sense) </span></span>
<span id="cb151-19"><a href="maps.html#cb151-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">geo =</span> s2<span class="sc">::</span><span class="fu">s2_make_polygon</span>(longitude, latitude, <span class="at">ring_id =</span> ring_id) <span class="sc">|&gt;</span> </span>
<span id="cb151-20"><a href="maps.html#cb151-20" aria-hidden="true" tabindex="-1"></a>            sf<span class="sc">::</span><span class="fu">st_as_sfc</span>(), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb151-21"><a href="maps.html#cb151-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># turn into sf object</span></span>
<span id="cb151-22"><a href="maps.html#cb151-22" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_geometry</span>(<span class="st">&quot;geo&quot;</span>) </span></code></pre></div>
<p>A quick map highlights a number of features of the data: we just have large regions in places distant from Europe, these are aggregate regions made up of lots of actual FIRs; the ‘layers’ of superimposed FIRs are less transparent so mask the underlying countries more, eg Spain, though this isn’t a great way to show this; being Europe-oriented the data have been cut at 180º, to avoid wrapping problems (in fact the map is cut at 180° and the FIRs at 179°).</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="maps.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rnaturalearthdata<span class="sc">::</span>countries110 <span class="sc">|&gt;</span> <span class="fu">st_as_sf</span>()) <span class="sc">+</span> <span class="co">#convert to sf temporarily</span></span>
<span id="cb152-2"><a href="maps.html#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="st">&quot;grey50&quot;</span>) <span class="sc">+</span> </span>
<span id="cb152-3"><a href="maps.html#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> fir_poly, <span class="at">alpha =</span> <span class="fl">0.7</span>) </span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-64-1.png" width="672" /></p>
<p>This isn’t very pretty. We’ll look at a better version in section <a href="maps.html#mapAirspace">8.3.2</a>.</p>
</div>
<div id="flight-profiles" class="section level3 hasAnchor" number="8.2.3">
<h3><span class="header-section-number">8.2.3</span> Flight profiles<a href="maps.html#flight-profiles" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The R&amp;D Data Archive provides both the route from the filed flight plan, and the route as flown, updated by radar. Each route is specified as longitude-latitude points, a flight level (roughly of 100 feet, so FL350 = 35,000 feet altitude), and a time.</p>
<p>We will load and plot some profiles in section <a href="maps.html#trueRoutes">8.5.3</a>.</p>
</div>
<div id="exercises-5" class="section level3 hasAnchor" number="8.2.4">
<h3><span class="header-section-number">8.2.4</span> Exercises<a href="maps.html#exercises-5" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="questions-9" class="section level4 hasAnchor" number="8.2.4.1">
<h4><span class="header-section-number">8.2.4.1</span> Questions<a href="maps.html#questions-9" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>In the bar chart of flight counts, why the fussy caption on the x-axis ‘of filed off-blocks time’?</li>
<li>Download a second flight file. How would you automatically load and merge all of the flight files that you’ve downloaded. (Hint: This is a simplified version of something you did with files from the STATFOR dashboard in section <a href="loopsfunctions.html#loadMultipleFiles">6.3.3</a>.</li>
<li>Why did the answer to (2) involve switching from <code>pmap</code>?</li>
</ol>
</div>
<div id="answers-9" class="section level4 hasAnchor" number="8.2.4.2">
<h4><span class="header-section-number">8.2.4.2</span> Answers<a href="maps.html#answers-9" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>Because flights might depart on one day and land the next.</li>
<li>This is it.</li>
</ol>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="maps.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co">#get file names in the data directory, with the full file path</span></span>
<span id="cb153-2"><a href="maps.html#cb153-2" aria-hidden="true" tabindex="-1"></a>flight_files <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="st">&quot;data&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;Flights_&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb153-3"><a href="maps.html#cb153-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-4"><a href="maps.html#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="co"># and load</span></span>
<span id="cb153-5"><a href="maps.html#cb153-5" aria-hidden="true" tabindex="-1"></a>all_flights <span class="ot">&lt;-</span> flight_files <span class="sc">|&gt;</span> </span>
<span id="cb153-6"><a href="maps.html#cb153-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(get_flights) <span class="sc">|&gt;</span> <span class="co"># this re-use is why we wrote get_flights as a function, earlier in this section</span></span>
<span id="cb153-7"><a href="maps.html#cb153-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>()</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Because the ‘SID’ code in the earlier chapter is reading a number of columns from a dataframe it uses <code>pmap</code>. Here we just have a single vector of names, so only need <code>map</code>.</li>
</ol>
</div>
</div>
</div>
<div id="mapRegions" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Countries and regions<a href="maps.html#mapRegions" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section, we introduce work patterns for plotting countries or regions. We stick to the over-arching pattern of: keep the data in longitude-latitude (“on the sphere”), then transform when plotting into a coordinate reference system (CRS) chosen to suit the map.</p>
<div id="mapCountries" class="section level3 hasAnchor" number="8.3.1">
<h3><span class="header-section-number">8.3.1</span> Countries<a href="maps.html#mapCountries" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We already saw a country map in section <a href="maps.html#spatialFeatures">8.1</a>. Let’s take a step back and approach some of the key elements of plotting countries at a more steady pace: filtering, plotting, transforming, cropping.</p>
<p>It might be that you have a specific set of countries in mind. Then it’s natural to do this by filtering the dataframe as you would with a non-geographic dataframe. While you might filter by name, it’s more compact and often easier (due to alternative spellings of country names) to use the ISO code. The 1:110 million scale map in <code>countries110</code>, however, isn’t great when we zoom in to this detail (for example it misses out many islands), so we use a 1:50 million map <code>countries50</code>. An even finer-grained, 1:10 million map is available, but not through CRAN, in the package <code>rnaturalearthhires</code>, while other European maps are available for free download, for example from Eurostat.</p>
<p>While we filter on the code <code>iso_a2</code> for the reasons discussed earlier, we use the <code>admin</code> field for the colour fill, since this is an easy way to create a more informative legend, one that shows the administrative names.</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="maps.html#cb154-1" aria-hidden="true" tabindex="-1"></a>iberia_iso2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;ES&quot;</span>, <span class="st">&quot;PT&quot;</span>) <span class="co">#Spain &amp; Portugal</span></span>
<span id="cb154-2"><a href="maps.html#cb154-2" aria-hidden="true" tabindex="-1"></a>iberia <span class="ot">&lt;-</span> rnaturalearthdata<span class="sc">::</span>countries50 <span class="sc">|&gt;</span> </span>
<span id="cb154-3"><a href="maps.html#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb154-4"><a href="maps.html#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(iso_a2 <span class="sc">%in%</span> iberia_iso2)</span>
<span id="cb154-5"><a href="maps.html#cb154-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-6"><a href="maps.html#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="co"># colour by country, make the borders thin.</span></span>
<span id="cb154-7"><a href="maps.html#cb154-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(iberia) <span class="sc">+</span> </span>
<span id="cb154-8"><a href="maps.html#cb154-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> admin), <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb154-9"><a href="maps.html#cb154-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Country&quot;</span>) <span class="sc">+</span> </span>
<span id="cb154-10"><a href="maps.html#cb154-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-66-1.png" width="672" />
There’s something a little ugly about this map - the shapes are distorted because we aren’t doing any sort of projection. We are just plotting longitude and latitude as if they were x-y coordinates, which they aren’t. We could transform the data (the <code>sf</code> or the <code>geometry</code> column) to a new CRS, but because we’re working with <code>s2</code>, on the sphere in long-lat, it makes sense to keep our data in long-lat, and transform only for the purpose of plotting.</p>
<p>The easiest way to do that is to add a <code>coord_sf(crs = xx)</code> to the plot, which ensures that all of the layers (if we have more than one layer) are in the same CRS. For European maps, EPSG3035 is often recommended for statistical charts: it’s a Lambert Equal Area transformation set up for Europe. So here we just add <code>coord_sf(crs = 3035)</code>.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="maps.html#cb155-1" aria-hidden="true" tabindex="-1"></a>use_crs <span class="ot">&lt;-</span> <span class="dv">3035</span></span>
<span id="cb155-2"><a href="maps.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="co"># use ggplot::last_plot() rather than repeat the code</span></span>
<span id="cb155-3"><a href="maps.html#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="fu">last_plot</span>() <span class="sc">+</span></span>
<span id="cb155-4"><a href="maps.html#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply the transform</span></span>
<span id="cb155-5"><a href="maps.html#cb155-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> use_crs)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-67-1.png" width="672" /></p>
<p>What if we want a map without Canaries or Azores, but with Madeira, say? With some sets of maps, the parts of countries are separate so can be filtered by name. In the <code>rnaturalearth</code> dataframe they are not. We need to crop the map. Again, this is about the map, not the data, so rather than cropping the data, we basically need to set limits to the plot.</p>
<p>The catch is that we need to do this in the units of the projection (EPSG3035) which, after the transformation, is metres (measured from a projection-specific origin). To make the code easier to understand, we probably want to crop in terms of degrees. So we create some points (in degrees) and transform them, too, to get the values in metres. In degrees, think in terms of what point should be in the bottom left corner (here 20 West 30 North), and what in the top right. We’ll shortly see how to crop automatically based on the data, but it’s useful to know the bottom-left/top-right rule.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="maps.html#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set limits at long-lat (-20, 30) to (5, 45)</span></span>
<span id="cb156-2"><a href="maps.html#cb156-2" aria-hidden="true" tabindex="-1"></a>lim_corners <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">5</span>, <span class="dv">45</span>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb156-3"><a href="maps.html#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_multipoint</span>() <span class="sc">|&gt;</span> <span class="co"># convert to sf multiple-points</span></span>
<span id="cb156-4"><a href="maps.html#cb156-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> <span class="co"># and record that these are points in long-lat</span></span>
<span id="cb156-5"><a href="maps.html#cb156-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transform to the map CRS   </span></span>
<span id="cb156-6"><a href="maps.html#cb156-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(use_crs) <span class="sc">|&gt;</span> </span>
<span id="cb156-7"><a href="maps.html#cb156-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pull out a matrix of values (with named columns X and Y)</span></span>
<span id="cb156-8"><a href="maps.html#cb156-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_coordinates</span>()</span>
<span id="cb156-9"><a href="maps.html#cb156-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-10"><a href="maps.html#cb156-10" aria-hidden="true" tabindex="-1"></a><span class="co"># the ggplot in full, rather than use ggplot2::last_plot()</span></span>
<span id="cb156-11"><a href="maps.html#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(iberia) <span class="sc">+</span> </span>
<span id="cb156-12"><a href="maps.html#cb156-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> admin), <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb156-13"><a href="maps.html#cb156-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Country&quot;</span>) <span class="sc">+</span> </span>
<span id="cb156-14"><a href="maps.html#cb156-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb156-15"><a href="maps.html#cb156-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># apply the crop</span></span>
<span id="cb156-16"><a href="maps.html#cb156-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(lim_corners[<span class="dv">1</span>, <span class="st">&quot;X&quot;</span>], lim_corners[<span class="dv">2</span>, <span class="st">&quot;X&quot;</span>]), </span>
<span id="cb156-17"><a href="maps.html#cb156-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(lim_corners[<span class="dv">1</span>, <span class="st">&quot;Y&quot;</span>], lim_corners[<span class="dv">2</span>, <span class="st">&quot;Y&quot;</span>]),</span>
<span id="cb156-18"><a href="maps.html#cb156-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">crs =</span> use_crs)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-68-1.png" width="672" />
That last chunk uses ‘crs’ in 3 different ways. The first two are easy to confuse:</p>
<ul>
<li><code>|&gt; st_sfc(crs = )</code> means ‘note that the data just given are in terms of this crs’: it adds an attribute to the multipoint, without changing the values. Without this, <code>sf</code> doesn’t know if we’ve specified the box in degrees, or metres measured from the Equator or something else.</li>
<li><code>|&gt; st_transform(use_crs)</code> says ‘convert from the current crs to <code>use_crs</code>’. It actually changes the data.</li>
<li><code>coord_sf(... crs = use_crs)</code> tells ggplot to plot using the CRS <code>use_crs</code>.</li>
</ul>
<p>These steps are fiddly, but a convenient way to convert a required bounding box with an edge at 5East from longitude (easy to enter in code) to CRS3035 units <code>lim_corners[2, "Y"]</code> is 2.4452488*10<sup>6</sup> (in metres, so about 2,400km from somewhere).</p>
</div>
<div id="mapAirspace" class="section level3 hasAnchor" number="8.3.2">
<h3><span class="header-section-number">8.3.2</span> Airspace<a href="maps.html#mapAirspace" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In section <a href="maps.html#airspaceData">8.2.2</a> we made a quick check of the FIRs with a map. Here we make a tidier map.</p>
<p>When plotting the whole World, the default map projection makes even worse distortions than we saw for Iberia. We would like to use a better representation of the area of countries, but need to handle the problem seen in the exercises in section <a href="maps.html#spatialFeatures">8.1</a>: that <code>ggplot</code> just draws straight lines. In the R&amp;D data, some of the FIRs distant from Europe are described with a minimum of points, such as a straight line from (179, 0) to (179, 90). We solve this problem by adding extra points at an arbitrary 1° interval using <code>st_segmentize()</code>.</p>
<p>This example illustrates a strength of an <code>sf</code> dataframe. It can contain many <code>sfc</code> columns, but one is the designated geometry column. We can then apply a function such as <code>st_segmentize</code> to the whole dataframe and it will pick out the geometry column to work with, where that’s appropriate.</p>
<p>The Lambert (EPSG3035) projection also distorts on the whole-World scale. Instead, we choose an Atlantic-centred Robinson projection, creating it from a standardised text string using <code>sp::CRS</code>.</p>
<p>XKCD suggests this <a href="https://xkcd.com/977/">reveals something of my age</a> and indeed, it’s a familiar projection from school atlases. This CRS is also available as <code>himach::crs_Atlantic</code>, so if you have that package installed you can save some typing for the first line of the next chunk.</p>
<p>And finally we colour code the upper flight level of the FIR - so the darker blue areas are lower FIRs.</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="maps.html#cb157-1" aria-hidden="true" tabindex="-1"></a>crs_robinson <span class="ot">&lt;-</span> sp<span class="sc">::</span><span class="fu">CRS</span>(<span class="st">&quot;+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs +towgs84=0,0,0&quot;</span>)</span>
<span id="cb157-2"><a href="maps.html#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rnaturalearthdata<span class="sc">::</span>countries110 <span class="sc">|&gt;</span> </span>
<span id="cb157-3"><a href="maps.html#cb157-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">st_as_sf</span>()) <span class="sc">+</span></span>
<span id="cb157-4"><a href="maps.html#cb157-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="st">&quot;grey50&quot;</span>) <span class="sc">+</span> </span>
<span id="cb157-5"><a href="maps.html#cb157-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> fir_poly <span class="sc">|&gt;</span> </span>
<span id="cb157-6"><a href="maps.html#cb157-6" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_segmentize</span>(units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">1</span>, degree)), <span class="co"># just for plotting add intermediate points</span></span>
<span id="cb157-7"><a href="maps.html#cb157-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">fill =</span> max_flight_level), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb157-8"><a href="maps.html#cb157-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Upper Flight Level of FIR&quot;</span>) <span class="sc">+</span></span>
<span id="cb157-9"><a href="maps.html#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_robinson) <span class="sc">+</span></span>
<span id="cb157-10"><a href="maps.html#cb157-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-69-1.png" width="672" /></p>
<p>If we want to zoom in to Europe, which is where most of the flight data is, it is tempting to filter on the FIR airspace ID, though this harder than just picking those starting with ‘E’, ‘L’ or ‘B’, eg what about the Canary Islands, or Ukraine? It is probably best to avoid this approach unless you have a very specific list of countries to include.</p>
<p>As in the previous section, instead we set the limits of the plot using the ‘bottom-left, top-right and transform’ method.</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="maps.html#cb158-1" aria-hidden="true" tabindex="-1"></a>use_crs <span class="ot">&lt;-</span> crs_robinson</span>
<span id="cb158-2"><a href="maps.html#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="co">#set limits at long-lat (-20, 25) to (70, 80)</span></span>
<span id="cb158-3"><a href="maps.html#cb158-3" aria-hidden="true" tabindex="-1"></a>lim_corners <span class="ot">&lt;-</span> <span class="fu">st_multipoint</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">20</span>, <span class="dv">25</span>, <span class="dv">70</span>, <span class="dv">80</span>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb158-4"><a href="maps.html#cb158-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb158-5"><a href="maps.html#cb158-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#transform then pull out a matrix of values (with named columns X and Y)</span></span>
<span id="cb158-6"><a href="maps.html#cb158-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(use_crs) <span class="sc">|&gt;</span> </span>
<span id="cb158-7"><a href="maps.html#cb158-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_coordinates</span>()</span>
<span id="cb158-8"><a href="maps.html#cb158-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-9"><a href="maps.html#cb158-9" aria-hidden="true" tabindex="-1"></a><span class="co"># [exercise: can you use last_plot() to save some typing here?]</span></span>
<span id="cb158-10"><a href="maps.html#cb158-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(rnaturalearthdata<span class="sc">::</span>countries50 <span class="sc">|&gt;</span> </span>
<span id="cb158-11"><a href="maps.html#cb158-11" aria-hidden="true" tabindex="-1"></a>         <span class="fu">st_as_sf</span>()) <span class="sc">+</span></span>
<span id="cb158-12"><a href="maps.html#cb158-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="st">&quot;grey50&quot;</span>) <span class="sc">+</span> <span class="co"># background colour for the land</span></span>
<span id="cb158-13"><a href="maps.html#cb158-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> fir_poly <span class="sc">|&gt;</span> </span>
<span id="cb158-14"><a href="maps.html#cb158-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_segmentize</span>(units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">1</span>, degree)), </span>
<span id="cb158-15"><a href="maps.html#cb158-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aes</span>(<span class="at">fill =</span> max_flight_level), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb158-16"><a href="maps.html#cb158-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Upper</span><span class="sc">\n</span><span class="st">Flight Level</span><span class="sc">\n</span><span class="st">of FIR&quot;</span>) <span class="sc">+</span></span>
<span id="cb158-17"><a href="maps.html#cb158-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> use_crs, </span>
<span id="cb158-18"><a href="maps.html#cb158-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(lim_corners[<span class="dv">1</span>, <span class="st">&quot;X&quot;</span>], lim_corners[<span class="dv">2</span>, <span class="st">&quot;X&quot;</span>]), </span>
<span id="cb158-19"><a href="maps.html#cb158-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(lim_corners[<span class="dv">1</span>, <span class="st">&quot;Y&quot;</span>], lim_corners[<span class="dv">2</span>, <span class="st">&quot;Y&quot;</span>])) <span class="sc">+</span></span>
<span id="cb158-20"><a href="maps.html#cb158-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-70-1.png" width="672" />
As a plot of a 3D-layered structure this still misses something, but it’s not bad to get an idea of the airspace structure and where there are layers.</p>
<p>What about labels? For this we just need to define the label text, which we do by extracting just the 4-letter FIR codes, excluding the “FIR” and “UIR”. Chapter <a href="splitparse.html#splitparse">9</a> has much more on patterns such as <code>"FIR|UIR"</code>. The <code>geom_sf_text</code> will be put at the centroid of the polygon by default. We’ll see how to deconflict labels on maps in section <a href="maps.html#mapOverlapLabels">8.4.1</a>.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="maps.html#cb159-1" aria-hidden="true" tabindex="-1"></a>fir_poly <span class="ot">&lt;-</span> fir_poly <span class="sc">|&gt;</span> </span>
<span id="cb159-2"><a href="maps.html#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">airspace =</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(airspace_id, <span class="st">&quot;(UIR|FIR)&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb159-3"><a href="maps.html#cb159-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(airspace) <span class="sc">|&gt;</span> </span>
<span id="cb159-4"><a href="maps.html#cb159-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">if_else</span>(max_flight_level <span class="sc">==</span> <span class="fu">max</span>(max_flight_level),</span>
<span id="cb159-5"><a href="maps.html#cb159-5" aria-hidden="true" tabindex="-1"></a>                         airspace, <span class="st">&quot;&quot;</span>))</span>
<span id="cb159-6"><a href="maps.html#cb159-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-7"><a href="maps.html#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fir_poly <span class="sc">|&gt;</span> </span>
<span id="cb159-8"><a href="maps.html#cb159-8" aria-hidden="true" tabindex="-1"></a>         <span class="fu">st_segmentize</span>(units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">1</span>, degree))) <span class="sc">+</span></span>
<span id="cb159-9"><a href="maps.html#cb159-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rnaturalearthdata<span class="sc">::</span>countries50 <span class="sc">|&gt;</span> </span>
<span id="cb159-10"><a href="maps.html#cb159-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_as_sf</span>(),</span>
<span id="cb159-11"><a href="maps.html#cb159-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">&quot;grey50&quot;</span>) <span class="sc">+</span> <span class="co"># background colour for the land</span></span>
<span id="cb159-12"><a href="maps.html#cb159-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb159-13"><a href="maps.html#cb159-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> label), <span class="at">size =</span> <span class="fl">1.8</span>) <span class="sc">+</span></span>
<span id="cb159-14"><a href="maps.html#cb159-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> use_crs, </span>
<span id="cb159-15"><a href="maps.html#cb159-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(lim_corners[<span class="dv">1</span>, <span class="st">&quot;X&quot;</span>], lim_corners[<span class="dv">2</span>, <span class="st">&quot;X&quot;</span>]), </span>
<span id="cb159-16"><a href="maps.html#cb159-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(lim_corners[<span class="dv">1</span>, <span class="st">&quot;Y&quot;</span>], lim_corners[<span class="dv">2</span>, <span class="st">&quot;Y&quot;</span>])) <span class="sc">+</span></span>
<span id="cb159-17"><a href="maps.html#cb159-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-71-1.png" width="672" /></p>
</div>
<div id="exercises-6" class="section level3 hasAnchor" number="8.3.3">
<h3><span class="header-section-number">8.3.3</span> Exercises<a href="maps.html#exercises-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="questions-10" class="section level4 hasAnchor" number="8.3.3.1">
<h4><span class="header-section-number">8.3.3.1</span> Questions<a href="maps.html#questions-10" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>In the final map, adapt the code so that it will plot a slice at a particular flight level, and use an appropriate title.</li>
<li>One messy part of the FIR map is GCCC, where, after taking away the FIR/UIR we have overlapping labels for GCCC and GCCCN. How could we make them the same (which would look tidier, at the expense of precision)?</li>
<li>In the two versions of the code for the FIR map, why do we swap where <code>fir_poly</code> and <code>countries50</code> are mentioned (<code>ggplot</code> and <code>geom_sf</code>)?</li>
</ol>
</div>
<div id="answers-10" class="section level4 hasAnchor" number="8.3.3.2">
<h4><span class="header-section-number">8.3.3.2</span> Answers<a href="maps.html#answers-10" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>We can filter, and then use the original label. So one solution is as follows.</li>
</ol>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="maps.html#cb160-1" aria-hidden="true" tabindex="-1"></a>at_fl <span class="ot">&lt;-</span> <span class="dv">350</span></span>
<span id="cb160-2"><a href="maps.html#cb160-2" aria-hidden="true" tabindex="-1"></a>fir_slice <span class="ot">&lt;-</span> fir_poly <span class="sc">|&gt;</span> </span>
<span id="cb160-3"><a href="maps.html#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># max of lower = min of upper, so we arbitrarily put the boundary in the lower</span></span>
<span id="cb160-4"><a href="maps.html#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(min_flight_level <span class="sc">&lt;</span> at_fl <span class="sc">&amp;</span> at_fl <span class="sc">&lt;=</span> max_flight_level)</span>
<span id="cb160-5"><a href="maps.html#cb160-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-6"><a href="maps.html#cb160-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fir_slice <span class="sc">|&gt;</span> </span>
<span id="cb160-7"><a href="maps.html#cb160-7" aria-hidden="true" tabindex="-1"></a>         <span class="fu">st_segmentize</span>(units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">1</span>, degree))) <span class="sc">+</span></span>
<span id="cb160-8"><a href="maps.html#cb160-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rnaturalearthdata<span class="sc">::</span>countries50 <span class="sc">|&gt;</span> </span>
<span id="cb160-9"><a href="maps.html#cb160-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">st_as_sf</span>(),</span>
<span id="cb160-10"><a href="maps.html#cb160-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="st">&quot;grey50&quot;</span>) <span class="sc">+</span> <span class="co"># background colour for the land</span></span>
<span id="cb160-11"><a href="maps.html#cb160-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb160-12"><a href="maps.html#cb160-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> airspace_id), <span class="at">size =</span> <span class="fl">1.8</span>) <span class="sc">+</span></span>
<span id="cb160-13"><a href="maps.html#cb160-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb160-14"><a href="maps.html#cb160-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;FIR/UIRs at flight level &quot;</span>, at_fl)) <span class="sc">+</span></span>
<span id="cb160-15"><a href="maps.html#cb160-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> use_crs, </span>
<span id="cb160-16"><a href="maps.html#cb160-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(lim_corners[<span class="dv">1</span>, <span class="st">&quot;X&quot;</span>], lim_corners[<span class="dv">2</span>, <span class="st">&quot;X&quot;</span>]), </span>
<span id="cb160-17"><a href="maps.html#cb160-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(lim_corners[<span class="dv">1</span>, <span class="st">&quot;Y&quot;</span>], lim_corners[<span class="dv">2</span>, <span class="st">&quot;Y&quot;</span>])) <span class="sc">+</span></span>
<span id="cb160-18"><a href="maps.html#cb160-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-72-1.png" width="672" /></p>
<ol start="2" style="list-style-type: decimal">
<li>A pattern which hides an optional “S” or “N” would be “(UIR|FIR)(S|N)?”.</li>
<li>In the first map it didn’t really matter, but the countries are the first layer so they were put first. In the second, we want the <code>fir_poly</code> to be the default data for the additional <code>geom_sf_text</code>, so it has to be the one inside the <code>ggplot</code>. The country data is still plotted first (by the first <code>geom_sf()</code>).</li>
</ol>
</div>
</div>
</div>
<div id="mapAirports" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Airports<a href="maps.html#mapAirports" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this section we look at plotting airports. Much of it is assembling techniques we’ve already seen: plotting points with <code>geom_point</code> in chapter <a href="firstLook.html#firstLook">3</a> and elsewhere; map layers from earlier in this chapter. New ideas will include: preferring to plot densities rather than simple counts; and how to properly de-conflict labels on maps (rather than the bodged answer to question 3!).</p>
<p>As a warm up, let’s plot the busiest airports for one market segment; use <code>unique(flights$segment)</code> to get a list of all market segments that are available in the data. Still scope for something new: we see a quick way to convert two columns (longitude, latitude) into a spatial feature column, another use of <code>st_as_sf()</code>; and we work out the bounding box automatically, using <code>st_bbox()</code> and also <code>st_buffer()</code> so as not to have airports too close to the edge of the map.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="maps.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to avoid repeating ourselves with the background map</span></span>
<span id="cb161-2"><a href="maps.html#cb161-2" aria-hidden="true" tabindex="-1"></a>geom_sf_bg <span class="ot">&lt;-</span> <span class="cf">function</span>( ..., <span class="at">m =</span> rnaturalearthdata<span class="sc">::</span>countries50,</span>
<span id="cb161-3"><a href="maps.html#cb161-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fill =</span> <span class="st">&quot;grey80&quot;</span>, <span class="at">colour =</span> <span class="st">&quot;white&quot;</span>, <span class="at">size =</span> <span class="fl">0.1</span>) {</span>
<span id="cb161-4"><a href="maps.html#cb161-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(..., <span class="at">data =</span> m <span class="sc">|&gt;</span> <span class="fu">st_as_sfc</span>(), </span>
<span id="cb161-5"><a href="maps.html#cb161-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> fill, <span class="at">colour =</span> colour, <span class="at">size =</span> size)</span>
<span id="cb161-6"><a href="maps.html#cb161-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb161-7"><a href="maps.html#cb161-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-8"><a href="maps.html#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="co"># and to get bounding box for an sf, in plot coordinates</span></span>
<span id="cb161-9"><a href="maps.html#cb161-9" aria-hidden="true" tabindex="-1"></a>get_bounds <span class="ot">&lt;-</span> <span class="cf">function</span>(sft, <span class="at">crs =</span> <span class="dv">3035</span>, <span class="at">margin_km =</span> <span class="dv">100</span>){</span>
<span id="cb161-10"><a href="maps.html#cb161-10" aria-hidden="true" tabindex="-1"></a>  sft <span class="sc">|&gt;</span> </span>
<span id="cb161-11"><a href="maps.html#cb161-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">3035</span>) <span class="sc">|&gt;</span> <span class="co"># convert to a crs in metres </span></span>
<span id="cb161-12"><a href="maps.html#cb161-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_buffer</span>(margin_km <span class="sc">*</span> <span class="dv">1000</span>) <span class="sc">|&gt;</span>  <span class="co"># add the buffer</span></span>
<span id="cb161-13"><a href="maps.html#cb161-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(crs) <span class="sc">|&gt;</span> <span class="co">#convert to required crs</span></span>
<span id="cb161-14"><a href="maps.html#cb161-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_bbox</span>() <span class="co"># get the bounding box </span></span>
<span id="cb161-15"><a href="maps.html#cb161-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb161-16"><a href="maps.html#cb161-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-17"><a href="maps.html#cb161-17" aria-hidden="true" tabindex="-1"></a>crs_europe <span class="ot">&lt;-</span> <span class="dv">3035</span> <span class="co">#EPSG3035 is our good CRS for Europe maps</span></span>
<span id="cb161-18"><a href="maps.html#cb161-18" aria-hidden="true" tabindex="-1"></a>busiest_n <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb161-19"><a href="maps.html#cb161-19" aria-hidden="true" tabindex="-1"></a>show_segment <span class="ot">&lt;-</span> <span class="st">&quot;Business Aviation&quot;</span></span>
<span id="cb161-20"><a href="maps.html#cb161-20" aria-hidden="true" tabindex="-1"></a>busy_ap <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span> </span>
<span id="cb161-21"><a href="maps.html#cb161-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(segment <span class="sc">==</span> show_segment) <span class="sc">|&gt;</span> </span>
<span id="cb161-22"><a href="maps.html#cb161-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the data are one row per flight, so we need to count rows</span></span>
<span id="cb161-23"><a href="maps.html#cb161-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># keep just 3 columns and sort largest to smallest</span></span>
<span id="cb161-24"><a href="maps.html#cb161-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(adep, adep_lat, adep_long, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb161-25"><a href="maps.html#cb161-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>busiest_n) <span class="sc">|&gt;</span> </span>
<span id="cb161-26"><a href="maps.html#cb161-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to sf, noting that long and lat are in degrees (EPSG4326)</span></span>
<span id="cb161-27"><a href="maps.html#cb161-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;adep_long&quot;</span>, <span class="st">&quot;adep_lat&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb161-28"><a href="maps.html#cb161-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-29"><a href="maps.html#cb161-29" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(busy_ap)</span>
<span id="cb161-30"><a href="maps.html#cb161-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb161-31"><a href="maps.html#cb161-31" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(busy_ap) <span class="sc">+</span></span>
<span id="cb161-32"><a href="maps.html#cb161-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>() <span class="sc">+</span> <span class="co">#default background map</span></span>
<span id="cb161-33"><a href="maps.html#cb161-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">size =</span> n), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb161-34"><a href="maps.html#cb161-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">size =</span> <span class="st">&quot;Number of</span><span class="sc">\n</span><span class="st">departures&quot;</span>,</span>
<span id="cb161-35"><a href="maps.html#cb161-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(show_segment, <span class="st">&quot; in March 2019.&quot;</span>),</span>
<span id="cb161-36"><a href="maps.html#cb161-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;Top &quot;</span>, busiest_n, <span class="st">&quot; airports are shown.&quot;</span>)) <span class="sc">+</span></span>
<span id="cb161-37"><a href="maps.html#cb161-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_europe,</span>
<span id="cb161-38"><a href="maps.html#cb161-38" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb161-39"><a href="maps.html#cb161-39" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax)) <span class="sc">+</span></span>
<span id="cb161-40"><a href="maps.html#cb161-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-73-1.png" width="672" /></p>
<div id="mapOverlapLabels" class="section level3 hasAnchor" number="8.4.1">
<h3><span class="header-section-number">8.4.1</span> Overlapping labels on maps<a href="maps.html#mapOverlapLabels" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We could label the maps with the airport codes in the same way that we did with the FIRs [try this], but the labels are overlapping. What function did we use in chapter <a href="filter.html#filter">4</a> to solve this problem? [try this, too]</p>
<p>The problem is that <code>ggrepel::geom_text_repel()</code> doesn’t immediately understand the geometry column in our <code>busy_ap</code> data. Happily, a little googling comes to our aid: there is a way to get <code>geom_text_repel</code> still to do the work for us and convert what we do have, a <code>geometry</code>, into the x and y that it needs. All it takes is to use the additional parameter <code>stat = "sf_coordinates"</code>.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="maps.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">last_plot</span>() <span class="sc">+</span> <span class="co"># assumes you didn&#39;t actually do the 2 little exercises in [ ]</span></span>
<span id="cb162-2"><a href="maps.html#cb162-2" aria-hidden="true" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">geometry =</span> geometry, <span class="at">label =</span> adep), </span>
<span id="cb162-3"><a href="maps.html#cb162-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">stat =</span> <span class="st">&quot;sf_coordinates&quot;</span>,</span>
<span id="cb162-4"><a href="maps.html#cb162-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">size =</span> <span class="fl">1.8</span>) </span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-74-1.png" width="672" /></p>
</div>
</div>
<div id="mapRoutes" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Routes<a href="maps.html#mapRoutes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The routes of aircraft are typically shown as either:</p>
<ul>
<li>a great circle joining the departure and destination airports;</li>
<li>or a sequence of short line segments (which should each be segments of great circles) joining points along the actual route flown, where the points come from radar or other surveillance.</li>
</ul>
<p>In this section we will see examples of each of these.</p>
<div id="great-circle-routes" class="section level3 hasAnchor" number="8.5.1">
<h3><span class="header-section-number">8.5.1</span> Great Circle Routes<a href="maps.html#great-circle-routes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We saw in section <a href="maps.html#spatialFeatures">8.1</a> that <code>geom_sf</code> doesn’t give us great circles by default, but joins with a straight line. There are two ways to get around this: use a CRS in which great circles map to straight lines, and our go-to CRS, EPSG3035, for Europe more-or-less has this nice property, as does the Lambert Conformal Conic (such as EPSG9040 for Europe) that is often used for aeronautical maps; alternatively, add intermediate points before plotting.</p>
<p>Which you choose depends on how important the routing is. A great-circle is often already ‘schematic’: just a way to link airports for the viewer of the map, rather than being too fussy about the intermediate points. But if you think the viewer will jump to conclusions about traffic density in the airspace, then best to use something more precise.</p>
<p>In the first example, we pick low-cost routes, which are mostly short- or medium-haul because this keeps the map mostly in Europe and therefore with less distortion (though Cuba in this map looks like it’s been on a diet, not to mention being rotated to a confusing angle). We use the Lambert equal area projection, which we saved as <code>crs_europe</code> and take the simpler approach of plotting straight lines.</p>
<p>We stick to the principle of keeping the data in longitude-latitude, and only transform when plotting into a coordinate reference system (CRS). But there’s still some manipulation of the data to do: for each row (<code>rowwise()</code> is a particular sort of <code>group_by</code> that works row by row) we have four separate columns with the start and end coordinates. From these we create a line, and make it suitable for use in a dataframe (<code>st_sfc</code>) and tell <code>sf</code> that the CRS is long-lat (<code>crs=4326</code>). We’ll see a faster way to do this in section <a href="maps.html#fasterGeo">8.5.2</a>.</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="maps.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">380</span>) <span class="co"># to get a fixed, but random sample</span></span>
<span id="cb163-2"><a href="maps.html#cb163-2" aria-hidden="true" tabindex="-1"></a>lcc_sample <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span> </span>
<span id="cb163-3"><a href="maps.html#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># just short- or medium-haul lowcost</span></span>
<span id="cb163-4"><a href="maps.html#cb163-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(segment <span class="sc">==</span> <span class="st">&quot;Lowcost&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb163-5"><a href="maps.html#cb163-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> <span class="co">#just pick a few for this example</span></span>
<span id="cb163-6"><a href="maps.html#cb163-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> <span class="co"># we want to have one line per row of data</span></span>
<span id="cb163-7"><a href="maps.html#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gc =</span> <span class="fu">st_linestring</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(adep_long, ades_long, adep_lat, ades_lat), </span>
<span id="cb163-8"><a href="maps.html#cb163-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ncol =</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb163-9"><a href="maps.html#cb163-9" aria-hidden="true" tabindex="-1"></a>           <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb163-10"><a href="maps.html#cb163-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb163-11"><a href="maps.html#cb163-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_geometry</span>(<span class="st">&quot;gc&quot;</span>) </span>
<span id="cb163-12"><a href="maps.html#cb163-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-13"><a href="maps.html#cb163-13" aria-hidden="true" tabindex="-1"></a><span class="co">#bounds doesn&#39;t mind if the sf geometry is points, lines, ... </span></span>
<span id="cb163-14"><a href="maps.html#cb163-14" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(lcc_sample) </span>
<span id="cb163-15"><a href="maps.html#cb163-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(lcc_sample) <span class="sc">+</span></span>
<span id="cb163-16"><a href="maps.html#cb163-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>() <span class="sc">+</span></span>
<span id="cb163-17"><a href="maps.html#cb163-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>)  <span class="sc">+</span></span>
<span id="cb163-18"><a href="maps.html#cb163-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Sample of Low Cost routes&quot;</span>) <span class="sc">+</span></span>
<span id="cb163-19"><a href="maps.html#cb163-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_europe,</span>
<span id="cb163-20"><a href="maps.html#cb163-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb163-21"><a href="maps.html#cb163-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax)) <span class="sc">+</span></span>
<span id="cb163-22"><a href="maps.html#cb163-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-75-1.png" width="672" />
In the second example, we use a sample of longer-haul routes and the Robinson CRS. Construction of the data is the same, apart from the <code>filter</code>. But we need to specify a non-default crs in our <code>bounds</code> function. The work of adding extra points to each line is done with the <code>st_segmentize</code>, which conveniently we can apply to the whole data frame (as mentioned, it picks out the geometry column automatically for segmentation). You can adapt the step of the segments in degrees or km, appropriate to your target map. More looks nicer, but it takes up space, and takes time to plot.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="maps.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">777</span>) <span class="co"># to get a fixed, but random sample</span></span>
<span id="cb164-2"><a href="maps.html#cb164-2" aria-hidden="true" tabindex="-1"></a>long_sample <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span> </span>
<span id="cb164-3"><a href="maps.html#cb164-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dist_act_km <span class="sc">&gt;</span> <span class="dv">4000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb164-4"><a href="maps.html#cb164-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span> <span class="co">#just pick a few for this example</span></span>
<span id="cb164-5"><a href="maps.html#cb164-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> <span class="co"># we want to have one line per row of data</span></span>
<span id="cb164-6"><a href="maps.html#cb164-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gc =</span> <span class="fu">st_linestring</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(adep_long, ades_long, adep_lat, ades_lat),</span>
<span id="cb164-7"><a href="maps.html#cb164-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">ncol =</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb164-8"><a href="maps.html#cb164-8" aria-hidden="true" tabindex="-1"></a>           <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>)) <span class="sc">|&gt;</span> <span class="co"># these are longitude-latitude pairs</span></span>
<span id="cb164-9"><a href="maps.html#cb164-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb164-10"><a href="maps.html#cb164-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_geometry</span>(<span class="st">&quot;gc&quot;</span>) </span>
<span id="cb164-11"><a href="maps.html#cb164-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-12"><a href="maps.html#cb164-12" aria-hidden="true" tabindex="-1"></a><span class="co">#bounds doesn&#39;t mind if the sf geometry is points, lines, ... </span></span>
<span id="cb164-13"><a href="maps.html#cb164-13" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(long_sample, </span>
<span id="cb164-14"><a href="maps.html#cb164-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">crs =</span> crs_robinson) </span>
<span id="cb164-15"><a href="maps.html#cb164-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(long_sample <span class="sc">|&gt;</span> </span>
<span id="cb164-16"><a href="maps.html#cb164-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_segmentize</span>(units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">1</span>, degree)) ) <span class="sc">+</span> <span class="co"># add points temporarily, for plotting</span></span>
<span id="cb164-17"><a href="maps.html#cb164-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>() <span class="sc">+</span></span>
<span id="cb164-18"><a href="maps.html#cb164-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>)  <span class="sc">+</span></span>
<span id="cb164-19"><a href="maps.html#cb164-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Sample of long-haul routes&quot;</span>) <span class="sc">+</span></span>
<span id="cb164-20"><a href="maps.html#cb164-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_robinson,</span>
<span id="cb164-21"><a href="maps.html#cb164-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb164-22"><a href="maps.html#cb164-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax)) <span class="sc">+</span></span>
<span id="cb164-23"><a href="maps.html#cb164-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-76-1.png" width="672" /></p>
</div>
<div id="fasterGeo" class="section level3 hasAnchor" number="8.5.2">
<h3><span class="header-section-number">8.5.2</span> Need for Speed<a href="maps.html#fasterGeo" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>[This is an advanced section that uses quickly some packages that have not been introduced. But the gains in speed are considerable.]</p>
<p>We’ve been using small samples of data so far. Any larger and there will be a noticeable delay in converting from long-lat to spatial features, unless you’re very lucky in your hardware. In this section we discuss two ways to speed things up: an easy one, and a fiddly one.</p>
<p>The easy speed-up is to avoid geo-coding the same route twice: the same airport pair is likely to occur several times in a large dataset: there are 767 occurrences of Madrid-Barcelona (LEMD-LEBL) for example. If we’re only looking at great circle, then all of these routes are the same. Even with filtering and grouping for the statistics you’re calculating (by aircraft type, by market segment etc), there’s still going to be duplication, unless you really need the precise time (which is unlikely since it’s tricky to show on a map). So best to <code>group_by</code> the variables you need to keep (including <code>adep_long, ades_long, adep_lat, ades_lat</code>) and summarise (see section <a href="groups.html#summarise">7.1</a>), taking a flight count [what code would that use?]. Only then convert to <code>sf</code> with <code>st_linestring</code> and friends, as in the previous section.</p>
<p>The fiddly method is less obvious because it depends on developing a feel for what works quickly and what less quickly in R.</p>
<p>To my mind, using <code>rowwise</code> feels like I’ve failed. I might not have written <code>for...next</code>, but in effect, I’ve fallen back onto a for-next loop over each row in turn. I’m left believing I’ve missed a neat <code>tidyverse</code> solution, even if I’m being unfair and there might not be a neater alternative. The <code>rowwise</code> we used earlier is an example where there <em>is</em> a more efficient way to code. This isn’t just linguistic prejudice against <code>for...next</code>. Calling a function, here <code>st_linestring</code>, takes time, so calling it for each of 800,000 rows one-by-one in the flight data is going to be time-consuming.</p>
<p>There is an interesting discussion of the conversion to <a href="https://www.findingyourway.io/blog/2018/02/28/2018-02-28_great-circles-with-sf-and-leaflet/">great circles here</a>. The solution is based on the <code>purrr</code> package that we saw in chapter <a href="loopsfunctions.html#loopsfunctions">6</a>. Instead of grouping (each row separately), it creates a list of lists - one list per row and that list contains the 4 longitude-latitude numbers. We saw <code>map</code> in chapter <a href="loopsfunctions.html#loopsfunctions">6</a> as an efficient way to operate on each element of a list.</p>
<p>In this code chunk, we set up two parallel ways of coding the same thing. The <code>identical</code> test shows that the two results are the same. The <code>microbenchmark</code> shows, over 10 iterations of each, that the <code>purrr</code> approach is almost 15 times faster.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="maps.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb165-2"><a href="maps.html#cb165-2" aria-hidden="true" tabindex="-1"></a>flts <span class="ot">&lt;-</span> <span class="fu">set.seed</span>(<span class="dv">777</span>) <span class="co"># to get a fixed, but random sample</span></span>
<span id="cb165-3"><a href="maps.html#cb165-3" aria-hidden="true" tabindex="-1"></a>long_sample <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span> </span>
<span id="cb165-4"><a href="maps.html#cb165-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dist_act_km <span class="sc">&gt;</span> <span class="dv">4000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb165-5"><a href="maps.html#cb165-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100</span>) </span>
<span id="cb165-6"><a href="maps.html#cb165-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-7"><a href="maps.html#cb165-7" aria-hidden="true" tabindex="-1"></a><span class="co"># adapted from Charlie Hadley https://www.findingyourway.io/blog/2018/02/28/2018-02-28_great-circles-with-sf-and-leaflet/</span></span>
<span id="cb165-8"><a href="maps.html#cb165-8" aria-hidden="true" tabindex="-1"></a><span class="co"># since his example was written, the {{ }} syntax has become available for referring to dataframe columns</span></span>
<span id="cb165-9"><a href="maps.html#cb165-9" aria-hidden="true" tabindex="-1"></a><span class="co"># so we see {{ }} here in place of his `enquo()`</span></span>
<span id="cb165-10"><a href="maps.html#cb165-10" aria-hidden="true" tabindex="-1"></a><span class="co"># this assumes df is not already an `sf` object, just a dataframe or tbl.</span></span>
<span id="cb165-11"><a href="maps.html#cb165-11" aria-hidden="true" tabindex="-1"></a>longlat_to_sf <span class="ot">&lt;-</span> <span class="cf">function</span>(df,</span>
<span id="cb165-12"><a href="maps.html#cb165-12" aria-hidden="true" tabindex="-1"></a>                           <span class="at">start_long =</span> adep_long,</span>
<span id="cb165-13"><a href="maps.html#cb165-13" aria-hidden="true" tabindex="-1"></a>                           <span class="at">start_lat =</span> adep_lat,</span>
<span id="cb165-14"><a href="maps.html#cb165-14" aria-hidden="true" tabindex="-1"></a>                           <span class="at">end_long =</span> ades_long,</span>
<span id="cb165-15"><a href="maps.html#cb165-15" aria-hidden="true" tabindex="-1"></a>                           <span class="at">end_lat =</span> ades_lat) {</span>
<span id="cb165-16"><a href="maps.html#cb165-16" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb165-17"><a href="maps.html#cb165-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># {{ start_long }} selects the column referred to by the value of start_long (without quotes)</span></span>
<span id="cb165-18"><a href="maps.html#cb165-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb165-19"><a href="maps.html#cb165-19" aria-hidden="true" tabindex="-1"></a>      {{ start_long }},</span>
<span id="cb165-20"><a href="maps.html#cb165-20" aria-hidden="true" tabindex="-1"></a>      {{ end_long }},</span>
<span id="cb165-21"><a href="maps.html#cb165-21" aria-hidden="true" tabindex="-1"></a>      {{ start_lat }},</span>
<span id="cb165-22"><a href="maps.html#cb165-22" aria-hidden="true" tabindex="-1"></a>      {{ end_lat }}</span>
<span id="cb165-23"><a href="maps.html#cb165-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb165-24"><a href="maps.html#cb165-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make a list of lists, each of 4 numbers</span></span>
<span id="cb165-25"><a href="maps.html#cb165-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transpose</span>() <span class="sc">%&gt;%</span></span>
<span id="cb165-26"><a href="maps.html#cb165-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># turn each list into a matrix</span></span>
<span id="cb165-27"><a href="maps.html#cb165-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">matrix</span>(<span class="fu">flatten_dbl</span>(.), <span class="at">nrow =</span> <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb165-28"><a href="maps.html#cb165-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># feed that into st_linestring</span></span>
<span id="cb165-29"><a href="maps.html#cb165-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(st_linestring) <span class="sc">%&gt;%</span></span>
<span id="cb165-30"><a href="maps.html#cb165-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb165-31"><a href="maps.html#cb165-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_sf</span>(<span class="at">geometry =</span> .)  <span class="sc">%&gt;%</span> </span>
<span id="cb165-32"><a href="maps.html#cb165-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">gc =</span> geometry) <span class="sc">%&gt;%</span></span>
<span id="cb165-33"><a href="maps.html#cb165-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(df) <span class="sc">%&gt;%</span></span>
<span id="cb165-34"><a href="maps.html#cb165-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(gc, <span class="at">.after =</span> {{ end_long }})</span>
<span id="cb165-35"><a href="maps.html#cb165-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb165-36"><a href="maps.html#cb165-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-37"><a href="maps.html#cb165-37" aria-hidden="true" tabindex="-1"></a><span class="co"># compare the geography data that results - identical = TRUE</span></span>
<span id="cb165-38"><a href="maps.html#cb165-38" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(</span>
<span id="cb165-39"><a href="maps.html#cb165-39" aria-hidden="true" tabindex="-1"></a>  long_sample <span class="sc">|&gt;</span> </span>
<span id="cb165-40"><a href="maps.html#cb165-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> <span class="co"># we want to have one line per row of data</span></span>
<span id="cb165-41"><a href="maps.html#cb165-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gc =</span> <span class="fu">st_linestring</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(adep_long, ades_long, adep_lat, ades_lat), </span>
<span id="cb165-42"><a href="maps.html#cb165-42" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">ncol =</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb165-43"><a href="maps.html#cb165-43" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb165-44"><a href="maps.html#cb165-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb165-45"><a href="maps.html#cb165-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(gc),</span>
<span id="cb165-46"><a href="maps.html#cb165-46" aria-hidden="true" tabindex="-1"></a>  long_sample <span class="sc">|&gt;</span> </span>
<span id="cb165-47"><a href="maps.html#cb165-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">longlat_to_sf</span>()<span class="sc">|&gt;</span> </span>
<span id="cb165-48"><a href="maps.html#cb165-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(gc)</span>
<span id="cb165-49"><a href="maps.html#cb165-49" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="maps.html#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co"># is it faster?</span></span>
<span id="cb167-2"><a href="maps.html#cb167-2" aria-hidden="true" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb167-3"><a href="maps.html#cb167-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">rowwise =</span> long_sample <span class="sc">|&gt;</span> </span>
<span id="cb167-4"><a href="maps.html#cb167-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> <span class="co"># we want to have one line per row of data</span></span>
<span id="cb167-5"><a href="maps.html#cb167-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gc =</span> <span class="fu">st_linestring</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(adep_long, ades_long, adep_lat, ades_lat), </span>
<span id="cb167-6"><a href="maps.html#cb167-6" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">ncol =</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb167-7"><a href="maps.html#cb167-7" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb167-8"><a href="maps.html#cb167-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>(),</span>
<span id="cb167-9"><a href="maps.html#cb167-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">purrr =</span> long_sample <span class="sc">|&gt;</span> </span>
<span id="cb167-10"><a href="maps.html#cb167-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">longlat_to_sf</span>(),</span>
<span id="cb167-11"><a href="maps.html#cb167-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb167-12"><a href="maps.html#cb167-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Unit: milliseconds
##     expr       min        lq      mean    median        uq      max neval
##  rowwise 192.07500 196.58157 206.63191 206.71600 212.38043 225.2257    10
##    purrr  14.28017  14.30581  16.84124  15.21813  15.77938  32.7615    10</code></pre>
<p>The <code>longlat_to_sf</code> function is hard to follow. But it works. Don’t worry too much how unless you’re really interested. Just adopt the <code>long_sample |&gt; longlat_to_sf()</code> syntax. If your longitudes and latitudes are in columns with different names, say ‘long1’, ‘lat1’, you just use <code>longlat_to_sf(start_long = long1, start_lat = lat1, and so on...)</code></p>
</div>
<div id="trueRoutes" class="section level3 hasAnchor" number="8.5.3">
<h3><span class="header-section-number">8.5.3</span> True Routes<a href="maps.html#trueRoutes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now is the time to dip our toes into the route data from the R&amp;D Data Archive. The files are large, so handle with care, but download <code>Flight_Points_Actual_20190301_20190331.csv.gz</code> into your <code>/data</code> directory, as you did the other files. This one has some 26 million rows, so we’ll create a large sample to play with, flights by the turboprop aircraft <a href="https://en.wikipedia.org/wiki/ATR_72">AT72</a>. In chapter [TBD] we’ll see how to handle these datasets faster using datatables.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="maps.html#cb169-1" aria-hidden="true" tabindex="-1"></a>ac <span class="ot">&lt;-</span> <span class="st">&quot;AT72&quot;</span> <span class="co"># an aircraft type</span></span>
<span id="cb169-2"><a href="maps.html#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="co"># a sizeable sample</span></span>
<span id="cb169-3"><a href="maps.html#cb169-3" aria-hidden="true" tabindex="-1"></a>ac_flts <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span> </span>
<span id="cb169-4"><a href="maps.html#cb169-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ac_type <span class="sc">==</span> ac)</span>
<span id="cb169-5"><a href="maps.html#cb169-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-6"><a href="maps.html#cb169-6" aria-hidden="true" tabindex="-1"></a><span class="co"># get the data</span></span>
<span id="cb169-7"><a href="maps.html#cb169-7" aria-hidden="true" tabindex="-1"></a>routes <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">&quot;data/Flight_Points_Actual_20190301_20190331.csv.gz&quot;</span>, <span class="at">skip =</span> <span class="dv">1</span>,</span>
<span id="cb169-8"><a href="maps.html#cb169-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;seq&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;level&quot;</span>, <span class="st">&quot;lat&quot;</span>, <span class="st">&quot;long&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb169-9"><a href="maps.html#cb169-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.POSIXct</span>(time, <span class="at">format =</span> <span class="st">&quot;%d-%m-%Y %H:%M:%S&quot;</span>, <span class="at">tz =</span> <span class="st">&quot;UTC&quot;</span>))</span>
<span id="cb169-10"><a href="maps.html#cb169-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-11"><a href="maps.html#cb169-11" aria-hidden="true" tabindex="-1"></a>routes <span class="sc">%&lt;&gt;%</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> ac_flts<span class="sc">$</span>id) <span class="co"># reduce to a sample</span></span>
<span id="cb169-12"><a href="maps.html#cb169-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-13"><a href="maps.html#cb169-13" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(routes, <span class="at">file =</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">&quot;data/Flight_Points_Actual_201903_&quot;</span>, ac, <span class="st">&quot;.rda&quot;</span>))</span></code></pre></div>
<p>Let’s explore these data. Firstly by just plotting the points in the data and their flight level, we get a rapid picture of the airports from which these ATR turboprop aircraft operate.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="maps.html#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/Flight_Points_Actual_201903_AT72.rda&quot;</span>) <span class="co"># loads routes dataset</span></span>
<span id="cb170-2"><a href="maps.html#cb170-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-3"><a href="maps.html#cb170-3" aria-hidden="true" tabindex="-1"></a><span class="co"># convert in two steps</span></span>
<span id="cb170-4"><a href="maps.html#cb170-4" aria-hidden="true" tabindex="-1"></a>route_pts <span class="ot">&lt;-</span> routes <span class="sc">|&gt;</span> </span>
<span id="cb170-5"><a href="maps.html#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">|&gt;</span> </span>
<span id="cb170-6"><a href="maps.html#cb170-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>, <span class="st">&quot;lat&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb170-7"><a href="maps.html#cb170-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-8"><a href="maps.html#cb170-8" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(route_pts) </span>
<span id="cb170-9"><a href="maps.html#cb170-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(route_pts) <span class="sc">+</span></span>
<span id="cb170-10"><a href="maps.html#cb170-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>() <span class="sc">+</span></span>
<span id="cb170-11"><a href="maps.html#cb170-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">colour =</span> level), <span class="at">size =</span> <span class="fl">0.1</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb170-12"><a href="maps.html#cb170-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_europe,</span>
<span id="cb170-13"><a href="maps.html#cb170-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb170-14"><a href="maps.html#cb170-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax)) <span class="sc">+</span></span>
<span id="cb170-15"><a href="maps.html#cb170-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb170-16"><a href="maps.html#cb170-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Actual routes flown by AT72&quot;</span>,</span>
<span id="cb170-17"><a href="maps.html#cb170-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">&quot;Flight level&quot;</span>,</span>
<span id="cb170-18"><a href="maps.html#cb170-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">x=</span><span class="st">&quot;&quot;</span>, <span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb170-19"><a href="maps.html#cb170-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_viridis_b</span>(<span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) </span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-79-1.png" width="672" /></p>
<p>This map gives a feel for the frequency at which the actual route is reported. It also shows some slightly odd-looking routing over the Atlantic (where radar coverage can be lacking).</p>
<p>For a more joined-up view, we need to convert the points into lines. The ‘normal’ approach to this is to <code>summarise</code> and then <code>st_cast</code>. But why does this work? Surely after <code>summarise</code> you only have group variables and variables created in the call (<code>time</code> and <code>level</code> in the example below)? Normally this is true. But the <code>geometry</code> column in an <code>sf</code> dataframe is ‘sticky’, and trumps this normal behaviour: summarising an <code>sf</code> silently summarises the geometry column into something sensible. In this case we get a ‘multipoint’ (a set of points) which we can then cast into a ‘linestring’ (a set of points joined into a single line).</p>
<p>So the overall sequence is: <code>st_as_sf</code> to get points, group, summarise, cast. There’s one small twist: <code>summarise</code> normally involves a <code>union</code> operation which (unusually for R) <em>changes the data order</em>. So to keep the points in order we need to tell <code>summarise</code> to skip the union step.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="maps.html#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&quot;data/Flight_Points_Actual_201903_AT72.rda&quot;</span>)</span>
<span id="cb171-2"><a href="maps.html#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="maps.html#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="co"># convert in two steps</span></span>
<span id="cb171-4"><a href="maps.html#cb171-4" aria-hidden="true" tabindex="-1"></a>geo_routes <span class="ot">&lt;-</span> routes <span class="sc">|&gt;</span> </span>
<span id="cb171-5"><a href="maps.html#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">|&gt;</span> </span>
<span id="cb171-6"><a href="maps.html#cb171-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#use a 4D point</span></span>
<span id="cb171-7"><a href="maps.html#cb171-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>, <span class="st">&quot;lat&quot;</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb171-8"><a href="maps.html#cb171-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># then &#39;summarise&#39; into a linestring</span></span>
<span id="cb171-9"><a href="maps.html#cb171-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb171-10"><a href="maps.html#cb171-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">time =</span> <span class="fu">first</span>(time),</span>
<span id="cb171-11"><a href="maps.html#cb171-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">level =</span> <span class="fu">max</span>(level), <span class="at">do_union =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb171-12"><a href="maps.html#cb171-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_cast</span>(<span class="st">&quot;LINESTRING&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb171-13"><a href="maps.html#cb171-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for this scale of map not really necessary, but segmentize anyway</span></span>
<span id="cb171-14"><a href="maps.html#cb171-14" aria-hidden="true" tabindex="-1"></a> <span class="fu">st_segmentize</span>(units<span class="sc">::</span><span class="fu">set_units</span>(<span class="fl">0.5</span>, degree))</span>
<span id="cb171-15"><a href="maps.html#cb171-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-16"><a href="maps.html#cb171-16" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(geo_routes) <span class="co"># use our bounds-finding function</span></span>
<span id="cb171-17"><a href="maps.html#cb171-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(geo_routes) <span class="sc">+</span></span>
<span id="cb171-18"><a href="maps.html#cb171-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>() <span class="sc">+</span> <span class="co"># and our default land background, see earlier</span></span>
<span id="cb171-19"><a href="maps.html#cb171-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">colour =</span> level), <span class="at">size =</span> <span class="fl">0.2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb171-20"><a href="maps.html#cb171-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_europe,</span>
<span id="cb171-21"><a href="maps.html#cb171-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb171-22"><a href="maps.html#cb171-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax)) <span class="sc">+</span></span>
<span id="cb171-23"><a href="maps.html#cb171-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb171-24"><a href="maps.html#cb171-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Actual routes flown by AT72&quot;</span>,</span>
<span id="cb171-25"><a href="maps.html#cb171-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">&quot;Max</span><span class="sc">\n</span><span class="st">flight level&quot;</span>,</span>
<span id="cb171-26"><a href="maps.html#cb171-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">x=</span><span class="st">&quot;&quot;</span>, <span class="at">y=</span><span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb171-27"><a href="maps.html#cb171-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_viridis_b</span>(<span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) </span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-80-1.png" width="672" /></p>
</div>
<div id="exercises-7" class="section level3 hasAnchor" number="8.5.4">
<h3><span class="header-section-number">8.5.4</span> Exercises<a href="maps.html#exercises-7" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="questions-11" class="section level4 hasAnchor" number="8.5.4.1">
<h4><span class="header-section-number">8.5.4.1</span> Questions<a href="maps.html#questions-11" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>Experiment with different colours, line thickness and transparency in the low-cost map.</li>
<li>In the low-cost map, take a larger sample of flights up to 1500km, and count the flights per airport pair. Colour the lines by traffic. Once ready, drop the sample completely, to give full counts for the month. Beware, some longitude or latitude might be missing, and such airport pairs need to be dropped.</li>
<li>Add labels for the top N (eg 20) airports in this extended low-cost map.</li>
<li>In the long-haul route map, why do some of the routes leave the map?</li>
<li>What’s the solution to this?</li>
<li>When reducing routes to those for AT72 aircraft (start of section <a href="maps.html#trueRoutes">8.5.3</a>), we used a <code>filter</code>. With a big dataset, finding efficient code can save a lot of time. Is <code>filter</code> quicker or slower than using an <code>inner_join</code>?</li>
</ol>
</div>
<div id="answers-11" class="section level4 hasAnchor" number="8.5.4.2">
<h4><span class="header-section-number">8.5.4.2</span> Answers<a href="maps.html#answers-11" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>Using <code>colour</code>, <code>size</code> and <code>alpha</code> parameters.</li>
<li>Something like this. We needed to drop airports with missing long-lat, using <code>drop_na</code>. It took a little work on the colouring, and line sizes to get something presentable. That includes sorting so that the busier routes get plotted last.</li>
</ol>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="maps.html#cb172-1" aria-hidden="true" tabindex="-1"></a>lcc_counts <span class="ot">&lt;-</span> flights <span class="sc">|&gt;</span> </span>
<span id="cb172-2"><a href="maps.html#cb172-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># just short- or medium-haul lowcost</span></span>
<span id="cb172-3"><a href="maps.html#cb172-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(segment <span class="sc">==</span> <span class="st">&quot;Lowcost&quot;</span> <span class="sc">&amp;</span> dist_act_km <span class="sc">&lt;=</span> <span class="dv">1500</span>) <span class="sc">|&gt;</span> </span>
<span id="cb172-4"><a href="maps.html#cb172-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">|&gt;</span> <span class="co"># can&#39;t plot if we don&#39;t know the lat long of an AP </span></span>
<span id="cb172-5"><a href="maps.html#cb172-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># slice_sample(n = 1000) |&gt; #just pick a few while debugging</span></span>
<span id="cb172-6"><a href="maps.html#cb172-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># count is a short-hand for group/summarise/ungroup</span></span>
<span id="cb172-7"><a href="maps.html#cb172-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(adep, ades, adep_long, ades_long, adep_lat, ades_lat,</span>
<span id="cb172-8"><a href="maps.html#cb172-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;flts&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb172-9"><a href="maps.html#cb172-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> <span class="co"># we want to have one line per row of data</span></span>
<span id="cb172-10"><a href="maps.html#cb172-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">gc =</span> <span class="fu">st_linestring</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(adep_long, ades_long, adep_lat, ades_lat), <span class="at">ncol =</span> <span class="dv">2</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb172-11"><a href="maps.html#cb172-11" aria-hidden="true" tabindex="-1"></a>           <span class="fu">st_sfc</span>(<span class="at">crs =</span> <span class="dv">4326</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb172-12"><a href="maps.html#cb172-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb172-13"><a href="maps.html#cb172-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(flts) <span class="sc">|&gt;</span> </span>
<span id="cb172-14"><a href="maps.html#cb172-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_geometry</span>(<span class="st">&quot;gc&quot;</span>) </span>
<span id="cb172-15"><a href="maps.html#cb172-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-16"><a href="maps.html#cb172-16" aria-hidden="true" tabindex="-1"></a><span class="co">#bounds doesn&#39;t mind if the sf geometry is points, lines, ... </span></span>
<span id="cb172-17"><a href="maps.html#cb172-17" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(lcc_counts) </span>
<span id="cb172-18"><a href="maps.html#cb172-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(lcc_counts) <span class="sc">+</span></span>
<span id="cb172-19"><a href="maps.html#cb172-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>() <span class="sc">+</span></span>
<span id="cb172-20"><a href="maps.html#cb172-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">colour =</span> flts), <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size =</span> <span class="fl">0.2</span>)  <span class="sc">+</span></span>
<span id="cb172-21"><a href="maps.html#cb172-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Low-cost routes&quot;</span>, </span>
<span id="cb172-22"><a href="maps.html#cb172-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">colour =</span> <span class="st">&quot;Flights</span><span class="sc">\n</span><span class="st">in the month&quot;</span>) <span class="sc">+</span></span>
<span id="cb172-23"><a href="maps.html#cb172-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_europe,</span>
<span id="cb172-24"><a href="maps.html#cb172-24" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb172-25"><a href="maps.html#cb172-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax)) <span class="sc">+</span></span>
<span id="cb172-26"><a href="maps.html#cb172-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb172-27"><a href="maps.html#cb172-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_viridis_b</span>(<span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-81-1.png" width="672" /></p>
<ol start="3" style="list-style-type: decimal">
<li>See the extended exercises in chapter <a href="sortbars.html#sortbars">5</a> for an example of selecting top <code>n</code> and plotting deconflicted labels. <a href="maps.html#mapOverlapLabels">8.4.1</a> will also be helpful.</li>
<li>We’re applying <code>bounds</code> to the data before segmenting. It seems to be a limitation of the <code>st_bbox</code> and <code>s2_bounds_rect</code> that they give the bounds of the vertices of lines (ie the points), not the line itself.</li>
<li>An easy answer, though it increases the size of the dataset, is to move the <code>segmentize</code> to the end of the data preparation pipe. [Check that this works.]</li>
<li>You need something like this. Be patient with it. Looks like <code>join</code> takes 50%-100% longer, so we made the right choice.</li>
</ol>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="maps.html#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the data again </span></span>
<span id="cb173-2"><a href="maps.html#cb173-2" aria-hidden="true" tabindex="-1"></a>routes <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">&quot;data/Flight_Points_Actual_20190301_20190331.csv.gz&quot;</span>, <span class="at">skip =</span> <span class="dv">1</span>,</span>
<span id="cb173-3"><a href="maps.html#cb173-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;seq&quot;</span>, <span class="st">&quot;time&quot;</span>, <span class="st">&quot;level&quot;</span>, <span class="st">&quot;lat&quot;</span>, <span class="st">&quot;long&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb173-4"><a href="maps.html#cb173-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.POSIXct</span>(time, <span class="at">format =</span> <span class="st">&quot;%d-%m-%Y %H:%M:%S&quot;</span>, <span class="at">tz =</span> <span class="st">&quot;UTC&quot;</span>))</span>
<span id="cb173-5"><a href="maps.html#cb173-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-6"><a href="maps.html#cb173-6" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb173-7"><a href="maps.html#cb173-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_in =</span> routes  <span class="sc">|&gt;</span>  </span>
<span id="cb173-8"><a href="maps.html#cb173-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">%in%</span> ac_flts<span class="sc">$</span>id),</span>
<span id="cb173-9"><a href="maps.html#cb173-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_join =</span> routes  <span class="sc">|&gt;</span>  </span>
<span id="cb173-10"><a href="maps.html#cb173-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(ac_flts <span class="sc">|&gt;</span> <span class="fu">select</span>(id), <span class="at">by =</span> <span class="st">&quot;id&quot;</span>),</span>
<span id="cb173-11"><a href="maps.html#cb173-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb173-12"><a href="maps.html#cb173-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Unit: milliseconds
##      expr       min       lq     mean   median       uq      max neval
##    use_in  876.8077 1123.339 1276.917 1229.038 1292.688 2099.978    10
##  use_join 1520.2464 1645.952 1847.839 1813.585 1959.492 2503.747    10</code></pre>
</div>
</div>
</div>
<div id="mapDensity" class="section level2 hasAnchor" number="8.6">
<h2><span class="header-section-number">8.6</span> Density of routes<a href="maps.html#mapDensity" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>A rough indication of traffic density can be obtained by plotting the routes with a low transparency (<code>alpha</code>) and seeing where they overlap. This can be visually helpful, but doesn’t give any specific, usable values for density. The colouring on the previous map can easily be confusing, if someone tries to read it as a density of traffic.</p>
<p>We need something more precise. Even then, there are layers of precision. We start by working with the great circle routes. These can be said to combine to give the ‘density of potential demand’ in some sense, since they represent the shortest distance. In reality, winds aloft mean that the great circle isn’t the most cost-efficient route, but it’s still a good approximation.</p>
<p>We could use the <code>geom_hex</code> layer in <code>ggplot</code>, but doing this means breaking our rule of transforming only for plotting. It is also less flexible if we want to start measuring distance flown.</p>
<p>Instead, laying the groundwork for later graphs, and to get a more precise density calculation we need to calculate explicitly which routes intersect which hexes. So we need some hexes.</p>
<p>We could create these using the <code>sp</code> package, which allows us to sample an area hexagonally (<code>sp::spsample(n=n_hex, type = "hexagonal")</code> and then convert those hexagon centres into hexagons <code>sp::HexPoints2SpatialPolygons()</code>).</p>
<p>However, there’s a package <code>dggridR</code> designed exactly for establishing hexagonal grids on the globe. It’s reasonable to assume that a specialist package has considered more of the possible pitfalls of doing it ourselves, and it allows us to do the work in fewer lines of code. The steps are:</p>
<ol style="list-style-type: decimal">
<li>Count the great circles as before, though we don’t need to split the great circles into segements: <code>sf</code> knows well how to find the intersection of a great circle and an polygon.</li>
<li>Use <code>dggridR</code> to generate hexagons of about the right size in the long-lat region we need.</li>
<li>These hexagons come with sequence ID numbers, but we need row IDs instead, because that will match with the values returned later by <code>st_intersects</code>.</li>
<li>Find the hexagons that are intersected. Then count the number of intersections per hexagon.</li>
<li>Join these counts back onto the hexes, and plot.</li>
</ol>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="maps.html#cb175-1" aria-hidden="true" tabindex="-1"></a>sample_km <span class="ot">&lt;-</span> <span class="dv">60</span> <span class="co"># approximate hex size</span></span>
<span id="cb175-2"><a href="maps.html#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">777</span>) <span class="co"># to get a fixed, but random sample</span></span>
<span id="cb175-3"><a href="maps.html#cb175-3" aria-hidden="true" tabindex="-1"></a>counted_gc <span class="ot">&lt;-</span> flights  <span class="sc">|&gt;</span>  </span>
<span id="cb175-4"><a href="maps.html#cb175-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dist_act_km <span class="sc">&lt;=</span> <span class="dv">1500</span>) <span class="sc">|&gt;</span> <span class="co"># let&#39;s sample short-haul flights</span></span>
<span id="cb175-5"><a href="maps.html#cb175-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">|&gt;</span> </span>
<span id="cb175-6"><a href="maps.html#cb175-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">100000</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb175-7"><a href="maps.html#cb175-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># count instances of the same great circle from departure to destination</span></span>
<span id="cb175-8"><a href="maps.html#cb175-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(adep, ades, adep_long, ades_long, adep_lat, ades_lat,</span>
<span id="cb175-9"><a href="maps.html#cb175-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">&quot;flts&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb175-10"><a href="maps.html#cb175-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">longlat_to_sf</span>() <span class="co">#using our faster conversion function</span></span>
<span id="cb175-11"><a href="maps.html#cb175-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># note, no need to chop up the great circles</span></span>
<span id="cb175-12"><a href="maps.html#cb175-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb175-13"><a href="maps.html#cb175-13" aria-hidden="true" tabindex="-1"></a>ll_bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(counted_gc, <span class="at">crs =</span> <span class="dv">4326</span>) <span class="co">#in long lat</span></span>
<span id="cb175-14"><a href="maps.html#cb175-14" aria-hidden="true" tabindex="-1"></a><span class="co">#choose a grid</span></span>
<span id="cb175-15"><a href="maps.html#cb175-15" aria-hidden="true" tabindex="-1"></a>hex_grid <span class="ot">&lt;-</span> dggridR<span class="sc">::</span><span class="fu">dgconstruct</span>(<span class="at">spacing=</span>sample_km) <span class="sc">|&gt;</span> </span>
<span id="cb175-16"><a href="maps.html#cb175-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get only those hexes we need</span></span>
<span id="cb175-17"><a href="maps.html#cb175-17" aria-hidden="true" tabindex="-1"></a>  dggridR<span class="sc">::</span><span class="fu">dgrectgrid</span>(<span class="at">minlat =</span> ll_bounds<span class="sc">$</span>ymin, <span class="at">minlon =</span> ll_bounds<span class="sc">$</span>xmin,</span>
<span id="cb175-18"><a href="maps.html#cb175-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">maxlat =</span> ll_bounds<span class="sc">$</span>ymax, <span class="at">maxlon =</span> ll_bounds<span class="sc">$</span>xmax) <span class="sc">|&gt;</span> </span>
<span id="cb175-19"><a href="maps.html#cb175-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># renumber the selected hexes</span></span>
<span id="cb175-20"><a href="maps.html#cb175-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seqnum =</span> <span class="fu">row_number</span>())</span></code></pre></div>
<pre><code>## Resolution: 9, Area (km^2): 2591.40182758771, Spacing (km): 50.276890494384, CLS (km): 57.4411078487275</code></pre>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="maps.html#cb177-1" aria-hidden="true" tabindex="-1"></a>hex_counts <span class="ot">&lt;-</span> counted_gc <span class="sc">|&gt;</span></span>
<span id="cb177-2"><a href="maps.html#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">grid_id =</span> <span class="fu">st_intersects</span>(counted_gc, hex_grid)) <span class="sc">|&gt;</span></span>
<span id="cb177-3"><a href="maps.html#cb177-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> <span class="co"># for hex_counts we don&#39;t need any geography, just grid ID</span></span>
<span id="cb177-4"><a href="maps.html#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(grid_id) <span class="sc">|&gt;</span> </span>
<span id="cb177-5"><a href="maps.html#cb177-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now focus just on grid IDs</span></span>
<span id="cb177-6"><a href="maps.html#cb177-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grid_id) <span class="sc">|&gt;</span> </span>
<span id="cb177-7"><a href="maps.html#cb177-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">flts =</span> <span class="fu">sum</span>(flts))</span>
<span id="cb177-8"><a href="maps.html#cb177-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb177-9"><a href="maps.html#cb177-9" aria-hidden="true" tabindex="-1"></a>hex <span class="ot">&lt;-</span> hex_grid <span class="sc">|&gt;</span>  </span>
<span id="cb177-10"><a href="maps.html#cb177-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># inner join since only want to keep hexes with flights</span></span>
<span id="cb177-11"><a href="maps.html#cb177-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(hex_counts, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;seqnum&quot;</span> <span class="ot">=</span> <span class="st">&quot;grid_id&quot;</span>))</span>
<span id="cb177-12"><a href="maps.html#cb177-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-13"><a href="maps.html#cb177-13" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(counted_gc)</span>
<span id="cb177-14"><a href="maps.html#cb177-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hex) <span class="sc">+</span> </span>
<span id="cb177-15"><a href="maps.html#cb177-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>() <span class="sc">+</span> </span>
<span id="cb177-16"><a href="maps.html#cb177-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> flts), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="cn">NA</span>)  <span class="sc">+</span></span>
<span id="cb177-17"><a href="maps.html#cb177-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_europe,</span>
<span id="cb177-18"><a href="maps.html#cb177-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb177-19"><a href="maps.html#cb177-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax))<span class="sc">+</span></span>
<span id="cb177-20"><a href="maps.html#cb177-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb177-21"><a href="maps.html#cb177-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&quot;Flights</span><span class="sc">\n</span><span class="st">in month&quot;</span>,</span>
<span id="cb177-22"><a href="maps.html#cb177-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">x=</span><span class="st">&quot;&quot;</span>, <span class="at">y=</span><span class="st">&quot;&quot;</span>,</span>
<span id="cb177-23"><a href="maps.html#cb177-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Density is based on great-circle routing.&quot;</span>) <span class="sc">+</span></span>
<span id="cb177-24"><a href="maps.html#cb177-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) </span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-83-1.png" width="672" /></p>
<p>In this code, <code>st_intersects</code> is calculating which hexes are intersected by great circles. But <code>sf</code> doesn’t mind if these are great circles, a line made up of great circle segments, or multiple such lines. That means that switching to calculating density of actual routes from this code is an exercise.</p>
<div id="exercises-8" class="section level3 hasAnchor" number="8.6.1">
<h3><span class="header-section-number">8.6.1</span> Exercises<a href="maps.html#exercises-8" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="questions-12" class="section level4 hasAnchor" number="8.6.1.1">
<h4><span class="header-section-number">8.6.1.1</span> Questions<a href="maps.html#questions-12" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>Plot a density map of the AT72 <em>actual</em> routes, not just great circles. Use the data you created earlier: <code>geo_routes</code>.</li>
<li>AT72 are used in passenger, charter and all-cargo markets. Plot a density plot for actual routes, for each of these segments in separate facets.</li>
</ol>
</div>
<div id="answers-12" class="section level4 hasAnchor" number="8.6.1.2">
<h4><span class="header-section-number">8.6.1.2</span> Answers<a href="maps.html#answers-12" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<ol style="list-style-type: decimal">
<li>Assuming that geo_routes is still in your environment, there are minor changes. Mostly because each row is one flight, so we don’t sum, but instead count the rows. This gives a much clearer picture of where the flights are most common than just plotting each flight, as we did in an earlier exercise.</li>
</ol>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="maps.html#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># assume you still have geo_routes in your environment</span></span>
<span id="cb178-2"><a href="maps.html#cb178-2" aria-hidden="true" tabindex="-1"></a>ll_bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(geo_routes, <span class="at">crs =</span> <span class="dv">4326</span>) <span class="co">#in long lat</span></span>
<span id="cb178-3"><a href="maps.html#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="co">#choose a grid</span></span>
<span id="cb178-4"><a href="maps.html#cb178-4" aria-hidden="true" tabindex="-1"></a>hex_grid <span class="ot">&lt;-</span> dggridR<span class="sc">::</span><span class="fu">dgconstruct</span>(<span class="at">spacing=</span>sample_km) <span class="sc">|&gt;</span> </span>
<span id="cb178-5"><a href="maps.html#cb178-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get only those hexes we need</span></span>
<span id="cb178-6"><a href="maps.html#cb178-6" aria-hidden="true" tabindex="-1"></a>  dggridR<span class="sc">::</span><span class="fu">dgrectgrid</span>(<span class="at">minlat =</span> ll_bounds<span class="sc">$</span>ymin, <span class="at">minlon =</span> ll_bounds<span class="sc">$</span>xmin,</span>
<span id="cb178-7"><a href="maps.html#cb178-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">maxlat =</span> ll_bounds<span class="sc">$</span>ymax, <span class="at">maxlon =</span> ll_bounds<span class="sc">$</span>xmax) <span class="sc">|&gt;</span> </span>
<span id="cb178-8"><a href="maps.html#cb178-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># renumber the selected hexes</span></span>
<span id="cb178-9"><a href="maps.html#cb178-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seqnum =</span> <span class="fu">row_number</span>())</span></code></pre></div>
<pre><code>## Resolution: 9, Area (km^2): 2591.40182758771, Spacing (km): 50.276890494384, CLS (km): 57.4411078487275</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="maps.html#cb180-1" aria-hidden="true" tabindex="-1"></a>hex_counts <span class="ot">&lt;-</span> geo_routes <span class="sc">|&gt;</span></span>
<span id="cb180-2"><a href="maps.html#cb180-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">grid_id =</span> <span class="fu">st_intersects</span>(geo_routes, hex_grid)) <span class="sc">|&gt;</span></span>
<span id="cb180-3"><a href="maps.html#cb180-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> <span class="co"># for hex_counts we don&#39;t need any geography, just grid ID</span></span>
<span id="cb180-4"><a href="maps.html#cb180-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(grid_id) <span class="sc">|&gt;</span> </span>
<span id="cb180-5"><a href="maps.html#cb180-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now focus just on grid IDs</span></span>
<span id="cb180-6"><a href="maps.html#cb180-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grid_id) <span class="sc">|&gt;</span> </span>
<span id="cb180-7"><a href="maps.html#cb180-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">flts =</span> <span class="fu">n</span>())</span>
<span id="cb180-8"><a href="maps.html#cb180-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb180-9"><a href="maps.html#cb180-9" aria-hidden="true" tabindex="-1"></a>hex <span class="ot">&lt;-</span> hex_grid <span class="sc">|&gt;</span>  </span>
<span id="cb180-10"><a href="maps.html#cb180-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># inner join since only want to keep hexes with flights</span></span>
<span id="cb180-11"><a href="maps.html#cb180-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(hex_counts, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;seqnum&quot;</span> <span class="ot">=</span> <span class="st">&quot;grid_id&quot;</span>))</span>
<span id="cb180-12"><a href="maps.html#cb180-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-13"><a href="maps.html#cb180-13" aria-hidden="true" tabindex="-1"></a>bounds <span class="ot">&lt;-</span> <span class="fu">get_bounds</span>(geo_routes)</span>
<span id="cb180-14"><a href="maps.html#cb180-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hex) <span class="sc">+</span> </span>
<span id="cb180-15"><a href="maps.html#cb180-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>() <span class="sc">+</span> </span>
<span id="cb180-16"><a href="maps.html#cb180-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> flts), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="cn">NA</span>)  <span class="sc">+</span></span>
<span id="cb180-17"><a href="maps.html#cb180-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_europe,</span>
<span id="cb180-18"><a href="maps.html#cb180-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb180-19"><a href="maps.html#cb180-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax))<span class="sc">+</span></span>
<span id="cb180-20"><a href="maps.html#cb180-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb180-21"><a href="maps.html#cb180-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;ATR72 routes&quot;</span>,</span>
<span id="cb180-22"><a href="maps.html#cb180-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Flights</span><span class="sc">\n</span><span class="st">in month&quot;</span>,</span>
<span id="cb180-23"><a href="maps.html#cb180-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">x=</span><span class="st">&quot;&quot;</span>, <span class="at">y=</span><span class="st">&quot;&quot;</span>,</span>
<span id="cb180-24"><a href="maps.html#cb180-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Density is based on actual routing.&quot;</span>) <span class="sc">+</span></span>
<span id="cb180-25"><a href="maps.html#cb180-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) </span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-84-1.png" width="672" /></p>
<ol start="2" style="list-style-type: decimal">
<li>This ‘just’ needs some grouping by market segment. We add the market segment column back into geo_routes (<code>id</code> is a unique key per flight). Then redo the counts, grouping also by segment. The map just needs a <code>facet</code>. Faceting is useful, but maps rapidly become quite small, as here. So we darken the land a little, to make the yellow areas more evident.</li>
</ol>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="maps.html#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co">#join the segment back on</span></span>
<span id="cb181-2"><a href="maps.html#cb181-2" aria-hidden="true" tabindex="-1"></a>with_seg <span class="ot">&lt;-</span> geo_routes <span class="sc">|&gt;</span> </span>
<span id="cb181-3"><a href="maps.html#cb181-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we can select just the columns we need on the fly</span></span>
<span id="cb181-4"><a href="maps.html#cb181-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ac_flts <span class="sc">|&gt;</span> <span class="fu">select</span>(id, segment), <span class="at">by =</span> <span class="st">&quot;id&quot;</span>)</span>
<span id="cb181-5"><a href="maps.html#cb181-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-6"><a href="maps.html#cb181-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the hexes will be the same as in Qn1</span></span>
<span id="cb181-7"><a href="maps.html#cb181-7" aria-hidden="true" tabindex="-1"></a>hex_counts <span class="ot">&lt;-</span> with_seg <span class="sc">|&gt;</span></span>
<span id="cb181-8"><a href="maps.html#cb181-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">grid_id =</span> <span class="fu">st_intersects</span>(geo_routes, hex_grid)) <span class="sc">|&gt;</span></span>
<span id="cb181-9"><a href="maps.html#cb181-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span> <span class="co"># for hex_counts we don&#39;t need any geography, just grid ID</span></span>
<span id="cb181-10"><a href="maps.html#cb181-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(grid_id) <span class="sc">|&gt;</span> </span>
<span id="cb181-11"><a href="maps.html#cb181-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now focus just on grid IDs</span></span>
<span id="cb181-12"><a href="maps.html#cb181-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(segment, grid_id) <span class="sc">|&gt;</span> <span class="co"># additional group_by</span></span>
<span id="cb181-13"><a href="maps.html#cb181-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">flts =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span>)</span>
<span id="cb181-14"><a href="maps.html#cb181-14" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb181-15"><a href="maps.html#cb181-15" aria-hidden="true" tabindex="-1"></a>hex <span class="ot">&lt;-</span> hex_grid <span class="sc">|&gt;</span>  </span>
<span id="cb181-16"><a href="maps.html#cb181-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># each hex might now be in more than one row</span></span>
<span id="cb181-17"><a href="maps.html#cb181-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(hex_counts, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;seqnum&quot;</span> <span class="ot">=</span> <span class="st">&quot;grid_id&quot;</span>))</span>
<span id="cb181-18"><a href="maps.html#cb181-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-19"><a href="maps.html#cb181-19" aria-hidden="true" tabindex="-1"></a><span class="co"># bounds haven&#39;t changed</span></span>
<span id="cb181-20"><a href="maps.html#cb181-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hex) <span class="sc">+</span> </span>
<span id="cb181-21"><a href="maps.html#cb181-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_bg</span>(<span class="at">fill =</span> <span class="st">&quot;grey70&quot;</span>) <span class="sc">+</span> <span class="co"># a little darker land for better contrast with yellow</span></span>
<span id="cb181-22"><a href="maps.html#cb181-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> flts), <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">0</span>, <span class="at">colour =</span> <span class="cn">NA</span>)  <span class="sc">+</span></span>
<span id="cb181-23"><a href="maps.html#cb181-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>segment) <span class="sc">+</span></span>
<span id="cb181-24"><a href="maps.html#cb181-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> crs_europe,</span>
<span id="cb181-25"><a href="maps.html#cb181-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">xlim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>xmin, bounds<span class="sc">$</span>xmax),</span>
<span id="cb181-26"><a href="maps.html#cb181-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">ylim =</span> <span class="fu">c</span>(bounds<span class="sc">$</span>ymin, bounds<span class="sc">$</span>ymax))<span class="sc">+</span></span>
<span id="cb181-27"><a href="maps.html#cb181-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb181-28"><a href="maps.html#cb181-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;ATR72 routes&quot;</span>,</span>
<span id="cb181-29"><a href="maps.html#cb181-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Flights</span><span class="sc">\n</span><span class="st">in month&quot;</span>,</span>
<span id="cb181-30"><a href="maps.html#cb181-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">x=</span><span class="st">&quot;&quot;</span>, <span class="at">y=</span><span class="st">&quot;&quot;</span>,</span>
<span id="cb181-31"><a href="maps.html#cb181-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">&quot;Density is based on actual routing.&quot;</span>) <span class="sc">+</span></span>
<span id="cb181-32"><a href="maps.html#cb181-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) </span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-85-1.png" width="768" /></p>
</div>
</div>
</div>
<div id="what-has-gone-wrong" class="section level2 hasAnchor" number="8.7">
<h2><span class="header-section-number">8.7</span> What has gone wrong?<a href="maps.html#what-has-gone-wrong" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>With maps it seems that there are just so many things to get wrong.</p>
<ol style="list-style-type: decimal">
<li>Map issues, especially polygons that seem to have crossings in them; errors like <code>Loop 96 is not valid: Edge 743 crosses edge 998</code> can occur, for example when you use an <code>st_as_sf</code> to translate Eurostat or other data into the <code>sf</code> format. This <em>could</em> be that there is a problem in the map, but it can also be an awkward interaction between the map and a CRS especially at the ‘dateline’ (the ‘far’ edge of the map). There isn’t a single solution to this, but filtering out chunks of the map that you don’t need can work. In other cases, simplifying the map might help (<code>st_simplify</code>), in still others adding points can help(<code>st_segmentize</code>).</li>
<li>Empty maps, or maps with large empty areas. A map of Europe squeezed into the top right corner can mean that you’ve added a ggplot layer that is in long-lat to one that has been projected and is in metres (so that the long-lat get plotted somewhere near 0 long, 0 lat). You might also have a map that is being strict about including French Guiana and other overseas territories. In the first case, see the <code>coord_sf()</code> discussion earlier in this chapter. In the latter case, you’ll need to set bounds for the map (see the later part of section <a href="maps.html#mapCountries">8.3.1</a>).</li>
<li>In World maps, unexpected near-horizontal lines is a sign of cropping and dateline troubles. My usual solution is to use <code>himach::st_window</code>, which is basically a replacement for the <code>st_transform</code> that we’ve seen here that first crops to the final view window. It’s designed for use with the <code>crs_Atlantic</code> and <code>crs_Pacific</code> CRSs that come with the <code>himach</code> package. There are other functions for handling the ‘dateline’, but I haven’t found an easier way to handle all types of geometry (line, polygon etc) so reliably.</li>
</ol>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="maps.html#cb182-1" aria-hidden="true" tabindex="-1"></a>map <span class="ot">&lt;-</span> rnaturalearthdata<span class="sc">::</span>coastline110 <span class="sc">|&gt;</span> </span>
<span id="cb182-2"><a href="maps.html#cb182-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb182-3"><a href="maps.html#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="co"># a Pacific view creates problems along Greenwich meridian</span></span>
<span id="cb182-4"><a href="maps.html#cb182-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(map) <span class="sc">+</span></span>
<span id="cb182-5"><a href="maps.html#cb182-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb182-6"><a href="maps.html#cb182-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;A map with wrapping problems at the &#39;far side&#39;.&quot;</span>) <span class="sc">+</span></span>
<span id="cb182-7"><a href="maps.html#cb182-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">crs =</span> himach<span class="sc">::</span>crs_Pacific)</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-86-1.png" width="672" /></p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="maps.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># st_window </span></span>
<span id="cb183-2"><a href="maps.html#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(map <span class="sc">|&gt;</span> himach<span class="sc">::</span><span class="fu">st_window</span>(himach<span class="sc">::</span>crs_Pacific))<span class="sc">+</span></span>
<span id="cb183-3"><a href="maps.html#cb183-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Wrapping problems solved.&quot;</span>) <span class="sc">+</span></span>
<span id="cb183-4"><a href="maps.html#cb183-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>()</span></code></pre></div>
<p><img src="flights_in_R_files/figure-html/unnamed-chunk-86-2.png" width="672" /></p>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="8">
<li id="fn8"><p>Strictly speaking, when we say ‘great circle’ in this book we really mean ‘segment of a great circle’, or ‘along a great circle’<a href="maps.html#fnref8" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="groups.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="splitparse.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["flights_in_R.pdf", "flights_in_R.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"theme": "sepia"
});
});
</script>

</body>

</html>
